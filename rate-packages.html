<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rate Packages - Keyquest Mortgage Admin</title>
    
    <!-- CSS and Script Connections -->
    <link rel="stylesheet" href="css/admin-styles.css">
    <script src="js/lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config/supabase.js"></script>
    <script src="js/admin-scripts.js"></script>
</head>
<body>
    <div class="overlay" id="overlay" onclick="closeSidebar()"></div>
    
    <div class="admin-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="index.html" class="logo">
                    <div class="logo-icon">
                        <i data-lucide="building-2"></i>
                    </div>
                    <span>KEYQUEST</span>
                </a>
            </div>
            <nav class="nav-menu">
                <a href="index.html" class="nav-item">
                    <i data-lucide="layout-dashboard"></i>
                    <span>Dashboard</span>
                </a>
                <a href="rate-packages.html" class="nav-item active">
                    <i data-lucide="package"></i>
                    <span>Rate Package</span>
                </a>
                <a href="rate-types.html" class="nav-item">
                    <i data-lucide="percent"></i>
                    <span>Rate Type</span>
                </a>
                <a href="banks.html" class="nav-item">
                    <i data-lucide="landmark"></i>
                    <span>Bank</span>
                </a>
                <a href="bankers.html" class="nav-item">
                    <i data-lucide="briefcase"></i>
                    <span>Bankers</span>
                </a>
                <a href="agents.html" class="nav-item">
                    <i data-lucide="users"></i>
                    <span>Agents</span>
                </a>
                <a href="enquiry.html" class="nav-item">
                    <i data-lucide="help-circle"></i>
                    <span>Enquiry</span>
                </a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content" id="mainContent">
            <header class="header">
                <div class="header-left">
                    <button class="menu-toggle" onclick="toggleSidebar()">
                        <i data-lucide="menu"></i>
                    </button>
                    <h1>Rate Packages</h1>
                </div>
                <div class="header-right">
                    <div class="user-menu">
                        <span class="user-name">admin</span>
                        <span class="user-role">Super Admin</span>
                        <button class="btn btn-ghost btn-sm" onclick="confirmSignOut()">
                            <i data-lucide="log-out"></i>
                        </button>
                    </div>
                </div>
            </header>

            <main class="content">
                <!-- Content Header -->
                <div class="content-header">
                    <div class="content-title">
                        <h2>Rate Packages</h2>
                        <p>Manage mortgage rate packages</p>
                    </div>
                    <div class="content-actions">
                        <button class="btn btn-primary" onclick="openAddPackageModal()">
                            <i data-lucide="plus"></i> Add Rate Package
                        </button>
                        <button class="btn btn-outline" onclick="exportPackages()">
                            <i data-lucide="download"></i> Export
                        </button>
                    </div>
                </div>

                <!-- Filters -->
                <div class="filters-card">
                    <div class="filters-row">
                        <div class="filter-group">
                            <input type="text" id="searchInput" placeholder="Search rate packages..." class="form-control search-input">
                        </div>
                        <div class="filter-group">
                            <select id="bankFilter" class="form-control filter-select">
                                <option value="">All Banks</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <select id="propertyFilter" class="form-control filter-select">
                                <option value="">All Property Types</option>
                                <option value="Private Property">Private Property</option>
                                <option value="HDB">HDB</option>
                                <option value="EC">EC</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <select id="statusFilter" class="form-control filter-select">
                                <option value="">All Status</option>
                                <option value="Completed">Completed</option>
                                <option value="Under Construction">Under Construction</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <select id="typeFilter" class="form-control filter-select">
                                <option value="">All Types</option>
                                <option value="Fixed">Fixed</option>
                                <option value="Floating">Floating</option>
                            </select>
                        </div>
                    </div>
                    <div class="filters-actions">
                        <button class="btn btn-primary btn-sm" onclick="applyFilters()">
                            <i data-lucide="filter"></i> Filter
                        </button>
                        <button class="btn btn-ghost btn-sm" onclick="clearFilters()">
                            <i data-lucide="x"></i> Clear
                        </button>
                    </div>
                </div>

                <!-- Table -->
                <div class="table-container">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Bank Name</th>
                                    <th>Property Type</th>
                                    <th>Reference Rate</th>
                                    <th>Property Status</th>
                                    <th>Rate Type</th>
                                    <th>Loan Amount</th>
                                    <th>Loan Type</th>
                                    <th>Lock Period</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="packagesTable">
                                <tr>
                                    <td colspan="10" style="text-align: center; padding: 40px; color: #64748b;">
                                        <div class="loading-spinner">
                                            <i data-lucide="loader-2" class="animate-spin"></i>
                                            Loading rate packages...
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Pagination -->
                <div class="pagination-container">
                    <div class="pagination-info">
                        <span id="paginationInfo">Showing 0 of 0 packages</span>
                    </div>
                    <div class="pagination-controls" id="paginationControls">
                        <!-- Pagination buttons will be generated here -->
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Add/Edit Package Modal -->
    <div class="modal" id="package-modal">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="packageModalTitle">Add Rate Package</h3>
                    <button class="modal-close" onclick="closeModal('package-modal')">
                        <i data-lucide="x"></i>
                    </button>
                </div>
                <div class="modal-body" style="max-height: 80vh; overflow-y: auto;">
                    <form id="packageForm" onsubmit="savePackage(event)">
                        <!-- Basic Information -->
                        <div class="form-section">
                            <h4>Basic Information</h4>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label" for="bank_name">Bank Name *</label>
                                    <select name="bank_name" id="bank_name" class="form-control" required>
                                        <option value="">Select Bank</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="loan_type">Loan Type *</label>
                                    <select name="loan_type" id="loan_type" class="form-control" required>
                                        <option value="">Select loan type</option>
                                        <option value="New Home Loan">New Home Loan</option>
                                        <option value="Refinancing Home Loan">Refinancing Home Loan</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="property_type">Property Type *</label>
                                    <select name="property_type" id="property_type" class="form-control" required>
                                        <option value="">Select property type</option>
                                        <option value="Private Property">Private Property</option>
                                        <option value="HDB">HDB</option>
                                        <option value="EC">EC</option>
                                        <option value="Private Property, EC">Private Property, EC</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="property_status">Property Status *</label>
                                    <select name="property_status" id="property_status" class="form-control" required>
                                        <option value="">Select property status</option>
                                        <option value="Completed">Completed</option>
                                        <option value="Under Construction">Under Construction</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Rate Type Category *</label>
                                    <div class="radio-group">
                                        <label class="radio-label">
                                            <input type="radio" name="rate_type_category" value="Fixed" required>
                                            <span>Fixed</span>
                                        </label>
                                        <label class="radio-label">
                                            <input type="radio" name="rate_type_category" value="Floating" required>
                                            <span>Floating</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="reference_rate">Reference Rate</label>
                                    <input type="text" name="reference_rate" id="reference_rate" class="form-control" placeholder="e.g., 2 Years Fixed Rate">
                                </div>
                            </div>
                        </div>

                        <!-- Interest Rate Information -->
                        <div class="form-section">
                            <h4>Interest Rate Information</h4>
                            <div class="rate-years">
                                <!-- Year 1 -->
                                <div class="rate-year-row">
                                    <label class="form-label">Year 1</label>
                                    <div class="rate-input-group">
                                        <select name="year1_rate_type" class="form-control rate-type-select">
                                            <option value="">Select rate type</option>
                                        </select>
                                        <select name="year1_operator" class="form-control operator-select">
                                            <option value="+">+</option>
                                            <option value="-">-</option>
                                        </select>
                                        <div class="input-group">
                                            <input type="number" name="year1_value" class="form-control" step="0.001" placeholder="0">
                                            <span class="input-suffix">%</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Year 2 -->
                                <div class="rate-year-row">
                                    <label class="form-label">Year 2</label>
                                    <div class="rate-input-group">
                                        <select name="year2_rate_type" class="form-control rate-type-select">
                                            <option value="">Select rate type</option>
                                        </select>
                                        <select name="year2_operator" class="form-control operator-select">
                                            <option value="+">+</option>
                                            <option value="-">-</option>
                                        </select>
                                        <div class="input-group">
                                            <input type="number" name="year2_value" class="form-control" step="0.001" placeholder="0">
                                            <span class="input-suffix">%</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Year 3 -->
                                <div class="rate-year-row">
                                    <label class="form-label">Year 3</label>
                                    <div class="rate-input-group">
                                        <select name="year3_rate_type" class="form-control rate-type-select">
                                            <option value="">Select rate type</option>
                                        </select>
                                        <select name="year3_operator" class="form-control operator-select">
                                            <option value="+">+</option>
                                            <option value="-">-</option>
                                        </select>
                                        <div class="input-group">
                                            <input type="number" name="year3_value" class="form-control" step="0.001" placeholder="0">
                                            <span class="input-suffix">%</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Year 4 -->
                                <div class="rate-year-row">
                                    <label class="form-label">Year 4</label>
                                    <div class="rate-input-group">
                                        <select name="year4_rate_type" class="form-control rate-type-select">
                                            <option value="">Select rate type</option>
                                        </select>
                                        <select name="year4_operator" class="form-control operator-select">
                                            <option value="+">+</option>
                                            <option value="-">-</option>
                                        </select>
                                        <div class="input-group">
                                            <input type="number" name="year4_value" class="form-control" step="0.001" placeholder="0">
                                            <span class="input-suffix">%</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Year 5 -->
                                <div class="rate-year-row">
                                    <label class="form-label">Year 5</label>
                                    <div class="rate-input-group">
                                        <select name="year5_rate_type" class="form-control rate-type-select">
                                            <option value="">Select rate type</option>
                                        </select>
                                        <select name="year5_operator" class="form-control operator-select">
                                            <option value="+">+</option>
                                            <option value="-">-</option>
                                        </select>
                                        <div class="input-group">
                                            <input type="number" name="year5_value" class="form-control" step="0.001" placeholder="0">
                                            <span class="input-suffix">%</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Thereafter -->
                                <div class="rate-year-row">
                                    <label class="form-label">Thereafter</label>
                                    <div class="rate-input-group">
                                        <select name="thereafter_rate_type" class="form-control rate-type-select">
                                            <option value="">Select rate type</option>
                                        </select>
                                        <select name="thereafter_operator" class="form-control operator-select">
                                            <option value="+">+</option>
                                            <option value="-">-</option>
                                        </select>
                                        <div class="input-group">
                                            <input type="number" name="thereafter_value" class="form-control" step="0.001" placeholder="0">
                                            <span class="input-suffix">%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Other Information -->
                        <div class="form-section">
                            <h4>Other Information</h4>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label" for="minimum_loan_size">Minimum Loan Size</label>
                                    <div class="input-group">
                                        <span class="input-prefix">$</span>
                                        <input type="number" name="minimum_loan_size" id="minimum_loan_size" class="form-control" placeholder="50000">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="lock_in_period">Lock In Period</label>
                                    <select name="lock_in_period" id="lock_in_period" class="form-control">
                                        <option value="">Select period</option>
                                        <option value="2 Years">2 Years</option>
                                        <option value="3 Years">3 Years</option>
                                        <option value="4 Years">4 Years</option>
                                        <option value="5 Years">5 Years</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="loan_amount">Loan Amount</label>
                                    <div class="input-group">
                                        <span class="input-prefix">$</span>
                                        <input type="number" name="loan_amount" id="loan_amount" class="form-control" placeholder="1000000">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="lock_period">Lock Period</label>
                                    <input type="text" name="lock_period" id="lock_period" class="form-control" placeholder="2 Year">
                                </div>
                            </div>
                            
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label" for="partial_pay_penalty">Partial Payment Penalty (%)</label>
                                    <div class="input-group">
                                        <input type="number" name="partial_pay_penalty" id="partial_pay_penalty" class="form-control" step="0.01" placeholder="1.5">
                                        <span class="input-suffix">%</span>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="full_redeem_penalty">Full Redeem Penalty (%)</label>
                                    <div class="input-group">
                                        <input type="number" name="full_redeem_penalty" id="full_redeem_penalty" class="form-control" step="0.01" placeholder="1.5">
                                        <span class="input-suffix">%</span>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="cancellation_penalty">Cancellation Penalty (%)</label>
                                    <div class="input-group">
                                        <input type="number" name="cancellation_penalty" id="cancellation_penalty" class="form-control" step="0.01" placeholder="1.5">
                                        <span class="input-suffix">%</span>
                                    </div>
                                </div>
                            </div>

                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Legal Fee Subsidy</label>
                                    <div class="radio-group">
                                        <label class="radio-label">
                                            <input type="radio" name="legal_fee_subsidy" value="true">
                                            <span>Yes</span>
                                        </label>
                                        <label class="radio-label">
                                            <input type="radio" name="legal_fee_subsidy" value="false" checked>
                                            <span>No</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Valuation Subsidy</label>
                                    <div class="radio-group">
                                        <label class="radio-label">
                                            <input type="radio" name="valuation_subsidy" value="true">
                                            <span>Yes</span>
                                        </label>
                                        <label class="radio-label">
                                            <input type="radio" name="valuation_subsidy" value="false" checked>
                                            <span>No</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="remarks">Remarks</label>
                                <textarea name="remarks" id="remarks" class="form-control" rows="3" placeholder="Additional notes..."></textarea>
                            </div>
                        </div>

                        <input type="hidden" name="id" id="package_id">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-ghost" onclick="closeModal('package-modal')">Cancel</button>
                    <button type="submit" form="packageForm" class="btn btn-primary">
                        <span id="saveButtonText">Save</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer" class="notification-container"></div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner">
            <i data-lucide="loader-2" class="animate-spin"></i>
            <span>Loading...</span>
        </div>
    </div>

    <script>
        // ===================================
        // GLOBAL VARIABLES
        // ===================================
        let currentPackages = [];
        let filteredPackages = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        let editingPackageId = null;

        // ===================================
        // INITIALIZATION
        // ===================================
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
        });

        async function initializePage() {
            try {
                // Check if supabaseClient is available
                if (typeof supabaseClient === 'undefined') {
                    throw new Error('Supabase client not loaded. Please check your config/supabase.js file.');
                }

                // Check authentication
                const { data: { user }, error: authError } = await supabaseClient.auth.getUser();
                if (authError || !user) {
                    console.log('Authentication required, redirecting to login...');
                    window.location.href = 'login.html';
                    return;
                }

                // Initialize icons
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                }

                // Load initial data
                await Promise.all([
                    loadBanks(),
                    loadRateTypes(),
                    loadPackages()
                ]);

                // Initialize event listeners
                initializeEventListeners();

            } catch (error) {
                console.error('Error initializing page:', error);
                showNotification('Failed to load page: ' + error.message, 'error');
            }
        }

        function initializeEventListeners() {
            // Search input with debounce
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                let searchTimeout;
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(function() {
                        applyFilters();
                    }, 300);
                });
            }

            // Filter selects
            document.querySelectorAll('.filter-select').forEach(function(select) {
                select.addEventListener('change', applyFilters);
            });
        }

        // ===================================
        // DATA LOADING FUNCTIONS
        // ===================================
        async function loadPackages() {
            try {
                showLoading('Loading packages...');
                
                console.log('Loading packages from database...');
                const { data, error } = await supabaseClient
                    .from('rate_packages')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('Supabase error loading packages:', error);
                    throw error;
                }

                console.log('Loaded packages:', data);
                currentPackages = data || [];
                filteredPackages = [...currentPackages];
                displayPackages();
                updatePagination();

            } catch (error) {
                console.error('Error loading packages:', error);
                showNotification('Failed to load rate packages: ' + error.message, 'error');
                // Show empty state
                currentPackages = [];
                filteredPackages = [];
                displayPackages();
            } finally {
                hideLoading();
            }
        }

        async function loadBanks() {
            try {
                const { data, error } = await supabaseClient
                    .from('banks')
                    .select('name')
                    .order('name');

                if (error) throw error;

                // Populate bank selects
                const bankSelects = document.querySelectorAll('#bankFilter, #bank_name');
                const bankOptions = (data || []).map(function(bank) {
                    return '<option value="' + bank.name + '">' + bank.name + '</option>';
                }).join('');

                bankSelects.forEach(function(select) {
                    const currentValue = select.value;
                    if (select.id === 'bankFilter') {
                        select.innerHTML = '<option value="">All Banks</option>' + bankOptions;
                    } else {
                        select.innerHTML = '<option value="">Select Bank</option>' + bankOptions;
                    }
                    select.value = currentValue; // Restore previous value
                });

            } catch (error) {
                console.error('Error loading banks:', error);
                showNotification('Failed to load banks: ' + error.message, 'error');
            }
        }

        async function loadRateTypes() {
            try {
                const { data, error } = await supabaseClient
                    .from('rate_types')
                    .select('rate_type, rate_value')
                    .order('rate_type');

                if (error) throw error;

                // Populate rate type selects
                const rateTypeSelects = document.querySelectorAll('.rate-type-select');
                const rateTypeOptions = (data || []).map(function(rateType) {
                    return '<option value="' + rateType.rate_type + '">' + rateType.rate_type + '(' + rateType.rate_value + '%)</option>';
                }).join('');

                rateTypeSelects.forEach(function(select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">Select rate type</option>' + rateTypeOptions;
                    select.value = currentValue; // Restore previous value
                });

            } catch (error) {
                console.error('Error loading rate types:', error);
                showNotification('Failed to load rate types: ' + error.message, 'error');
            }
        }

        // ===================================
        // DISPLAY FUNCTIONS
        // ===================================
        function displayPackages() {
            const tbody = document.getElementById('packagesTable');
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pagePackages = filteredPackages.slice(startIndex, endIndex);

            if (pagePackages.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 40px; color: #64748b;">
                            No rate packages found
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = pagePackages.map(function(pkg) {
                return `
                <tr>
                    <td><strong>${escapeHtml(pkg.bank_name || 'N/A')}</strong></td>
                    <td>${escapeHtml(pkg.property_type || 'N/A')}</td>
                    <td>${escapeHtml(pkg.reference_rate || 'N/A')}</td>
                    <td>
                        <span class="status-badge ${getStatusClass(pkg.property_status)}">
                            ${escapeHtml(pkg.property_status || 'N/A')}
                        </span>
                    </td>
                    <td>
                        <span class="status-badge ${pkg.rate_type_category === 'Fixed' ? 'badge-active' : 'badge-pending'}">
                            ${escapeHtml(pkg.rate_type_category || 'N/A')}
                        </span>
                    </td>
                    <td><strong>${formatNumber(pkg.loan_amount || 0)}</strong></td>
                    <td>${escapeHtml(pkg.loan_type || 'N/A')}</td>
                    <td>${escapeHtml(pkg.lock_period || 'N/A')}</td>
                    <td>
                        <span class="status-badge badge-active">
                            Active
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-edit" onclick="editPackage('${pkg.id}')">
                                <i data-lucide="edit"></i>
                            </button>
                            <button class="btn btn-sm btn-delete" onclick="deletePackage('${pkg.id}')">
                                <i data-lucide="trash-2"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                `;
            }).join('');

            // Re-initialize icons
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }

            // Update pagination info
            const total = filteredPackages.length;
            const start = total === 0 ? 0 : startIndex + 1;
            const end = Math.min(endIndex, total);
            document.getElementById('paginationInfo').textContent = `Showing ${start}-${end} of ${total} packages`;
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredPackages.length / itemsPerPage);
            const controls = document.getElementById('paginationControls');
            
            if (totalPages <= 1) {
                controls.innerHTML = '';
                return;
            }

            let paginationHTML = `
                <button class="btn btn-ghost btn-sm" ${currentPage === 1 ? 'disabled' : ''} onclick="changePage(${currentPage - 1})">Previous</button>
            `;

            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    paginationHTML += `
                        <button class="btn ${i === currentPage ? 'btn-primary' : 'btn-ghost'} btn-sm" onclick="changePage(${i})">${i}</button>
                    `;
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    paginationHTML += `<span class="pagination-ellipsis">...</span>`;
                }
            }

            paginationHTML += `
                <button class="btn btn-ghost btn-sm" ${currentPage === totalPages ? 'disabled' : ''} onclick="changePage(${currentPage + 1})">Next</button>
            `;
            
            controls.innerHTML = paginationHTML;
        }

        function changePage(page) {
            const totalPages = Math.ceil(filteredPackages.length / itemsPerPage);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                displayPackages();
                updatePagination();
            }
        }

        // ===================================
        // FILTER FUNCTIONS
        // ===================================
        function applyFilters() {
            try {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const bankFilter = document.getElementById('bankFilter').value;
                const propertyFilter = document.getElementById('propertyFilter').value;
                const statusFilter = document.getElementById('statusFilter').value;
                const typeFilter = document.getElementById('typeFilter').value;

                filteredPackages = currentPackages.filter(function(pkg) {
                    const matchesSearch = !searchTerm || 
                        (pkg.bank_name && pkg.bank_name.toLowerCase().includes(searchTerm)) ||
                        (pkg.property_type && pkg.property_type.toLowerCase().includes(searchTerm)) ||
                        (pkg.reference_rate && pkg.reference_rate.toLowerCase().includes(searchTerm)) ||
                        (pkg.loan_type && pkg.loan_type.toLowerCase().includes(searchTerm));

                    const matchesBank = !bankFilter || pkg.bank_name === bankFilter;
                    const matchesProperty = !propertyFilter || pkg.property_type === propertyFilter;
                    const matchesStatus = !statusFilter || pkg.property_status === statusFilter;
                    const matchesType = !typeFilter || pkg.rate_type_category === typeFilter;

                    return matchesSearch && matchesBank && matchesProperty && matchesStatus && matchesType;
                });

                currentPage = 1;
                displayPackages();
                updatePagination();

            } catch (error) {
                console.error('Error applying filters:', error);
                showNotification('Error applying filters: ' + error.message, 'error');
            }
        }

        function clearFilters() {
            try {
                // Clear all filter inputs
                document.getElementById('searchInput').value = '';
                document.getElementById('bankFilter').value = '';
                document.getElementById('propertyFilter').value = '';
                document.getElementById('statusFilter').value = '';
                document.getElementById('typeFilter').value = '';

                // Reset filtered packages
                filteredPackages = [...currentPackages];
                currentPage = 1;
                displayPackages();
                updatePagination();

                showNotification('All filters cleared', 'success');
            } catch (error) {
                console.error('Error clearing filters:', error);
                showNotification('Error clearing filters: ' + error.message, 'error');
            }
        }

        // ===================================
        // CRUD OPERATIONS
        // ===================================
        function openAddPackageModal() {
            try {
                console.log('Opening add package modal...');
                editingPackageId = null;
                document.getElementById('packageModalTitle').textContent = 'Add Rate Package';
                document.getElementById('saveButtonText').textContent = 'Save';
                
                // Reset form
                const form = document.getElementById('packageForm');
                form.reset();
                
                // Uncheck all radio buttons
                const radioButtons = form.querySelectorAll('input[type="radio"]');
                for (var i = 0; i < radioButtons.length; i++) {
                    radioButtons[i].checked = false;
                }
                
                // Set default values for boolean fields
                const defaultNoRadios = form.querySelectorAll('input[type="radio"][value="false"]');
                for (var j = 0; j < defaultNoRadios.length; j++) {
                    defaultNoRadios[j].checked = true;
                }
                
                openModal('package-modal');
            } catch (error) {
                console.error('Error opening add modal:', error);
                showNotification('Failed to open add form: ' + error.message, 'error');
            }
        }

        async function editPackage(id) {
            try {
                editingPackageId = id;
                document.getElementById('packageModalTitle').textContent = 'Edit Rate Package';
                document.getElementById('saveButtonText').textContent = 'Update';

                // Find the package data
                const pkg = currentPackages.find(p => p.id === id);
                if (!pkg) {
                    throw new Error('Package not found');
                }

                // Populate form
                const form = document.getElementById('packageForm');
                var keys = Object.keys(pkg);
                for (var i = 0; i < keys.length; i++) {
                    var key = keys[i];
                    var input = form.querySelector('[name="' + key + '"]');
                    if (input) {
                        if (input.type === 'radio') {
                            if (input.value === String(pkg[key])) {
                                input.checked = true;
                            }
                        } else {
                            input.value = pkg[key] || '';
                        }
                    }
                }

                openModal('package-modal');

            } catch (error) {
                console.error('Error editing package:', error);
                showNotification('Failed to load package data: ' + error.message, 'error');
            }
        }

        async function deletePackage(id) {
            if (!confirm('Are you sure you want to delete this rate package? This action cannot be undone.')) {
                return;
            }

            try {
                showLoading('Deleting package...');
                console.log('Deleting package with ID:', id);

                const { error } = await supabaseClient
                    .from('rate_packages')
                    .delete()
                    .eq('id', id);

                if (error) {
                    console.error('Supabase error deleting package:', error);
                    throw error;
                }

                console.log('Package deleted successfully');
                showNotification('Rate package deleted successfully', 'success');
                await loadPackages(); // Reload the data

            } catch (error) {
                console.error('Error deleting package:', error);
                showNotification('Failed to delete rate package: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        async function savePackage(event) {
            event.preventDefault();
            
            try {
                showLoading();

                const formData = new FormData(event.target);
                const packageData = {};

                // Process form data
                for (let [key, value] of formData.entries()) {
                    if (value !== '') {
                        // Handle boolean fields (only the ones that exist in schema)
                        if (['legal_fee_subsidy', 'valuation_subsidy'].includes(key)) {
                            packageData[key] = value === 'true';
                        }
                        // Handle numeric fields
                        else if (['loan_amount', 'minimum_loan_size'].includes(key)) {
                            packageData[key] = parseInt(value) || null;
                        }
                        // Handle decimal fields
                        else if (['year1_value', 'year2_value', 'year3_value', 'year4_value', 'year5_value', 'thereafter_value',
                                 'partial_pay_penalty', 'full_redeem_penalty', 'cancellation_penalty'].includes(key)) {
                            packageData[key] = parseFloat(value) || null;
                        }
                        // Handle text fields
                        else {
                            packageData[key] = value;
                        }
                    }
                }

                // Remove the id field for create operations
                if (!editingPackageId) {
                    delete packageData.id;
                }

                // Set default status for new packages
                if (!editingPackageId && !packageData.status) {
                    packageData.status = 'active';
                }

                let result;
                if (editingPackageId) {
                    // Update existing package
                    result = await supabaseClient
                        .from('rate_packages')
                        .update(packageData)
                        .eq('id', editingPackageId)
                        .select();
                } else {
                    // Create new package
                    result = await supabaseClient
                        .from('rate_packages')
                        .insert([packageData])
                        .select();
                }

                if (result.error) throw result.error;

                const action = editingPackageId ? 'updated' : 'created';
                showNotification(`Rate package ${action} successfully`, 'success');
                closeModal('package-modal');
                await loadPackages(); // Reload the data

            } catch (error) {
                console.error('Error saving package:', error);
                showNotification('Failed to save rate package: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        async function exportPackages() {
            try {
                const csv = generateCSV(filteredPackages);
                downloadCSV(csv, 'rate_packages.csv');
                showNotification('Export completed successfully', 'success');
            } catch (error) {
                console.error('Error exporting packages:', error);
                showNotification('Failed to export packages: ' + error.message, 'error');
            }
        }

        // ===================================
        // UTILITY FUNCTIONS
        // ===================================
        function showNotification(message, type = 'info') {
            console.log(type.toUpperCase() + ': ' + message);
            
            // Create notification if container exists
            let container = document.getElementById('notificationContainer');
            if (!container) {
                container = document.createElement('div');
                container.id = 'notificationContainer';
                container.className = 'notification-container';
                container.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 10000;
                    max-width: 400px;
                `;
                document.body.appendChild(container);
            }
            
            const notification = document.createElement('div');
            notification.className = 'notification notification-' + type;
            notification.style.cssText = `
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
                color: white;
                padding: 12px 16px;
                border-radius: 6px;
                margin-bottom: 10px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                animation: slideIn 0.3s ease-out;
            `;
            notification.textContent = message;
            
            container.appendChild(notification);
            
            // Auto remove after 4 seconds
            setTimeout(function() {
                if (notification.parentNode) {
                    notification.style.animation = 'slideOut 0.3s ease-in';
                    setTimeout(function() {
                        if (notification.parentNode) {
                            notification.remove();
                        }
                    }, 300);
                }
            }, 4000);
        }

        function showLoading(message = 'Loading...') {
            let overlay = document.getElementById('loadingOverlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'loadingOverlay';
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 9999;
                    color: white;
                    font-size: 16px;
                `;
                overlay.innerHTML = '<div>' + message + '</div>';
                document.body.appendChild(overlay);
            }
            overlay.style.display = 'flex';
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = '';
            }
        }
        function getStatusClass(status) {
            switch (status) {
                case 'Completed':
                    return 'badge-active';
                case 'Under Construction':
                    return 'badge-pending';
                default:
                    return 'badge-secondary';
            }
        }

        function formatNumber(num) {
            if (!num) return '0';
            return new Intl.NumberFormat().format(num);
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function generateCSV(data) {
            const headers = [
                'Bank Name', 'Property Type', 'Reference Rate', 'Property Status', 
                'Rate Type Category', 'Loan Amount', 'Loan Type', 'Lock Period',
                'Minimum Loan Size', 'Lock In Period'
            ];
            
            const rows = data.map(function(pkg) {
                return [
                    pkg.bank_name || '',
                    pkg.property_type || '',
                    pkg.reference_rate || '',
                    pkg.property_status || '',
                    pkg.rate_type_category || '',
                    pkg.loan_amount || '',
                    pkg.loan_type || '',
                    pkg.lock_period || '',
                    pkg.minimum_loan_size || '',
                    pkg.lock_in_period || ''
                ];
            });

            return [headers].concat(rows).map(function(row) {
                return row.map(function(field) {
                    return '"' + String(field).replace(/"/g, '""') + '"';
                }).join(',');
            }).join('\n');
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // ===================================
        // GLOBAL FUNCTIONS
        // ===================================
        async function confirmSignOut() {
            if (confirm('Are you sure you want to sign out?')) {
                try {
                    await supabaseClient.auth.signOut();
                    window.location.href = 'login.html';
                } catch (error) {
                    console.error('Sign out error:', error);
                    showNotification('Sign out failed: ' + error.message, 'error');
                }
            }
        }

        // Make functions globally available
        window.applyFilters = applyFilters;
        window.clearFilters = clearFilters;
        window.editPackage = editPackage;
        window.deletePackage = deletePackage;
        window.savePackage = savePackage;
        window.openAddPackageModal = openAddPackageModal;
        window.exportPackages = exportPackages;
        window.confirmSignOut = confirmSignOut;
        window.changePage = changePage;
        window.showNotification = showNotification;
        window.showLoading = showLoading;
        window.hideLoading = hideLoading;
        window.openModal = openModal;
        window.closeModal = closeModal;

        console.log('Rate packages page initialized successfully');
    </script>

    <style>
        /* Additional specific styles for rate packages */
        .form-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e2e8f0;
        }

        .form-section:last-child {
            border-bottom: none;
        }

        .form-section h4 {
            margin-bottom: 20px;
            color: #1e293b;
            font-weight: 600;
            font-size: 16px;
        }

        .rate-years {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .rate-year-row {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .rate-year-row .form-label {
            font-weight: 600;
            color: #475569;
            margin-bottom: 5px;
        }

        .rate-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .rate-type-select {
            flex: 2;
        }

        .operator-select {
            width: 60px;
            flex: none;
        }

        .input-group {
            position: relative;
            flex: 1;
        }

        .input-prefix,
        .input-suffix {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            color: #64748b;
            font-size: 14px;
            z-index: 1;
        }

        .input-prefix {
            left: 12px;
        }

        .input-suffix {
            right: 12px;
        }

        .input-group input {
            padding-left: 30px;
            padding-right: 30px;
        }

        .radio-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .radio-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .radio-label input[type="radio"] {
            margin: 0;
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-dialog {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-close {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
        }

        /* Button Styles */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-ghost {
            background: transparent;
            color: #64748b;
            border: 1px solid #e2e8f0;
        }

        .btn-ghost:hover {
            background: #f8fafc;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-edit {
            background: #3b82f6;
            color: white;
        }

        .btn-delete {
            background: #ef4444;
            color: white;
        }

        .btn[disabled] {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Form Styles */
        .form-control {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-control:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
            color: #374151;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }

        /* Status Badge Styles */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-active {
            background: #dcfce7;
            color: #166534;
        }

        .badge-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-secondary {
            background: #f3f4f6;
            color: #374151;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            color: white;
            font-size: 16px;
        }

        .loading-spinner i {
            font-size: 32px;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .rate-input-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .rate-type-select,
            .operator-select {
                width: 100%;
                flex: none;
            }
            
            .operator-select {
                width: 100px;
            }
        }
    </style>
</body>
</html>
