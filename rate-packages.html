<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rate Packages - Keyquest Mortgage Admin</title>
    
    <!-- Standardized CSS and Script Connections -->
    <link rel="stylesheet" href="css/admin-styles.css">
    <script src="js/lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config/supabase.js"></script>
    <script src="js/admin-scripts.js"></script>
</head>
<body>
    <div class="overlay" id="overlay" onclick="closeSidebar()"></div>
    
    <div class="admin-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="index.html" class="logo">
                    <div class="logo-icon">
                        <i data-lucide="building-2"></i>
                    </div>
                    <span>KEYQUEST</span>
                </a>
            </div>
            <nav class="nav-menu">
                <a href="index.html" class="nav-item">
                    <i data-lucide="layout-dashboard"></i>
                    <span>Dashboard</span>
                </a>
                <a href="rate-packages.html" class="nav-item active">
                    <i data-lucide="package"></i>
                    <span>Rate Package</span>
                </a>
                <a href="rate-types.html" class="nav-item">
                    <i data-lucide="percent"></i>
                    <span>Rate Type</span>
                </a>
                <a href="banks.html" class="nav-item">
                    <i data-lucide="landmark"></i>
                    <span>Bank</span>
                </a>
                <a href="bankers.html" class="nav-item">
                    <i data-lucide="briefcase"></i>
                    <span>Bankers</span>
                </a>
                <a href="agents.html" class="nav-item">
                    <i data-lucide="users"></i>
                    <span>Agents</span>
                </a>
                <a href="enquiry.html" class="nav-item">
                    <i data-lucide="help-circle"></i>
                    <span>Enquiry</span>
                </a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content" id="mainContent">
            <header class="header">
                <div class="header-left">
                    <button class="menu-toggle" onclick="toggleSidebar()">
                        <i data-lucide="menu"></i>
                    </button>
                    <h1 class="header-title">Rate Packages</h1>
                </div>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="openModal('package-modal')">
                        <i data-lucide="plus"></i>
                        <span>Add Rate Package</span>
                    </button>
                    <button class="btn btn-secondary" onclick="confirmSignOut()">
                        <i data-lucide="log-out"></i>
                        <span>Sign Out</span>
                    </button>
                    <div class="user-profile">
                        <div class="user-avatar" id="userAvatar">A</div>
                        <div class="user-info">
                            <div class="user-name" id="userName">admin</div>
                            <div class="user-role">Super Admin</div>
                        </div>
                    </div>
                </div>
            </header>

            <div class="content-area">
                <!-- Search and Filter Bar -->
                <div class="search-filter-bar">
                    <div class="search-box">
                        <i data-lucide="search" class="search-icon"></i>
                        <input type="text" class="search-input" placeholder="Search rate packages..." id="searchInput" onkeyup="filterPackages()">
                    </div>
                    <select class="filter-select" id="bankFilter" onchange="filterPackages()">
                        <option value="">All Banks</option>
                    </select>
                    <select class="filter-select" id="statusFilter" onchange="filterPackages()">
                        <option value="">All Status</option>
                        <option value="completed">Completed</option>
                        <option value="under_construction">Under Construction</option>
                        <option value="active">Active</option>
                    </select>
                    <select class="filter-select" id="typeFilter" onchange="filterPackages()">
                        <option value="">All Types</option>
                        <option value="Fixed">Fixed</option>
                        <option value="Floating">Floating</option>
                    </select>
                    <button class="btn btn-secondary" onclick="exportToCSV('rate-packages.csv')">
                        <i data-lucide="download"></i>
                        <span>Export</span>
                    </button>
                </div>

                <!-- Data Table -->
                <div class="data-table">
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Bank Name</th>
                                    <th>Property Type</th>
                                    <th>Reference Rate</th>
                                    <th>Property Status</th>
                                    <th>Rate Type</th>
                                    <th>Loan Amount</th>
                                    <th>Loan Type</th>
                                    <th>Lock Period</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="packagesTable">
                                <tr>
                                    <td colspan="10" style="text-align: center; padding: 40px;">
                                        <div class="loading-spinner"></div>
                                        <div style="margin-top: 10px;">Loading rate packages...</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Pagination -->
                <div class="pagination">
                    <div class="pagination-info">
                        <span id="paginationInfo">Showing 0 of 0</span>
                    </div>
                    <div class="pagination-controls" id="paginationControls">
                        <!-- Pagination buttons will be generated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Rate Package Modal -->
    <div class="modal" id="package-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Add Rate Package</h3>
                <button class="modal-close" onclick="closeModal('package-modal')">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="packageForm">
                    <!-- Basic Information -->
                    <div class="form-section">
                        <h4>Basic Information</h4>
                        <div class="form-grid">
                            <div class="form-group half">
                                <label class="form-label">Bank Name *</label>
                                <select class="form-select" name="bank_name" required>
                                    <option value="">Select Bank</option>
                                </select>
                            </div>
                            <div class="form-group half">
                                <label class="form-label">Loan Type *</label>
                                <select class="form-select" name="loan_type" required>
                                    <option value="">Select Loan Type</option>
                                    <option value="New Home Loan">New Home Loan</option>
                                    <option value="Refinancing Home Loan">Refinancing Home Loan</option>
                                </select>
                            </div>
                            <div class="form-group half">
                                <label class="form-label">Property Type *</label>
                                <select class="form-select" name="property_type" required>
                                    <option value="">Select Property Type</option>
                                    <option value="Private Property">Private Property</option>
                                    <option value="HDB">HDB</option>
                                    <option value="EC">EC</option>
                                    <option value="Private Property, EC">Private Property, EC</option>
                                </select>
                            </div>
                            <div class="form-group half">
                                <label class="form-label">Property Status *</label>
                                <select class="form-select" name="property_status" required>
                                    <option value="">Select Property Status</option>
                                    <option value="Completed">Completed</option>
                                    <option value="Under Construction">Under Construction</option>
                                </select>
                            </div>
                            <div class="form-group half">
                                <label class="form-label">Rate Type Category *</label>
                                <div style="display: flex; gap: 20px; margin-top: 8px;">
                                    <label style="display: flex; align-items: center; gap: 8px;">
                                        <input type="radio" name="rate_type_category" value="Fixed" required>
                                        <span>Fixed</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px;">
                                        <input type="radio" name="rate_type_category" value="Floating" required>
                                        <span>Floating</span>
                                    </label>
                                </div>
                            </div>
                            <div class="form-group half">
                                <label class="form-label">Reference Rate</label>
                                <input type="text" class="form-input" name="reference_rate" placeholder="Enter reference rate">
                            </div>
                            <div class="form-group half">
                                <label class="form-label">Loan Amount *</label>
                                <input type="number" class="form-input" name="loan_amount" placeholder="Enter loan amount" required>
                            </div>
                            <div class="form-group half">
                                <label class="form-label">Lock Period</label>
                                <input type="text" class="form-input" name="lock_period" placeholder="e.g., 2 Years">
                            </div>
                        </div>
                    </div>

                    <!-- Interest Rate Information -->
                    <div class="form-section">
                        <h4>Interest Rate Information</h4>
                        <div class="rate-years">
                            <!-- Year 1 -->
                            <div class="rate-year-row">
                                <label class="form-label">Year 1</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <select class="form-select" name="year1_rate_type" style="flex: 2;">
                                        <option value="">Select rate type</option>
                                    </select>
                                    <select class="form-select" name="year1_operator" style="width: 60px;">
                                        <option value="+">+</option>
                                        <option value="-">-</option>
                                    </select>
                                    <input type="number" class="form-input" name="year1_value" step="0.001" placeholder="0.000" style="flex: 1;">
                                    <span style="padding: 0 8px;">%</span>
                                </div>
                            </div>

                            <!-- Year 2 -->
                            <div class="rate-year-row">
                                <label class="form-label">Year 2</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <select class="form-select" name="year2_rate_type" style="flex: 2;">
                                        <option value="">Select rate type</option>
                                    </select>
                                    <select class="form-select" name="year2_operator" style="width: 60px;">
                                        <option value="+">+</option>
                                        <option value="-">-</option>
                                    </select>
                                    <input type="number" class="form-input" name="year2_value" step="0.001" placeholder="0.000" style="flex: 1;">
                                    <span style="padding: 0 8px;">%</span>
                                </div>
                            </div>

                            <!-- Year 3 -->
                            <div class="rate-year-row">
                                <label class="form-label">Year 3</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <select class="form-select" name="year3_rate_type" style="flex: 2;">
                                        <option value="">Select rate type</option>
                                    </select>
                                    <select class="form-select" name="year3_operator" style="width: 60px;">
                                        <option value="+">+</option>
                                        <option value="-">-</option>
                                    </select>
                                    <input type="number" class="form-input" name="year3_value" step="0.001" placeholder="0.000" style="flex: 1;">
                                    <span style="padding: 0 8px;">%</span>
                                </div>
                            </div>

                            <!-- Year 4 -->
                            <div class="rate-year-row">
                                <label class="form-label">Year 4</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <select class="form-select" name="year4_rate_type" style="flex: 2;">
                                        <option value="">Select rate type</option>
                                    </select>
                                    <select class="form-select" name="year4_operator" style="width: 60px;">
                                        <option value="+">+</option>
                                        <option value="-">-</option>
                                    </select>
                                    <input type="number" class="form-input" name="year4_value" step="0.001" placeholder="0.000" style="flex: 1;">
                                    <span style="padding: 0 8px;">%</span>
                                </div>
                            </div>

                            <!-- Year 5 -->
                            <div class="rate-year-row">
                                <label class="form-label">Year 5</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <select class="form-select" name="year5_rate_type" style="flex: 2;">
                                        <option value="">Select rate type</option>
                                    </select>
                                    <select class="form-select" name="year5_operator" style="width: 60px;">
                                        <option value="+">+</option>
                                        <option value="-">-</option>
                                    </select>
                                    <input type="number" class="form-input" name="year5_value" step="0.001" placeholder="0.000" style="flex: 1;">
                                    <span style="padding: 0 8px;">%</span>
                                </div>
                            </div>

                            <!-- Thereafter -->
                            <div class="rate-year-row">
                                <label class="form-label">Thereafter</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <select class="form-select" name="thereafter_rate_type" style="flex: 2;">
                                        <option value="">Select rate type</option>
                                    </select>
                                    <select class="form-select" name="thereafter_operator" style="width: 60px;">
                                        <option value="+">+</option>
                                        <option value="-">-</option>
                                    </select>
                                    <input type="number" class="form-input" name="thereafter_value" step="0.001" placeholder="0.000" style="flex: 1;">
                                    <span style="padding: 0 8px;">%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Other Information -->
                    <div class="form-section">
                        <h4>Other Information</h4>
                        <div class="form-grid">
                            <div class="form-group half">
                                <label class="form-label">Minimum Loan Size</label>
                                <input type="number" class="form-input" name="minimum_loan_size" placeholder="Enter minimum loan size">
                            </div>
                            <div class="form-group half">
                                <label class="form-label">Lock In Period</label>
                                <input type="text" class="form-input" name="lock_in_period" placeholder="e.g., 2 Years">
                            </div>
                            <div class="form-group half">
                                <label class="form-label">Partial Pay Penalty (%)</label>
                                <input type="number" class="form-input" name="partial_pay_penalty" step="0.01" placeholder="0.00">
                            </div>
                            <div class="form-group half">
                                <label class="form-label">Full Redeem Penalty (%)</label>
                                <input type="number" class="form-input" name="full_redeem_penalty" step="0.01" placeholder="0.00">
                            </div>
                            <div class="form-group half">
                                <label class="form-label">Cancellation Penalty (%)</label>
                                <input type="number" class="form-input" name="cancellation_penalty" step="0.01" placeholder="0.00">
                            </div>
                            <div class="form-group half">
                                <label class="form-label">Status</label>
                                <select class="form-select" name="status">
                                    <option value="active">Active</option>
                                    <option value="completed">Completed</option>
                                    <option value="under_construction">Under Construction</option>
                                </select>
                            </div>
                        </div>

                        <!-- Boolean Options -->
                        <div class="form-grid" style="margin-top: 20px;">
                            <div class="form-group half">
                                <label style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" name="legal_fee_subsidy">
                                    <span>Legal Fee Subsidy / Cash Rebate</span>
                                </label>
                            </div>
                            <div class="form-group half">
                                <label style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" name="valuation_subsidy">
                                    <span>Valuation Subsidy</span>
                                </label>
                            </div>
                            <div class="form-group half">
                                <label style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" name="partial_repayment">
                                    <span>Partial Repayment</span>
                                </label>
                            </div>
                            <div class="form-group half">
                                <label style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" name="waiver_due_to_sales">
                                    <span>Waiver Due to Sales</span>
                                </label>
                            </div>
                            <div class="form-group half">
                                <label style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" name="free_package_conversion_12m">
                                    <span>Free Package Conversion 12 Months</span>
                                </label>
                            </div>
                            <div class="form-group half">
                                <label style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" name="free_package_conversion_24m">
                                    <span>Free Package Conversion 24 Months</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" name="free_package_conversion_36m">
                                    <span>Free Package Conversion 36 Months</span>
                                </label>
                            </div>
                        </div>

                        <!-- Remarks -->
                        <div class="form-group">
                            <label class="form-label">Remarks</label>
                            <textarea class="form-input" name="remarks" rows="4" placeholder="Enter any additional remarks..."></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('package-modal')">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="savePackage()">
                    <span id="saveButtonText">Save Package</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // ===================================
        // RATE PACKAGES PAGE FUNCTIONALITY
        // ===================================

        let currentPackages = [];
        let filteredPackages = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        let editingPackageId = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Initialize icons
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                }
                
                // Check authentication
                await checkAuthentication();
                
                // Load data
                await loadPageData();
                
                console.log('Rate packages page ready');
                
            } catch (error) {
                console.error('Page initialization error:', error.message);
                if (typeof showNotification !== 'undefined') {
                    showNotification('Page initialization failed', 'error');
                }
            }
        });

        // ===================================
        // AUTHENTICATION
        // ===================================
        async function checkAuthentication() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                
                if (!user) {
                    window.location.href = 'login.html';
                    return;
                }
                
                const userNameElement = document.getElementById('userName');
                const userAvatarElement = document.getElementById('userAvatar');
                
                if (userNameElement && user.email) {
                    const name = user.user_metadata?.full_name || user.email.split('@')[0];
                    userNameElement.textContent = name;
                    
                    if (userAvatarElement) {
                        userAvatarElement.textContent = name.charAt(0).toUpperCase();
                    }
                }
                
            } catch (error) {
                console.error('Authentication check failed:', error.message);
                window.location.href = 'login.html';
            }
        }

        // ===================================
        // DATA LOADING
        // ===================================
        async function loadPageData() {
            await Promise.all([
                loadRatePackages(),
                loadBanks(),
                loadRateTypes()
            ]);
        }

        async function loadRatePackages() {
            try {
                const { data, error } = await supabaseClient
                    .from('rate_packages')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                currentPackages = data || [];
                filteredPackages = [...currentPackages];
                displayPackages();
                updatePagination();

            } catch (error) {
                console.error('Error loading rate packages:', error.message);
                showNotification('Failed to load rate packages', 'error');
            }
        }

        async function loadBanks() {
            try {
                const { data, error } = await supabaseClient
                    .from('banks')
                    .select('name')
                    .order('name');

                if (error) throw error;

                // Populate bank filter
                const bankFilter = document.getElementById('bankFilter');
                const bankSelects = document.querySelectorAll('select[name="bank_name"]');
                
                const bankOptions = (data || []).map(bank => 
                    `<option value="${bank.name}">${bank.name}</option>`
                ).join('');

                bankFilter.innerHTML = '<option value="">All Banks</option>' + bankOptions;
                bankSelects.forEach(select => {
                    select.innerHTML = '<option value="">Select Bank</option>' + bankOptions;
                });

            } catch (error) {
                console.error('Error loading banks:', error.message);
            }
        }

        async function loadRateTypes() {
            try {
                const { data, error } = await supabaseClient
                    .from('rate_types')
                    .select('rate_type, rate_value')
                    .order('rate_type');

                if (error) throw error;

                // Populate rate type selects
                const rateTypeSelects = document.querySelectorAll('select[name$="_rate_type"]');
                
                const rateTypeOptions = (data || []).map(rateType => 
                    `<option value="${rateType.rate_type}">${rateType.rate_type}(${rateType.rate_value}%)</option>`
                ).join('');

                rateTypeSelects.forEach(select => {
                    select.innerHTML = '<option value="">Select rate type</option>' + rateTypeOptions;
                });

            } catch (error) {
                console.error('Error loading rate types:', error.message);
            }
        }

        // ===================================
        // DISPLAY FUNCTIONS
        // ===================================
        function displayPackages() {
            const tbody = document.getElementById('packagesTable');
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pagePackages = filteredPackages.slice(startIndex, endIndex);

            if (pagePackages.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 40px; color: #64748b;">
                            No rate packages found
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = pagePackages.map(pkg => `
                <tr>
                    <td><strong>${pkg.bank_name || 'N/A'}</strong></td>
                    <td>${pkg.property_type || 'N/A'}</td>
                    <td>${pkg.reference_rate || 'N/A'}</td>
                    <td>
                        <span class="status-badge ${getStatusClass(pkg.property_status)}">
                            ${pkg.property_status || 'N/A'}
                        </span>
                    </td>
                    <td>
                        <span class="status-badge ${pkg.rate_type_category === 'Fixed' ? 'badge-active' : 'badge-pending'}">
                            ${pkg.rate_type_category || 'N/A'}
                        </span>
                    </td>
                    <td><strong>$${formatNumber(pkg.loan_amount)}</strong></td>
                    <td>${pkg.loan_type || 'N/A'}</td>
                    <td>${pkg.lock_period || 'N/A'}</td>
                    <td>
                        <span class="status-badge ${getStatusClass(pkg.status)}">
                            ${capitalizeFirst(pkg.status) || 'Active'}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-edit" onclick="editPackage('${pkg.id}')">
                                <i data-lucide="edit"></i>
                            </button>
                            <button class="btn btn-sm btn-delete" onclick="deletePackage('${pkg.id}')">
                                <i data-lucide="trash-2"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');

            // Re-initialize icons
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }
        }

        // ===================================
        // FILTER FUNCTIONS
        // ===================================
        function filterPackages() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const bankFilter = document.getElementById('bankFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;

            filteredPackages = currentPackages.filter(pkg => {
                const matchesSearch = !searchTerm || 
                    (pkg.bank_name && pkg.bank_name.toLowerCase().includes(searchTerm)) ||
                    (pkg.property_type && pkg.property_type.toLowerCase().includes(searchTerm)) ||
                    (pkg.reference_rate && pkg.reference_rate.toLowerCase().includes(searchTerm));

                const matchesBank = !bankFilter || pkg.bank_name === bankFilter;
                const matchesStatus = !statusFilter || pkg.status === statusFilter;
                const matchesType = !typeFilter || pkg.rate_type_category === typeFilter;

                return matchesSearch && matchesBank && matchesStatus && matchesType;
            });

            currentPage = 1;
            displayPackages();
            updatePagination();
        }

        // ===================================
        // CRUD OPERATIONS
        // ===================================
        async function savePackage() {
            try {
                const form = document.getElementById('packageForm');
                const formData = new FormData(form);
                
                // Convert FormData to object
                const packageData = {};
                for (let [key, value] of formData.entries()) {
                    if (key.includes('_penalty') || key.includes('_value') || key === 'loan_amount' || key === 'minimum_loan_size') {
                        packageData[key] = value ? parseFloat(value) : null;
                    } else if (key.includes('legal_fee_subsidy') || key.includes('valuation_subsidy') || 
                               key.includes('partial_repayment') || key.includes('waiver_due_to_sales') ||
                               key.includes('free_package_conversion')) {
                        packageData[key] = true;
                    } else {
                        packageData[key] = value || null;
                    }
                }

                // Handle checkboxes that aren't checked
                const checkboxFields = [
                    'legal_fee_subsidy', 'valuation_subsidy', 'partial_repayment', 
                    'waiver_due_to_sales', 'free_package_conversion_12m', 
                    'free_package_conversion_24m', 'free_package_conversion_36m'
                ];
                
                checkboxFields.forEach(field => {
                    if (!(field in packageData)) {
                        packageData[field] = false;
                    }
                });

                // Set default status if not provided
                if (!packageData.status) {
                    packageData.status = 'active';
                }

                let result;
                if (editingPackageId) {
                    // Update existing package
                    const { data, error } = await supabaseClient
                        .from('rate_packages')
                        .update(packageData)
                        .eq('id', editingPackageId)
                        .select();
                    
                    if (error) throw error;
                    result = data;
                    showNotification('Rate package updated successfully', 'success');
                } else {
                    // Create new package
                    const { data, error } = await supabaseClient
                        .from('rate_packages')
                        .insert([packageData])
                        .select();
                    
                    if (error) throw error;
                    result = data;
                    showNotification('Rate package created successfully', 'success');
                }

                // Close modal and refresh data
                closeModal('package-modal');
                await loadRatePackages();

            } catch (error) {
                console.error('Error saving package:', error.message);
                showNotification('Failed to save rate package: ' + error.message, 'error');
            }
        }

        async function editPackage(id) {
            try {
                const pkg = currentPackages.find(p => p.id === id);
                if (!pkg) {
                    showNotification('Package not found', 'error');
                    return;
                }

                editingPackageId = id;
                document.getElementById('modalTitle').textContent = 'Edit Rate Package';
                document.getElementById('saveButtonText').textContent = 'Update Package';

                // Populate form
                const form = document.getElementById('packageForm');
                Object.keys(pkg).forEach(key => {
                    const input = form.querySelector(`[name="${key}"]`);
                    if (input) {
                        if (input.type === 'checkbox') {
                            input.checked = pkg[key];
                        } else if (input.type === 'radio') {
                            if (input.value === pkg[key]) {
                                input.checked = true;
                            }
                        } else {
                            input.value = pkg[key] || '';
                        }
                    }
                });

                openModal('package-modal');

            } catch (error) {
                console.error('Error editing package:', error.message);
                showNotification('Failed to load package data', 'error');
            }
        }

        async function deletePackage(id) {
            if (!confirm('Are you sure you want to delete this rate package?')) {
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('rate_packages')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                showNotification('Rate package deleted successfully', 'success');
                await loadRatePackages();

            } catch (error) {
                console.error('Error deleting package:', error.message);
                showNotification('Failed to delete rate package', 'error');
            }
        }

        // ===================================
        // MODAL FUNCTIONS
        // ===================================
        function openAddPackageModal() {
            editingPackageId = null;
            document.getElementById('modalTitle').textContent = 'Add Rate Package';
            document.getElementById('saveButtonText').textContent = 'Save Package';
            document.getElementById('packageForm').reset();
            openModal('package-modal');
        }

        // ===================================
        // UTILITY FUNCTIONS
        // ===================================
        function getStatusClass(status) {
            switch (status?.toLowerCase()) {
                case 'completed': return 'badge-active';
                case 'under_construction': return 'badge-pending';
                case 'active': return 'badge-active';
                default: return 'badge-inactive';
            }
        }

        function formatNumber(num) {
            if (!num) return '0';
            return new Intl.NumberFormat().format(num);
        }

        function capitalizeFirst(str) {
            if (!str) return '';
            return str.charAt(0).toUpperCase() + str.slice(1).replace('_', ' ');
        }

        function updatePagination() {
            const totalItems = filteredPackages.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            
            document.getElementById('paginationInfo').textContent = 
                `Showing ${Math.min((currentPage - 1) * itemsPerPage + 1, totalItems)} to ${Math.min(currentPage * itemsPerPage, totalItems)} of ${totalItems}`;

            const controls = document.getElementById('paginationControls');
            if (totalPages <= 1) {
                controls.innerHTML = '';
                return;
            }

            let paginationHTML = '';
            
            // Previous button
            paginationHTML += `<button class="pagination-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="changePage(${currentPage - 1})">Previous</button>`;
            
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPage) {
                    paginationHTML += `<button class="pagination-btn active">${i}</button>`;
                } else {
                    paginationHTML += `<button class="pagination-btn" onclick="changePage(${i})">${i}</button>`;
                }
            }
            
            // Next button
            paginationHTML += `<button class="pagination-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="changePage(${currentPage + 1})">Next</button>`;
            
            controls.innerHTML = paginationHTML;
        }

        function changePage(page) {
            currentPage = page;
            displayPackages();
            updatePagination();
        }

        // ===================================
        // GLOBAL FUNCTIONS
        // ===================================
        async function confirmSignOut() {
            if (confirm('Are you sure you want to sign out?')) {
                try {
                    await supabaseClient.auth.signOut();
                    window.location.href = 'login.html';
                } catch (error) {
                    console.error('Sign out error:', error.message);
                    showNotification('Sign out failed', 'error');
                }
            }
        }

        // Make functions globally available
        window.filterPackages = filterPackages;
        window.editPackage = editPackage;
        window.deletePackage = deletePackage;
        window.savePackage = savePackage;
        window.confirmSignOut = confirmSignOut;
        window.changePage = changePage;
    </script>

    <style>
        /* Additional specific styles for rate packages */
        .form-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e2e8f0;
        }

        .form-section:last-child {
            border-bottom: none;
        }

        .form-section h4 {
            margin-bottom: 20px;
            color: #1e293b;
            font-weight: 600;
            font-size: 16px;
        }

        .rate-years {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .rate-year-row {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .rate-year-row .form-label {
            font-weight: 600;
            color: #475569;
            margin-bottom: 5px;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .form-group.half {
                grid-column: span 1;
            }
            
            .rate-year-row > div {
                flex-direction: column;
            }
            
            .rate-year-row select,
            .rate-year-row input {
                flex: none !important;
                width: 100% !important;
            }
        }
    </style>
</body>
</html>
