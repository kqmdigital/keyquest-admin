<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keyquest Mortgage Admin - Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="css/admin-styles.css">
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="index.html" class="logo">
                    <div class="logo-icon">
                        <i data-lucide="building-2"></i>
                    </div>
                    <span>KEYQUEST</span>
                </a>
            </div>
            <nav class="nav-menu">
                <a href="index.html" class="nav-item active">
                    <i data-lucide="layout-dashboard"></i>
                    <span>Dashboard</span>
                </a>
                <a href="rate-packages.html" class="nav-item">
                    <i data-lucide="package"></i>
                    <span>Rate Package</span>
                </a>
                <a href="rate-types.html" class="nav-item">
                    <i data-lucide="percent"></i>
                    <span>Rate Type</span>
                </a>
                <a href="banks.html" class="nav-item">
                    <i data-lucide="landmark"></i>
                    <span>Bank</span>
                </a>
                <a href="bankers.html" class="nav-item">
                    <i data-lucide="briefcase"></i>
                    <span>Bankers</span>
                </a>
                <a href="agents.html" class="nav-item">
                    <i data-lucide="users"></i>
                    <span>Agents</span>
                </a>
                <a href="enquiry.html" class="nav-item">
                    <i data-lucide="help-circle"></i>
                    <span>Enquiry</span>
                </a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <header class="header">
                <div class="header-left">
                    <button class="menu-toggle" onclick="toggleSidebar()">
                        <i data-lucide="menu"></i>
                    </button>
                    <h1 class="header-title">Dashboard</h1>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="signOut()">
                        <i data-lucide="log-out"></i>
                        Sign Out
                    </button>
                    <div class="user-profile">
                        <div class="user-avatar" id="userAvatar">A</div>
                        <div class="user-info">
                            <div class="user-name" id="userName">admin</div>
                            <div class="user-role">Super Admin</div>
                        </div>
                    </div>
                </div>
            </header>

            <div class="content-area">
                <!-- Statistics Overview -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Total Rate Packages</div>
                            <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                <i data-lucide="package"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="packagesCount">0</div>
                        <div class="stat-change positive">
                            <i data-lucide="trending-up"></i>
                            <span>Active packages</span>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Active Banks</div>
                            <div class="stat-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                                <i data-lucide="landmark"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="banksCount">0</div>
                        <div class="stat-change positive">
                            <i data-lucide="trending-up"></i>
                            <span>Partner banks</span>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Total Agents</div>
                            <div class="stat-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                                <i data-lucide="users"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="agentsCount">0</div>
                        <div class="stat-change positive">
                            <i data-lucide="check-circle"></i>
                            <span id="activeAgentsText">Active agents</span>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Total Enquiries</div>
                            <div class="stat-icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                                <i data-lucide="help-circle"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="enquiriesCount">0</div>
                        <div class="stat-change positive">
                            <i data-lucide="trending-up"></i>
                            <span id="newEnquiriesText">Customer enquiries</span>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="quick-actions">
                    <h3>Quick Actions</h3>
                    <div class="action-grid">
                        <a href="rate-packages.html?action=add" class="action-card">
                            <div class="action-icon" style="background: #4338ca;">
                                <i data-lucide="plus"></i>
                            </div>
                            <div class="action-content">
                                <h4>Add Rate Package</h4>
                                <p>Create new loan package</p>
                            </div>
                        </a>

                        <a href="rate-types.html?action=add" class="action-card">
                            <div class="action-icon" style="background: #059669;">
                                <i data-lucide="percent"></i>
                            </div>
                            <div class="action-content">
                                <h4>Add Rate Type</h4>
                                <p>Define new interest rate</p>
                            </div>
                        </a>

                        <a href="banks.html?action=add" class="action-card">
                            <div class="action-icon" style="background: #dc2626;">
                                <i data-lucide="landmark"></i>
                            </div>
                            <div class="action-content">
                                <h4>Add Bank</h4>
                                <p>Register new bank</p>
                            </div>
                        </a>

                        <a href="bankers.html?action=add" class="action-card">
                            <div class="action-icon" style="background: #7c3aed;">
                                <i data-lucide="user-plus"></i>
                            </div>
                            <div class="action-content">
                                <h4>Add Banker</h4>
                                <p>Register new banker</p>
                            </div>
                        </a>

                        <a href="agents.html?action=add" class="action-card">
                            <div class="action-icon" style="background: #ea580c;">
                                <i data-lucide="users"></i>
                            </div>
                            <div class="action-content">
                                <h4>Add Agent</h4>
                                <p>Register new agent</p>
                            </div>
                        </a>

                        <a href="enquiry.html" class="action-card">
                            <div class="action-icon" style="background: #0891b2;">
                                <i data-lucide="help-circle"></i>
                            </div>
                            <div class="action-content">
                                <h4>View Enquiries</h4>
                                <p>Manage customer inquiries</p>
                            </div>
                        </a>
                    </div>
                </div>

                <div class="overview-grid">
                    <!-- Recent Activity -->
                    <div class="recent-activity">
                        <h3>Recent Activity</h3>
                        <ul class="activity-list" id="activityList">
                            <!-- Activity items will be loaded dynamically -->
                        </ul>
                    </div>

                    <!-- System Status -->
                    <div class="recent-activity">
                        <h3>System Status</h3>
                        <ul class="activity-list">
                            <li class="activity-item">
                                <div class="activity-icon" style="background: #059669;">
                                    <i data-lucide="check-circle"></i>
                                </div>
                                <div class="activity-content">
                                    <div class="activity-title">Database Connection</div>
                                    <div class="activity-time" id="dbStatus">Checking...</div>
                                </div>
                            </li>
                            <li class="activity-item">
                                <div class="activity-icon" style="background: #059669;">
                                    <i data-lucide="check-circle"></i>
                                </div>
                                <div class="activity-content">
                                    <div class="activity-title">Authentication</div>
                                    <div class="activity-time">Active</div>
                                </div>
                            </li>
                            <li class="activity-item">
                                <div class="activity-icon" style="background: #059669;">
                                    <i data-lucide="check-circle"></i>
                                </div>
                                <div class="activity-content">
                                    <div class="activity-title">Data Sync</div>
                                    <div class="activity-time">Real-time</div>
                                </div>
                            </li>
                            <li class="activity-item">
                                <div class="activity-icon" style="background: #f59e0b;">
                                    <i data-lucide="clock"></i>
                                </div>
                                <div class="activity-content">
                                    <div class="activity-title">Last Backup</div>
                                    <div class="activity-time" id="lastBackup">Calculating...</div>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Include shared scripts -->
    <script src="config/supabase.js"></script>
    <script src="js/admin-scripts.js"></script>
    
    <script>
        // Dashboard specific functionality
        let dashboardData = {
            packages: 0,
            banks: 0,
            agents: 0,
            enquiries: 0,
            recentActivity: []
        };

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize Lucide icons
            lucide.createIcons();
            
            // Check authentication
            await checkAuthentication();
            
            // Load dashboard data
            await loadDashboardData();
            
            // Set up real-time updates
            setupRealtimeUpdates();
            
            // Show last backup time
            updateLastBackupTime();
        });

        async function checkAuthentication() {
            try {
                const { user } = await AuthService.getCurrentUser();
                if (!user) {
                    window.location.href = 'login.html';
                    return;
                }
                
                // Update user info in header
                const userName = document.getElementById('userName');
                const userAvatar = document.getElementById('userAvatar');
                
                if (userName) {
                    userName.textContent = user.email.split('@')[0] || 'admin';
                }
                if (userAvatar) {
                    userAvatar.textContent = (user.email.charAt(0) || 'A').toUpperCase();
                }
                
                document.getElementById('dbStatus').textContent = 'Connected';
                
            } catch (error) {
                console.error('Authentication check failed:', error);
                document.getElementById('dbStatus').textContent = 'Connection Error';
            }
        }

        async function loadDashboardData() {
            try {
                showLoading('Loading dashboard data...');
                
                // Load all data in parallel
                const [packagesResult, banksResult, agentsResult, enquiriesResult] = await Promise.all([
                    DatabaseService.getRatePackages(),
                    DatabaseService.getBanks(),
                    DatabaseService.getAgents(),
                    DatabaseService.getEnquiries()
                ]);

                // Update statistics
                updateStatistics({
                    packages: packagesResult.success ? packagesResult.data.length : 0,
                    banks: banksResult.success ? banksResult.data.length : 0,
                    agents: agentsResult.success ? agentsResult.data.length : 0,
                    enquiries: enquiriesResult.success ? enquiriesResult.data.length : 0
                });

                // Create recent activity
                const recentActivity = [];
                
                if (enquiriesResult.success && enquiriesResult.data.length > 0) {
                    const latestEnquiry = enquiriesResult.data[0];
                    recentActivity.push({
                        icon: 'help-circle',
                        color: '#7c3aed',
                        title: `New enquiry from ${latestEnquiry.customer_name}`,
                        time: formatRelativeTime(latestEnquiry.created_at)
                    });
                }

                if (packagesResult.success && packagesResult.data.length > 0) {
                    const latestPackage = packagesResult.data[0];
                    recentActivity.push({
                        icon: 'package',
                        color: '#4338ca',
                        title: `New rate package added for ${latestPackage.bank_name}`,
                        time: formatRelativeTime(latestPackage.created_at)
                    });
                }

                if (agentsResult.success && agentsResult.data.length > 0) {
                    const activeAgents = agentsResult.data.filter(agent => agent.status === 'Active');
                    if (activeAgents.length > 0) {
                        const latestAgent = activeAgents[0];
                        recentActivity.push({
                            icon: 'user-plus',
                            color: '#059669',
                            title: `Agent ${latestAgent.name} is active`,
                            time: formatRelativeTime(latestAgent.created_at)
                        });
                    }
                }

                updateRecentActivity(recentActivity);
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showNotification('Failed to load dashboard data', 'error');
            } finally {
                hideLoading();
            }
        }

        function updateStatistics(data) {
            animateCounter('packagesCount', data.packages);
            animateCounter('banksCount', data.banks);
            animateCounter('agentsCount', data.agents);
            animateCounter('enquiriesCount', data.enquiries);
            
            // Update status text
            const activeAgentsText = document.getElementById('activeAgentsText');
            const newEnquiriesText = document.getElementById('newEnquiriesText');
            
            if (activeAgentsText) {
                activeAgentsText.textContent = `${data.agents} total agents`;
            }
            if (newEnquiriesText) {
                newEnquiriesText.textContent = `${data.enquiries} total enquiries`;
            }
        }

        function animateCounter(elementId, targetValue) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            let currentValue = 0;
            const increment = Math.ceil(targetValue / 30);
            const timer = setInterval(() => {
                currentValue += increment;
                if (currentValue >= targetValue) {
                    element.textContent = targetValue;
                    clearInterval(timer);
                } else {
                    element.textContent = currentValue;
                }
            }, 50);
        }

        function updateRecentActivity(activities) {
            const activityList = document.getElementById('activityList');
            if (!activityList) return;
            
            if (activities.length === 0) {
                activityList.innerHTML = `
                    <li class="activity-item">
                        <div class="activity-icon" style="background: #64748b;">
                            <i data-lucide="info"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">No recent activity</div>
                            <div class="activity-time">Start by adding some data</div>
                        </div>
                    </li>
                `;
            } else {
                activityList.innerHTML = activities.map(activity => `
                    <li class="activity-item">
                        <div class="activity-icon" style="background: ${activity.color};">
                            <i data-lucide="${activity.icon}"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">${activity.title}</div>
                            <div class="activity-time">${activity.time}</div>
                        </div>
                    </li>
                `).join('');
            }
            
            // Re-initialize icons
            lucide.createIcons();
        }

        function setupRealtimeUpdates() {
            // This would set up real-time subscriptions to database changes
            // For now, we'll refresh data every 30 seconds
            setInterval(async () => {
                await loadDashboardData();
            }, 30000);
        }

        function updateLastBackupTime() {
            const lastBackup = document.getElementById('lastBackup');
            if (lastBackup) {
                const now = new Date();
                const backupTime = new Date(now.getTime() - (6 * 60 * 60 * 1000)); // 6 hours ago
                lastBackup.textContent = formatRelativeTime(backupTime.toISOString());
            }
        }

        function formatRelativeTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return 'Just now';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} minutes ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)} hours ago`;
            return `${Math.floor(diffInSeconds / 86400)} days ago`;
        }

        // Sign out functionality
        async function signOut() {
            if (confirm('Are you sure you want to sign out?')) {
                try {
                    showLoading('Signing out...');
                    const result = await AuthService.signOut();
                    
                    if (result.success) {
                        showNotification('Signed out successfully', 'success');
                        setTimeout(() => {
                            window.location.href = 'login.html';
                        }, 1000);
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    console.error('Sign out error:', error);
                    showNotification('Failed to sign out: ' + error.message, 'error');
                } finally {
                    hideLoading();
                }
            }
        }

        // Mobile sidebar toggle
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            
            if (sidebar) {
                sidebar.classList.toggle('mobile-open');
            }
            if (overlay) {
                overlay.classList.toggle('active');
            }
        }

        // Handle window resize
        window.addEventListener('resize', function() {
            if (window.innerWidth > 768) {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('overlay');
                if (sidebar) sidebar.classList.remove('mobile-open');
                if (overlay) overlay.classList.remove('active');
            }
        });
    </script>
</body>
</html>
