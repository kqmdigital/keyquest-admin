<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recommended Packages - Keyquest Mortgage Admin</title>
    <link rel="stylesheet" href="css/admin-styles.css">
    <!-- Print CSS to remove headers and footers -->
    <style>
        @media print {
            @page {
                margin: 0.5in;
                size: A4;
            }
            
            body {
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }
    </style>
    <!-- Required Scripts in correct order -->
    <!-- External Scripts in proper order -->
    <script src="js/lucide.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.7/dist/umd/supabase.js"></script>
    
    <script src="js/security-utils.js"></script>
    <script src="config/supabase.js"></script>
    <script src="js/admin-scripts.js"></script>

        <link rel="stylesheet" href="css/recommended-packages.css">
</head>   

<body>

    
  <body>
    <div class="admin-container">
        <!-- Top Navigation -->
        <nav class="top-nav" id="topNav">
            <div class="nav-container">
                <div class="nav-left">
                    <a href="index.html" class="logo">
                        <img src="https://ik.imagekit.io/hst9jooux/KEYQUEST%20LOGO%20(Black%20Text%20Horizontal).png?updatedAt=1753262438682" alt="Company Logo" class="logo-image">
                        
                    </a>
                    <div class="nav-menu" id="navMenu">
                        <a href="index.html" class="nav-item">
                            <i data-lucide="layout-dashboard"></i>
                            <span>Dashboard</span>
                        </a>
                        <a href="rate-packages.html" class="nav-item">
                            <i data-lucide="package"></i>
                            <span>Rate Package</span>
                        </a>
                        <a href="rate-types.html" class="nav-item">
                            <i data-lucide="percent"></i>
                            <span>Rate Type</span>
                        </a>
                        <a href="banks.html" class="nav-item">
                            <i data-lucide="landmark"></i>
                            <span>Bank</span>
                        </a>
                        <a href="bankers.html" class="nav-item">
                            <i data-lucide="briefcase"></i>
                            <span>Bankers</span>
                        </a>
                         <a href="admin-users.html" class="nav-item">
                            <i data-lucide="shield-check"></i>
                            <span>Staff</span>
                        </a>
                        <a href="recommended-packages.html" class="nav-item active">
                            <i data-lucide="star"></i>
                            <span>Recommended</span>
                        </a>
                    </div>
                </div>
                <div class="nav-right">
                    <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
                        <i data-lucide="menu"></i>
                    </button>
                    <button class="btn btn-secondary" onclick="confirmSignOut()">
                        <i data-lucide="log-out"></i>
                        <span>Sign Out</span>
                    </button>
                    <div class="user-profile">
                        <div class="user-avatar" id="userAvatar">A</div>
                        <div class="user-info">
                            <div class="user-name" id="userName">admin</div>
                            <div class="user-role">Super Admin</div>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="main-content">           
            <div class="content-area">
                
                <!-- Loan Type Tabs -->
                <div class="loan-type-tabs">
                    <button class="loan-tab active" onclick="selectLoanType('New Home Loan')" data-loan-type="New Home Loan">
                        <i data-lucide="home"></i>
                        New Home Loan
                    </button>
                    <button class="loan-tab" onclick="selectLoanType('Refinancing Home Loan')" data-loan-type="Refinancing Home Loan">
                        <i data-lucide="repeat"></i>
                        Refinancing Home Loan
                    </button>
                    <button class="loan-tab" onclick="selectLoanType('Commercial/Industrial')" data-loan-type="Commercial/Industrial">
                        <i data-lucide="briefcase"></i>
                        Commercial/Industrial
                    </button>
                </div>

                
<!-- Enhanced Search Section with Additional Filters -->
<div class="search-section">
    <form class="search-form" id="searchForm" onsubmit="searchPackages(event)">
        <!-- Row 1: Basic Filters -->
        <div class="form-group">
            <label class="form-label">Property Type</label>
            <select class="form-select" id="propertyType">
                <option value="">Select Property Type</option>
                <option value="Private Property">Private Property</option>
                <option value="HDB">HDB</option>
                <option value="EC">EC</option>
                <option value="Commercial">Commercial</option>
                <option value="Industrial">Industrial</option>
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label">Property Status</label>
            <select class="form-select" id="propertyStatus">
                <option value="">Select Property Status</option>
                <option value="Completed">Completed</option>
                <option value="BUC">BUC</option>
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label">Buy Under</label>
            <select class="form-select" id="buyUnder">
                <option value="">Select Buy Under</option>
                <option value="Individual Name">Individual Name</option>
                <option value="Company Operating">Company Operating</option>
                <option value="Company Investment">Company Investment</option>
            </select>
        </div>
        
        <!-- Row 2: Financial Parameters -->
        <div class="form-group">
            <label class="form-label">Loan Amount ($)</label>
            <input type="number" class="form-input" id="loanAmount" placeholder="500,000" min="0" step="1000">
        </div>
        
        <div class="form-group">
    <label class="form-label">Loan Tenure (Years)</label>
    <input type="number" class="form-input" id="loanTenure" placeholder="25" min="1" max="50" step="1">
</div>

<!-- NEW: Existing Interest Rate for Refinancing -->
<div class="form-group hidden" id="existingRateGroup">
    <label class="form-label">Current Interest Rate (%)</label>
    <input type="number" class="form-input" id="existingInterestRate" placeholder="3.50" min="0" max="20" step="0.01">
    
</div>
        <div class="form-group hidden" id="existingBankGroup">
    <label class="form-label">Current Bank</label>
    <select class="form-select" id="existingBank">
        <option value="">Select Current Bank</option>
        <option value="CIMB">CIMB</option>
        <option value="OCBC">OCBC</option>
        <option value="UOB">UOB</option>
        <option value="DBS">DBS</option>
        <option value="MBB">MBB</option>
        <option value="SCB">SCB</option>
        <option value="HSBC">HSBC</option>
        <option value="SBI">SBI</option>
        <option value="BOC">BOC</option>
        <option value="HLF">HLF</option>
        <option value="SF">SF</option>
        <option value="RHB">RHB</option>
        <option value="SIF">SIF</option>
        <option value="Citibank">Citibank</option>
    </select>
   </div>

        <!-- Row 3: New Enhanced Filters -->
       <div class="form-group">
    <label class="form-label">Bank (Multiple Selection)</label>
    <div class="multi-select-filter" id="bankMultiSelect">
        <button type="button" class="filter-select-btn" onclick="toggleMultiSelect('bankMultiSelect')">
            <span id="bankSelected">Select Banks</span>
            <i data-lucide="chevron-down"></i>
        </button>
        <div class="multi-select-dropdown">
            <label data-all="true">
                <input type="checkbox" id="bankAll" onchange="selectAllBanks()">
                Select All Banks
            </label>
            <label><input type="checkbox" value="CIMB"> CIMB</label>
            <label><input type="checkbox" value="OCBC"> OCBC</label>
            <label><input type="checkbox" value="UOB"> UOB</label>
            <label><input type="checkbox" value="DBS"> DBS</label>
            <label><input type="checkbox" value="MBB"> MBB</label>
            <label><input type="checkbox" value="SCB"> SCB</label>
            <label><input type="checkbox" value="HSBC"> HSBC</label>
            <label><input type="checkbox" value="SBI"> SBI</label>
            <label><input type="checkbox" value="BOC"> BOC</label>
            <label><input type="checkbox" value="HLF"> HLF</label>
            <label><input type="checkbox" value="SF"> SF</label>
            <label><input type="checkbox" value="RHB"> RHB</label>
            <label><input type="checkbox" value="SIF"> SIF</label>
            <label><input type="checkbox" value="Citibank"> Citibank</label>
        </div>
    </div>
</div>
        
        <div class="form-group">
            <label class="form-label">Rate Type</label>
            <select class="form-select" id="rateTypeFilter">
                <option value="">Select Rate Type</option>
                <option value="Fixed">Fixed</option>
                <option value="Floating">Floating</option>
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label">Lock-in Period</label>
            <select class="form-select" id="lockPeriodFilter">
                <option value="">Select Lock Period</option>
                <option value="0 Year">0 Year</option>
                <option value="1 Year">1 Year</option>
                <option value="2 Years">2 Years</option>
                <option value="3 Years">3 Years</option>
                <option value="4 Years">4 Years</option>
                <option value="5 Years">5 Years</option>
                <option value="6 Years">6 Years</option>
                <option value="7 Years">7 Years</option>
                <option value="8 Years">8 Years</option>
                <option value="9 Years">9 Years</option>
                <option value="10 Years">10 Years</option>
            </select>
        </div>

        <!-- Row 4: Package Features -->
        <div class="form-group">
    <label class="form-label">Package Features (Multiple Selection)</label>
    <div class="multi-select-filter" id="featuresMultiSelect">
        <button type="button" class="filter-select-btn" onclick="toggleMultiSelect('featuresMultiSelect')">
            <span id="featuresSelected">Select Features</span>
            <i data-lucide="chevron-down"></i>
        </button>
        <div class="multi-select-dropdown">
            <label data-all="true">
                <input type="checkbox" id="featuresAll" onchange="selectAllFeatures()">
                Select All Features
            </label>
            <label><input type="checkbox" value="legal_fee_subsidy"> Legal Fee Subsidy</label>
            <label><input type="checkbox" value="cash_rebate"> Cash Rebate</label>
            <label><input type="checkbox" value="free_package_conversion_12m"> Free Conversion (12M)</label>
            <label><input type="checkbox" value="free_package_conversion_24m"> Free Conversion (24M)</label>
            <label><input type="checkbox" value="valuation_subsidy"> Valuation Subsidy</label>
            <label><input type="checkbox" value="partial_repayment"> Partial Repayment</label>
            <label><input type="checkbox" value="waiver_due_to_sales"> Waiver Due to Sales</label>
        </div>
    </div>
</div>

        
        
        <div class="form-group">
            <button type="button" class="search-button secondary-button" onclick="clearAllFilters()">
                <i data-lucide="rotate-ccw"></i>
                Clear All Filters
            </button>
        </div>
    </form>
</div>

                <!-- Results Section -->
              <div class="results-section hidden" id="resultsContainer">
    <div class="results-header">
        <div class="results-title">
            <i data-lucide="trending-up"></i>
            Recommended Packages
            <span class="results-count" id="resultsCount">0</span>
        </div>
        <div class="results-actions">
            <!-- Move options to the left -->
            <div class="report-options">
                <div class="option-group">
                    <label for="clientName" class="option-label">Client Name:</label>
                    <input type="text" id="clientName" class="client-name-input" placeholder="Enter client name for report" />
                </div>
                <div class="option-group">
                    <input type="checkbox" id="hideBankNames" class="option-checkbox">
                    <label for="hideBankNames" class="option-checkbox-label">Hide Bank Names in Report</label>
                </div>
            </div>

            <!-- Buttons aligned to the right -->
            <div class="action-buttons">
                <button class="download-btn" onclick="generateProfessionalReport()">
                    <i data-lucide="file-text"></i>
                    Generate Report
                </button>
                <button class="download-btn csv-export" onclick="exportCSV()">
                    <i data-lucide="download"></i>
                    Export CSV
                </button>
                <button class="download-btn secondary-button" onclick="toggleAllSelections()">
                    <i data-lucide="check-square"></i>
                    Toggle All
                </button>
            </div>
        </div>
    </div>
</div>
                    
                    <div class="packages-container" id="packagesContainer">
                        <!-- Package cards will be dynamically inserted here -->
                    </div>
                    
                    <div class="no-results" id="noResults">
                        <i data-lucide="search"></i>
                        <h3>No Matching Packages Found</h3>
                        <p>Try adjusting your search criteria to find more suitable options.</p>
                        <button class="btn btn-primary" onclick="clearFilters()">
                            <i data-lucide="rotate-ccw"></i>
                            Reset Search
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
        <div class="loading-spinner"></div>
        <span class="loading-message">Finding the best packages for you...</span>
    </div>
</div>

    <script>
        // ===================================
        // GLOBAL VARIABLES - PRESERVED FROM ORIGINAL
        // ===================================
        let allPackages = [];
        let rateTypes = [];
        let currentLoanType = 'New Home Loan';
        let currentResults = [];
        let searchCriteria = {};

        // ===================================
        // INITIALIZATION - PRESERVED FROM ORIGINAL
        // ===================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 Recommended Packages page loading...');
            await checkAuthentication();
            setupEventListeners();
            loadData();
        });

        // ===================================
        // AUTHENTICATION CHECK - PRESERVED FROM ORIGINAL
        // ===================================
        async function checkAuthentication() {
            try {
                if (typeof AuthService === 'undefined') {
                    console.error('AuthService not available');
                    window.location.href = 'login.html';
                    return;
                }

                const { success, user } = await AuthService.getCurrentUser();
                
                if (!success || !user) {
                    console.warn('❌ No authenticated user found, redirecting to login');
                    window.location.href = 'login.html';
                    return;
                }

                // Update user display
                if (user.name) {
                    document.getElementById('userName').textContent = user.name;
                    document.getElementById('userAvatar').textContent = user.name.charAt(0).toUpperCase();
                }
            } catch (error) {
                console.error('💥 Auth check failed:', error);
                window.location.href = 'login.html';
            }
        }

        function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}
        
function setupEventListeners() {
    // Initialize Lucide icons
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }

    // Existing event listeners...
    document.addEventListener('click', function(event) {
        const userDropdown = document.getElementById('userDropdown');
        const userInfo = document.querySelector('.user-info');
        
        if (userInfo && !userInfo.contains(event.target) && userDropdown) {
            userDropdown.style.display = 'none';
        }
    });

    const loanTabs = document.querySelectorAll('.loan-tab');
    loanTabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const loanType = this.getAttribute('data-loan-type');
            selectLoanType(loanType);
        });
    });

    const searchForm = document.getElementById('searchForm');
    if (searchForm) {
        searchForm.addEventListener('submit', searchPackages);
    }

    // Enhanced live filtering event listeners - INCLUDING NEW FILTERS
    const filterInputs = [
        'propertyType',
        'propertyStatus', 
        'buyUnder',
        'loanAmount',
        'loanTenure',
        'existingInterestRate',
        'rateTypeFilter',
        'lockPeriodFilter'
    ];

    filterInputs.forEach(inputId => {
        const element = document.getElementById(inputId);
        if (element) {
            element.addEventListener('input', debounce(performLiveFilter, 300));
            element.addEventListener('change', performLiveFilter);
        }
    });

    // Add event listeners for multi-select changes
    document.addEventListener('change', function(event) {
        if (event.target.matches('#bankMultiSelect input[type="checkbox"]:not(#bankAll)')) {
            updateBankDisplay();
            performLiveFilter();
        }
        if (event.target.matches('#featuresMultiSelect input[type="checkbox"]:not(#featuresAll)')) {
            updateFeaturesDisplay();
            performLiveFilter();
        }
    });
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', function(event) {
        if (!event.target.closest('.multi-select-filter')) {
            document.querySelectorAll('.multi-select-filter').forEach(filter => {
                filter.classList.remove('open');
                filter.querySelector('.multi-select-dropdown').classList.remove('open');
            });
        }
    });
    
    // Add existing bank filter listener
    const existingBankSelect = document.getElementById('existingBank');
    if (existingBankSelect) {
        existingBankSelect.addEventListener('change', performLiveFilter);
    }

    console.log('✅ Enhanced event listeners set up successfully');
}

// New function to clear all filters
function clearAllFilters() {
    // Clear existing filters
    document.getElementById('propertyType').value = '';
    document.getElementById('propertyStatus').value = '';
    document.getElementById('buyUnder').value = '';
    document.getElementById('loanAmount').value = '';
    document.getElementById('loanTenure').value = '';
    document.getElementById('existingInterestRate').value = '';
    document.getElementById('existingBank').value = '';
    document.getElementById('rateTypeFilter').value = '';
    document.getElementById('lockPeriodFilter').value = '';
    
    // Clear multi-select banks
    document.querySelectorAll('#bankMultiSelect input[type="checkbox"]').forEach(cb => cb.checked = false);
    document.getElementById('bankSelected').textContent = 'Select Banks';
    
    // Clear multi-select features
    document.querySelectorAll('#featuresMultiSelect input[type="checkbox"]').forEach(cb => cb.checked = false);
    document.getElementById('featuresSelected').textContent = 'Select Features';
    
    // Clear results
    clearResults();
    searchCriteria = {};
    
    showNotification('All filters cleared', 'info');
}

        // ===================================
        // LOAN TYPE SELECTION - PRESERVED FROM ORIGINAL
        // ===================================
        function selectLoanType(loanType) {
    currentLoanType = loanType;
    
    // Update tab appearance
    document.querySelectorAll('.loan-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.getAttribute('data-loan-type') === loanType) {
            tab.classList.add('active');
        }
    });
    
    // Show/hide existing rate input and existing bank for refinancing
    const existingRateGroup = document.getElementById('existingRateGroup');
    const existingBankGroup = document.getElementById('existingBankGroup');
    
    if (loanType === 'Refinancing Home Loan') {
        if (existingRateGroup) existingRateGroup.classList.remove('hidden');
        if (existingBankGroup) existingBankGroup.classList.remove('hidden');
    } else {
        if (existingRateGroup) existingRateGroup.classList.add('hidden');
        if (existingBankGroup) existingBankGroup.classList.add('hidden');
        document.getElementById('existingInterestRate').value = '';
        document.getElementById('existingBank').value = '';
    }
    
    // Clear previous results
    clearResults();
    
    console.log(`📋 Selected loan type: ${loanType}`);
}

        // Multi-select functionality for banks
function toggleMultiSelect(selectId) {
    const container = document.getElementById(selectId);
    const dropdown = container.querySelector('.multi-select-dropdown');
    const isOpen = container.classList.contains('open');
    
    // Close all other dropdowns first
    document.querySelectorAll('.multi-select-filter').forEach(filter => {
        filter.classList.remove('open');
        filter.querySelector('.multi-select-dropdown').classList.remove('open');
    });
    
    if (!isOpen) {
        container.classList.add('open');
        dropdown.classList.add('open');
        
        // Ensure dropdown is positioned correctly
        const rect = container.getBoundingClientRect();
        const viewportHeight = window.innerHeight;
        const dropdownHeight = 250; // max-height from CSS
        
        // Check if there's enough space below
        if (rect.bottom + dropdownHeight > viewportHeight) {
            // Not enough space below, show above instead
            dropdown.style.top = 'auto';
            dropdown.style.bottom = '100%';
            dropdown.style.marginTop = '0';
            dropdown.style.marginBottom = '4px';
        } else {
            // Enough space below, show normally
            dropdown.style.top = '100%';
            dropdown.style.bottom = 'auto';
            dropdown.style.marginTop = '4px';
            dropdown.style.marginBottom = '0';
        }
    }
}
        
function selectAllBanks() {
    const allCheckbox = document.getElementById('bankAll');
    const checkboxes = document.querySelectorAll('#bankMultiSelect input[type="checkbox"]:not(#bankAll)');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = allCheckbox.checked;
    });
    
    updateBankDisplay();
    performLiveFilter();
}

function selectAllFeatures() {
    const allCheckbox = document.getElementById('featuresAll');
    const checkboxes = document.querySelectorAll('#featuresMultiSelect input[type="checkbox"]:not(#featuresAll)');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = allCheckbox.checked;
    });
    
    updateFeaturesDisplay();
    performLiveFilter();
}

function updateBankDisplay() {
    const checkboxes = document.querySelectorAll('#bankMultiSelect input[type="checkbox"]:checked:not(#bankAll)');
    const selectedText = document.getElementById('bankSelected');
    
    if (checkboxes.length === 0) {
        selectedText.textContent = 'Select Banks';
    } else if (checkboxes.length === 1) {
        selectedText.textContent = checkboxes[0].value;
    } else {
        selectedText.textContent = `${checkboxes.length} banks selected`;
    }
}

function updateFeaturesDisplay() {
    const checkboxes = document.querySelectorAll('#featuresMultiSelect input[type="checkbox"]:checked:not(#featuresAll)');
    const selectedText = document.getElementById('featuresSelected');
    
    if (checkboxes.length === 0) {
        selectedText.textContent = 'Select Features';
    } else if (checkboxes.length === 1) {
        const value = checkboxes[0].value;
        selectedText.textContent = value.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    } else {
        selectedText.textContent = `${checkboxes.length} features selected`;
    }
}

function getSelectedBanks() {
    const checkboxes = document.querySelectorAll('#bankMultiSelect input[type="checkbox"]:checked:not(#bankAll)');
    return Array.from(checkboxes).map(cb => cb.value);
}

function getSelectedFeatures() {
    const checkboxes = document.querySelectorAll('#featuresMultiSelect input[type="checkbox"]:checked:not(#featuresAll)');
    return Array.from(checkboxes).map(cb => cb.value);
}

        // ===================================
        // DATA LOADING FUNCTIONS - PRESERVED FROM ORIGINAL
        // ===================================
        async function loadData() {
            try {
                showLoading('Loading packages and rate types...');
                
                // Load packages and rate types in parallel
                const [packagesResult, rateTypesResult] = await Promise.all([
                    supabaseClient.from('rate_packages').select('*'),
                    supabaseClient.from('rate_types').select('*')
                ]);

                if (packagesResult.error) throw packagesResult.error;
                if (rateTypesResult.error) throw rateTypesResult.error;

                allPackages = packagesResult.data || [];
                rateTypes = rateTypesResult.data || [];

                console.log(`📦 Loaded ${allPackages.length} packages and ${rateTypes.length} rate types`);
                
            } catch (error) {
                console.error('💥 Error loading data:', error);
                showNotification('Failed to load data: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // ===================================
        // SEARCH FUNCTIONS - PRESERVED FROM ORIGINAL  
        // ===================================
        // Updated searchPackages function
async function searchPackages(event) {
    if (event) event.preventDefault();
    
    try {
        showLoading('Searching for the best packages...');
        
        // Get form values - INCLUDING NEW MULTI-SELECT FILTERS
        const selectedBanks = getSelectedBanks();
        const selectedFeatures = getSelectedFeatures();
        const existingBank = document.getElementById('existingBank').value;
        
        const formData = {
            propertyType: document.getElementById('propertyType').value,
            propertyStatus: document.getElementById('propertyStatus').value,
            buyUnder: document.getElementById('buyUnder').value,
            loanAmount: parseFloat(document.getElementById('loanAmount').value) || 0,
            loanTenure: parseInt(document.getElementById('loanTenure').value) || 25,
            existingInterestRate: parseFloat(document.getElementById('existingInterestRate').value) || 0,
            existingBank: existingBank,
            selectedBanks: selectedBanks,
            selectedFeatures: selectedFeatures,
            rateTypeFilter: document.getElementById('rateTypeFilter').value,
            lockPeriodFilter: document.getElementById('lockPeriodFilter').value
        };

        searchCriteria = { ...formData, loanType: currentLoanType };
        
        // Debug: Log search criteria
        console.log('🔍 searchCriteria set in searchPackages:', searchCriteria);
        console.log('💰 Loan Amount captured:', searchCriteria.loanAmount);
        console.log('📅 Loan Tenure captured:', searchCriteria.loanTenure);
        
        // Enhanced filter logic
        let filteredPackages = allPackages.filter(pkg => {
            // Existing filters
            if (pkg.loan_type !== currentLoanType) return false;
            if (formData.propertyType && pkg.property_type !== formData.propertyType) return false;
            if (formData.propertyStatus && pkg.property_status !== formData.propertyStatus) return false;
            if (formData.buyUnder && pkg.buy_under !== formData.buyUnder) return false;
            if (formData.loanAmount > 0 && pkg.minimum_loan_size && formData.loanAmount < pkg.minimum_loan_size) return false;
            
            // NEW: Exclude existing bank for refinancing
            if (currentLoanType === 'Refinancing Home Loan' && formData.existingBank && pkg.bank_name === formData.existingBank) {
                return false;
            }
            
            // NEW: Multi-select Bank filter
            if (formData.selectedBanks.length > 0 && !formData.selectedBanks.includes(pkg.bank_name)) {
                return false;
            }
            
            // Rate Type filter  
            if (formData.rateTypeFilter && pkg.rate_type_category !== formData.rateTypeFilter) return false;
            
            // Lock-in Period filter
            if (formData.lockPeriodFilter) {
                const pkgLockPeriod = pkg.lock_period || '0 Year';
                if (pkgLockPeriod !== formData.lockPeriodFilter) return false;
            }
            
            // NEW: Multi-select Package Features filter
            if (formData.selectedFeatures.length > 0) {
                const hasAnyFeature = formData.selectedFeatures.some(featureField => {
                    const featureValue = pkg[featureField];
                    return featureValue === 'true' || featureValue === true;
                });
                if (!hasAnyFeature) return false;
            }
            
            return true;
        });

        // Calculate metrics for each package
filteredPackages = filteredPackages.map(pkg => {
    const avgFirst2Years = calculateAverageFirst2Years(pkg);
    const monthlyInstallment = calculateMonthlyInstallment(formData.loanAmount, formData.loanTenure, avgFirst2Years);
    
    // Calculate savings for refinancing based on LOCK-IN PERIOD
    let monthlySavings = 0;
    let totalSavings = 0;
    if (currentLoanType === 'Refinancing Home Loan' && formData.existingInterestRate) {
        monthlySavings = calculateMonthlySavings(formData.loanAmount, formData.loanTenure, formData.existingInterestRate, avgFirst2Years);
        totalSavings = calculateTotalSavings(monthlySavings, pkg.lock_period); // Use lock_period instead of tenure
    }
    
    return {
        ...pkg,
        avgFirst2Years,
        monthlyInstallment,
        monthlySavings,
        totalSavings,
        lockInYears: parseLockInPeriod(pkg.lock_period), // Add for display
        selected: true // Default to selected for report
    };
});

        // Sort by average rate (ascending - best rates first)
        filteredPackages.sort((a, b) => a.avgFirst2Years - b.avgFirst2Years);

        currentResults = filteredPackages;
        displayResults(filteredPackages, true);
        
        console.log(`🔍 Found ${filteredPackages.length} matching packages`);
        
    } catch (error) {
        console.error('💥 Search error:', error);
        showNotification('Search failed: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}

function performLiveFilter() {
    console.log('🔄 Live filter started');
    
    if (!allPackages.length || !currentLoanType) {
        console.log('❌ Early return - no packages or loan type');
        return;
    }

    try {
        const selectedBanks = getSelectedBanks();
        const selectedFeatures = getSelectedFeatures();
        const existingBank = document.getElementById('existingBank').value;
        
        const formData = {
            propertyType: document.getElementById('propertyType').value,
            propertyStatus: document.getElementById('propertyStatus').value,
            buyUnder: document.getElementById('buyUnder').value,
            loanAmount: parseFloat(document.getElementById('loanAmount').value) || 0,
            loanTenure: parseInt(document.getElementById('loanTenure').value) || 25,
            existingInterestRate: parseFloat(document.getElementById('existingInterestRate').value) || 0,
            existingBank: existingBank,
            selectedBanks: selectedBanks,
            selectedFeatures: selectedFeatures,
            rateTypeFilter: document.getElementById('rateTypeFilter').value,
            lockPeriodFilter: document.getElementById('lockPeriodFilter').value
        };

        // Check if any filters are applied (updated to handle arrays properly)
        const hasFilters = Object.values(formData).some(value => {
            if (Array.isArray(value)) {
                return value.length > 0;
            }
            return value !== '' && value !== 0;
        });

        if (!hasFilters) {
            clearResults();
            return;
        }

        // Apply filtering logic
        let filteredPackages = allPackages.filter(pkg => {
            // Basic loan type filter
            if (pkg.loan_type !== currentLoanType) return false;
            
            // Property type filter
            if (formData.propertyType && pkg.property_type !== formData.propertyType) return false;
            
            // Property status filter
            if (formData.propertyStatus && pkg.property_status !== formData.propertyStatus) return false;
            
            // Buy under filter
            if (formData.buyUnder && pkg.buy_under !== formData.buyUnder) return false;
            
            // Minimum loan amount filter
            if (formData.loanAmount > 0 && pkg.minimum_loan_size && formData.loanAmount < pkg.minimum_loan_size) return false;
            
            // NEW: Exclude existing bank for refinancing
            if (currentLoanType === 'Refinancing Home Loan' && formData.existingBank && pkg.bank_name === formData.existingBank) {
                return false;
            }
            
            // NEW: Multi-select Bank filter
            if (formData.selectedBanks.length > 0 && !formData.selectedBanks.includes(pkg.bank_name)) {
                return false;
            }
            
            // Rate Type filter  
            if (formData.rateTypeFilter && pkg.rate_type_category !== formData.rateTypeFilter) return false;
            
            // Lock-in Period filter
            if (formData.lockPeriodFilter) {
                const pkgLockPeriod = pkg.lock_period || '0 Year';
                if (pkgLockPeriod !== formData.lockPeriodFilter) return false;
            }
            
            // NEW: Multi-select Package Features filter
            if (formData.selectedFeatures.length > 0) {
                const hasAnyFeature = formData.selectedFeatures.some(featureField => {
                    const featureValue = pkg[featureField];
                    return featureValue === 'true' || featureValue === true;
                });
                if (!hasAnyFeature) return false;
            }
            
            return true;
        });

        // Calculate metrics for each package (same as searchPackages)
        filteredPackages = filteredPackages.map(pkg => {
            const avgFirst2Years = calculateAverageFirst2Years(pkg);
            const monthlyInstallment = calculateMonthlyInstallment(formData.loanAmount, formData.loanTenure, avgFirst2Years);
            
            // Calculate savings for refinancing based on LOCK-IN PERIOD
            let monthlySavings = 0;
            let totalSavings = 0;
            if (currentLoanType === 'Refinancing Home Loan' && formData.existingInterestRate) {
                monthlySavings = calculateMonthlySavings(formData.loanAmount, formData.loanTenure, formData.existingInterestRate, avgFirst2Years);
                totalSavings = calculateTotalSavings(monthlySavings, pkg.lock_period);
            }
            
            return {
                ...pkg,
                avgFirst2Years,
                monthlyInstallment,
                monthlySavings,
                totalSavings,
                lockInYears: parseLockInPeriod(pkg.lock_period),
                selected: true // Default to selected for report
            };
        });

        // Sort by average rate (ascending - best rates first)
        filteredPackages.sort((a, b) => a.avgFirst2Years - b.avgFirst2Years);

        currentResults = filteredPackages;
        displayResults(filteredPackages, false); // false = don't scroll to results for live filtering
        
        console.log(`🔍 Live filter found ${filteredPackages.length} matching packages`);
        
    } catch (error) {
        console.error('Live filter error:', error);
    }
}

        function clearResults() {
    const resultsContainer = document.getElementById('resultsContainer');
    if (resultsContainer) {
        resultsContainer.classList.add('hidden');
    }
    currentResults = [];
}
        // ===================================
        // CALCULATION FUNCTIONS - PRESERVED FROM ORIGINAL
        // ===================================
        function calculateAverageFirst2Years(pkg) {
            const year1Rate = calculateInterestRate(pkg, 1);
            const year2Rate = calculateInterestRate(pkg, 2);
            
            if (year1Rate === 0 && year2Rate === 0) return 0;
            if (year1Rate === 0) return year2Rate;
            if (year2Rate === 0) return year1Rate;
            
            return (year1Rate + year2Rate) / 2;
        }

        function calculateMonthlyInstallment(principal, tenureYears, annualRate) {
            if (!principal || !tenureYears || !annualRate) return 0;
            
            const monthlyRate = annualRate / 100 / 12;
            const totalMonths = tenureYears * 12;
            
            if (monthlyRate === 0) {
                return principal / totalMonths;
            }
            
            const monthlyPayment = principal * (monthlyRate * Math.pow(1 + monthlyRate, totalMonths)) / 
                                 (Math.pow(1 + monthlyRate, totalMonths) - 1);
            
            return monthlyPayment;
        }

        // Calculate numeric interest rate for a given year
        function calculateNumericRate(pkg, year) {
            let rateType, operator, value;
            
            if (year === 'thereafter') {
                rateType = pkg.thereafter_rate_type;
                operator = pkg.thereafter_operator;
                value = pkg.thereafter_value;
            } else {
                rateType = pkg[`year${year}_rate_type`];
                operator = pkg[`year${year}_operator`];
                value = pkg[`year${year}_value`];
            }
            
            // If no data for this year, use thereafter rate
            if (!rateType || value === null || value === undefined) {
                if (pkg.thereafter_rate_type && pkg.thereafter_value !== null && pkg.thereafter_value !== undefined) {
                    return calculateNumericRate(pkg, 'thereafter');
                }
                return 0;
            }
            
            // Calculate numeric rate
            if (rateType === 'FIXED') {
                return parseFloat(value) || 0;
            } else {
                // Find the reference rate
                const referenceRate = rateTypes.find(rt => rt.rate_type === rateType);
                if (!referenceRate) {
                    console.warn(`❌ Reference rate type not found: ${rateType}`);
                    return 0;
                }
                
                const referenceRateValue = parseFloat(referenceRate.rate_value) || 0;
                const spreadValue = parseFloat(value) || 0;
                
                return operator === '+' ? 
                    referenceRateValue + spreadValue : 
                    referenceRateValue - spreadValue;
            }
        }

        // Calculate total interest cost over entire loan tenure
        function calculateTotalInterestCost(pkg, loanAmount, tenureYears) {
            if (!pkg || !loanAmount || !tenureYears) return 0;
            
            // Use simplified calculation: average rate over tenure
            let totalRate = 0;
            let validYears = 0;
            
            // Calculate average rate for first 5 years
            for (let year = 1; year <= Math.min(5, tenureYears); year++) {
                const rate = calculateNumericRate(pkg, year);
                if (rate > 0) {
                    totalRate += rate;
                    validYears++;
                }
            }
            
            // Add thereafter rate for remaining years
            if (tenureYears > 5) {
                const thereafterRate = calculateNumericRate(pkg, 'thereafter');
                if (thereafterRate > 0) {
                    const remainingYears = tenureYears - 5;
                    totalRate += thereafterRate * remainingYears;
                    validYears += remainingYears;
                }
            }
            
            if (validYears === 0) return 0;
            
            const averageRate = totalRate / validYears;
            const monthlyInstallment = calculateMonthlyInstallment(loanAmount, tenureYears, averageRate);
            const totalPayments = monthlyInstallment * tenureYears * 12;
            
            return totalPayments - loanAmount; // Total interest
        }

        // Calculate lifetime savings compared to existing rate
        function calculateLifetimeSavings(pkg, loanAmount, tenureYears, existingRate) {
            if (!existingRate || existingRate <= 0) return 0;
            
            const newTotalInterest = calculateTotalInterestCost(pkg, loanAmount, tenureYears);
            const existingMonthlyPayment = calculateMonthlyInstallment(loanAmount, tenureYears, existingRate);
            const existingTotalPayment = existingMonthlyPayment * tenureYears * 12;
            const existingTotalInterest = existingTotalPayment - loanAmount;
            
            return existingTotalInterest - newTotalInterest;
        }

        // Extract numeric value from lock-in period (e.g., "3 Years" -> 3)
function parseLockInPeriod(lockPeriod) {
    if (!lockPeriod) return 0;
    const match = lockPeriod.match(/(\d+)/);
    return match ? parseInt(match[1]) : 0;
}

        // Calculate potential monthly savings for refinancing
function calculateMonthlySavings(loanAmount, tenure, existingRate, newRate) {
    if (!loanAmount || !tenure || !existingRate || !newRate) return 0;
    
    const existingPayment = calculateMonthlyInstallment(loanAmount, tenure, existingRate);
    const newPayment = calculateMonthlyInstallment(loanAmount, tenure, newRate);
    
    return existingPayment - newPayment;
}

// Calculate total savings over LOCK-IN PERIOD (not full tenure)
function calculateTotalSavings(monthlySavings, lockInPeriod) {
    if (!monthlySavings || !lockInPeriod) return 0;
    const lockInYears = parseLockInPeriod(lockInPeriod);
    return monthlySavings * lockInYears * 12;
}

// Format savings display with lock-in period context
function formatSavings(savings, lockInPeriod = null) {
    if (savings === 0) return 'No savings';
    
    const lockInYears = lockInPeriod ? parseLockInPeriod(lockInPeriod) : null;
    const periodText = lockInYears ? ` Over ${lockInYears} Year${lockInYears > 1 ? 's' : ''} Lock-in` : '';
    
    if (savings > 0) {
        return `Save ${formatCurrency(Math.abs(savings))}${periodText}`;
    } else {
        return `Higher by ${formatCurrency(Math.abs(savings))}${periodText}`;
    }
}

        function formatPercentage(rate) {
            return `${rate.toFixed(2)}%`;
        }

        // Calculate interest rate for a specific year - PRESERVED FROM ORIGINAL
        function calculateInterestRate(pkg, year) {
    let rateType, operator, value;
    
    if (year === 'thereafter') {
        rateType = pkg.thereafter_rate_type;
        operator = pkg.thereafter_operator;
        value = pkg.thereafter_value;
    } else {
        rateType = pkg[`year${year}_rate_type`];
        operator = pkg[`year${year}_operator`];
        value = pkg[`year${year}_value`];
    }

    // NEW LOGIC: If no data for this year, use thereafter rate
    if (!rateType || value === null || value === undefined) {
        if (pkg.thereafter_rate_type && pkg.thereafter_value !== null && pkg.thereafter_value !== undefined) {
            return calculateInterestRate(pkg, 'thereafter');
        }
        return 0;
    }

    // Original calculation logic
    if (rateType === 'FIXED') {
        return parseFloat(value) || 0;
    } else {
        // Find the reference rate
        const referenceRate = rateTypes.find(rt => rt.rate_type === rateType);
        if (!referenceRate) {
            console.warn(`❌ Reference rate type not found: ${rateType}`);
            return 0;
        }

        const baseRate = parseFloat(referenceRate.rate_value) || 0;
        const adjustment = parseFloat(value) || 0;
        
        if (operator === '+') {
            return baseRate + adjustment;
        } else if (operator === '-') {
            return Math.max(0, baseRate - adjustment);
        } else {
            return baseRate;
        }
    }
}

        // Format rate display for tables - PRESERVED FROM ORIGINAL
       function formatRateDisplay(pkg, year) {
    let rateType, operator, value;
    
    if (year === 'thereafter') {
        rateType = pkg.thereafter_rate_type;
        operator = pkg.thereafter_operator;
        value = pkg.thereafter_value;
    } else {
        rateType = pkg[`year${year}_rate_type`];
        operator = pkg[`year${year}_operator`];
        value = pkg[`year${year}_value`];
    }

    // NEW LOGIC: If no data for this year, use thereafter rate
    if (!rateType || value === null || value === undefined) {
        // Check if thereafter rate exists
        if (pkg.thereafter_rate_type && pkg.thereafter_value !== null && pkg.thereafter_value !== undefined) {
            const thereafterType = pkg.thereafter_rate_type;
            const thereafterOp = pkg.thereafter_operator;
            const thereafterVal = pkg.thereafter_value;
            
            if (thereafterType === 'FIXED') {
                const rate = parseFloat(thereafterVal) || 0;
                return `${formatPercentage(rate)} Fixed`;
            } else {
                const operatorSymbol = thereafterOp === '+' ? '+' : '-';
                return `${thereafterType} ${operatorSymbol} ${thereafterVal}%`;
            }
        }
        return '-'; // Only show dash if no thereafter rate exists
    }

    // Original logic for years with actual data
    if (rateType === 'FIXED') {
        const rate = calculateInterestRate(pkg, year);
        return `${formatPercentage(rate)} Fixed`;
    } else {
        const operatorSymbol = operator === '+' ? '+' : '-';
        return `${rateType} ${operatorSymbol} ${value}%`;
    }
}

        // Enhanced rate display with reference rate values
function formatDetailedRateDisplay(pkg, year) {
    let rateType, operator, value;
    
    if (year === 'thereafter') {
        rateType = pkg.thereafter_rate_type;
        operator = pkg.thereafter_operator;
        value = pkg.thereafter_value;
    } else {
        rateType = pkg[`year${year}_rate_type`];
        operator = pkg[`year${year}_operator`];
        value = pkg[`year${year}_value`];
    }

    if (!rateType || value === null || value === undefined) return '-';

    if (rateType === 'FIXED') {
        const rate = calculateInterestRate(pkg, year);
        return `FIXED ${formatPercentage(rate)}`;
    } else {
        // Find the reference rate from rateTypes
        const referenceRate = rateTypes.find(rt => rt.rate_type === rateType);
        const referenceRateValue = referenceRate ? parseFloat(referenceRate.rate_value) || 0 : 0;
        
        const operatorSymbol = operator === '+' ? '+' : '-';
        const spreadValue = parseFloat(value) || 0;
        
        return `${rateType}(${formatPercentage(referenceRateValue)}) ${operatorSymbol} ${spreadValue.toFixed(2)}%`;
    }
}

        // ===================================
        // DISPLAY FUNCTIONS - ENHANCED UI WITH PRESERVED LOGIC
        // ===================================
// Modified displayResults function to prevent page jumping on live filter
function displayResults(packages, shouldScroll = true) {
    const resultsContainer = document.getElementById('resultsContainer');
    const packagesContainer = document.getElementById('packagesContainer');
    const resultsCount = document.getElementById('resultsCount');
    const noResults = document.getElementById('noResults');

    // Safety checks for DOM elements
    if (!resultsContainer) {
        console.error('❌ Results container not found');
        return;
    }
    
    if (!packagesContainer) {
        console.error('❌ Packages container not found');
        return;
    }

    // Show results container first
    resultsContainer.classList.remove('hidden');

    // Update results count safely
    if (resultsCount) {
        resultsCount.textContent = packages.length;
    }

    if (packages.length === 0) {
        packagesContainer.innerHTML = '';
        if (noResults) {
            noResults.style.display = 'block';
        }
    } else {
        if (noResults) {
            noResults.style.display = 'none';
        }
        
        // Add loading state with fade-in animation (only for initial search)
        if (shouldScroll) {
            packagesContainer.style.opacity = '0';
        }
        
        packagesContainer.innerHTML = packages.map((pkg, index) => createPackageCard(pkg, index)).join('');
        
        // Animate cards in with staggered effect (only for initial search)
        if (shouldScroll) {
            setTimeout(() => {
                packagesContainer.style.transition = 'opacity 0.6s ease';
                packagesContainer.style.opacity = '1';
                
                // Stagger animation for each card
                const cards = packagesContainer.querySelectorAll('.package-card');
                cards.forEach((card, index) => {
                    card.style.opacity = '0';
                    card.style.transform = 'translateY(30px)';
                    card.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
                    
                    setTimeout(() => {
                        card.style.opacity = '1';
                        card.style.transform = 'translateY(0)';
                    }, index * 150);
                });
            }, 100);
        } else {
            // For live filtering, just ensure opacity is 1
            packagesContainer.style.opacity = '1';
        }
        
        // Update the results subtitle to show selection info
        const resultsTitle = document.querySelector('.results-title');
        if (resultsTitle) {
            const selectedCount = packages.filter(pkg => pkg.selected !== false).length;
            resultsTitle.innerHTML = `
                <i data-lucide="trending-up"></i>
                Recommended Packages
                <span class="results-count">${packages.length}</span>
                <small class="selection-count">
                    (${selectedCount} selected for report)
                </small>
            `;
        }
    }

    // Only scroll to results on initial search, not live filtering
    if (shouldScroll) {
        resultsContainer.scrollIntoView({ behavior: 'smooth' });
    }
    
    // Re-initialize Lucide icons for dynamically added content
    setTimeout(() => {
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }, 100);
}

        function createPackageCard(pkg, index) {
            const rank = index + 1;
            const rateSchedule = generateRateSchedule(pkg);
            const features = generatePackageFeatures(pkg);
            
            return `
                <div class="package-card" data-package-index="${index}">
                    <div class="package-selection">
                        <input type="checkbox" 
                               id="pkg-select-${index}" 
                               class="selection-checkbox" 
                               onchange="togglePackageSelection(${index})"
                               ${pkg.selected !== false ? 'checked' : ''}>
                    </div>
                    
                    <div class="package-header">
    <div class="package-rank">${rank}</div>
    <div class="package-bank">
        <div class="bank-name">${pkg.bank_name}</div>
        <div class="package-type">${pkg.rate_type_category || 'Rate Package'}</div>
    </div>
    <div class="package-details-inline">
        <div class="detail-inline">
            <span class="detail-label-inline">Property:</span>
            <span class="detail-value-inline">${pkg.property_type}</span>
        </div>
        <div class="detail-inline">
            <span class="detail-label-inline">Status:</span>
            <span class="detail-value-inline">${pkg.property_status}</span>
        </div>
        <div class="detail-inline">
            <span class="detail-label-inline">Buy Under:</span>
            <span class="detail-value-inline">${pkg.buy_under}</span>
        </div>
        <div class="detail-inline">
            <span class="detail-label-inline">Lock:</span>
            <span class="detail-value-inline">${pkg.lock_period || 'No Lock-in'}</span>
        </div>
        <div class="detail-inline">
            <span class="detail-label-inline">Min Loan:</span>
            <span class="detail-value-inline">${formatCurrency(pkg.minimum_loan_size || 0)}</span>
        </div>
        ${pkg.totalSavings ? `
        <div class="total-savings-compact ${pkg.totalSavings > 0 ? '' : 'negative'}">
            ${formatSavings(pkg.totalSavings, pkg.lock_period)}
        </div>
    ` : ''}
    </div>
    <div class="rate-info">
    <div class="avg-rate">${formatPercentage(pkg.avgFirst2Years)}</div>
    <div class="monthly-payment">${formatCurrency(pkg.monthlyInstallment)}/mo</div>
    
</div>
</div>

                   
                    ${rateSchedule ? `
                        <div class="rate-schedule">
                            <div class="rate-schedule-title">
                                <i data-lucide="trending-up"></i>
                                Interest Rate Schedule
                            </div>
                            <div class="rate-schedule-grid">
                                ${rateSchedule}
                            </div>
                        </div>
                    ` : ''}

                    
                    ${features ? `
    <div class="package-features-inline">
        <span class="features-title-inline">
            <i data-lucide="award"></i>
            Package Features:
        </span>
        ${features}
    </div>
` : ''}





                    <div class="package-remarks-editor">
                        <div class="remarks-editor-title">
                            <i data-lucide="edit"></i>
                            Client Remarks (Editable)
                        </div>
                        <textarea 
                            class="remarks-textarea" 
                            id="remarks-${pkg.id || index}" 
                            placeholder="Add custom remarks for this package..."
                            onchange="updatePackageRemarks(${index}, this.value)"
                        >${pkg.custom_remarks || pkg.remarks || ''}</textarea>
                    </div>
                </div>
            `;
        }

        function generateRateSchedule(pkg) {
    const rates = [];
    
    // Always show Years 1-5 (auto-populate empty years with thereafter rate)
    for (let year = 1; year <= 5; year++) {
        let rateType, operator, value;
        
        // Check if this year has actual data
        rateType = pkg[`year${year}_rate_type`];
        operator = pkg[`year${year}_operator`];
        value = pkg[`year${year}_value`];
        
        // If no data for this year, check if we can use thereafter rate
        if (!rateType || value === null || value === undefined) {
            // Use thereafter rate if available
            if (pkg.thereafter_rate_type && pkg.thereafter_value !== null && pkg.thereafter_value !== undefined) {
                rates.push(`
                    <div class="rate-item">
                        <div class="rate-period">Year ${year}</div>
                        <div class="rate-value">${formatDetailedRateDisplay(pkg, 'thereafter')}</div>
                    </div>
                `);
            } else {
                // Only show dash if no thereafter rate exists
                rates.push(`
                    <div class="rate-item">
                        <div class="rate-period">Year ${year}</div>
                        <div class="rate-value">-</div>
                    </div>
                `);
            }
        } else {
            // Show actual data for this year
            rates.push(`
                <div class="rate-item">
                    <div class="rate-period">Year ${year}</div>
                    <div class="rate-value">${formatDetailedRateDisplay(pkg, year)}</div>
                </div>
            `);
        }
    }

    // Always show thereafter row
    const thereafterRate = calculateInterestRate(pkg, 'thereafter');
    if (thereafterRate > 0) {
        rates.push(`
            <div class="rate-item">
                <div class="rate-period">Thereafter</div>
                <div class="rate-value">${formatDetailedRateDisplay(pkg, 'thereafter')}</div>
            </div>
        `);
    }

    return rates.length > 0 ? rates.join('') : null;
}


        function generatePackageFeatures(pkg) {
            const features = [];
            
            if (pkg.legal_fee_subsidy === 'true' || pkg.legal_fee_subsidy === true) {
                features.push(`
                    <div class="feature-tag">
                        <i data-lucide="shield"></i>
                        Legal Fee Subsidy
                    </div>
                `);
            }
            
            if (pkg.cash_rebate === 'true' || pkg.cash_rebate === true) {
                features.push(`
                    <div class="feature-tag">
                        <i data-lucide="dollar-sign"></i>
                        Cash Rebate
                    </div>
                `);
            }
            
            if (pkg.free_package_conversion_12m === 'true' || pkg.free_package_conversion_12m === true) {
                features.push(`
                    <div class="feature-tag">
                        <i data-lucide="repeat"></i>
                        Free Conversion (12M)
                    </div>
                `);
            }

            if (pkg.free_package_conversion_24m === 'true' || pkg.free_package_conversion_24m === true) {
                features.push(`
                    <div class="feature-tag">
                        <i data-lucide="repeat"></i>
                        Free Conversion (24M)
                    </div>
                `);
            }

            return features.length > 0 ? features.join('') : null;
        }

        // ===================================
        // UTILITY FUNCTIONS - PRESERVED FROM ORIGINAL
        // ===================================
        function formatPercentage(value) {
            if (value == null || value === 0) return 'N/A';
            return `${value.toFixed(2)}%`;
        }

        function formatCurrency(value) {
            if (!value || value === 0) return '$0';
            return new Intl.NumberFormat('en-SG', {
                style: 'currency',
                currency: 'SGD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }

        // Clear all filters - PRESERVED FROM ORIGINAL
        function clearFilters() {
            document.getElementById('propertyType').value = '';
            document.getElementById('propertyStatus').value = '';
            document.getElementById('buyUnder').value = '';
            document.getElementById('loanAmount').value = '';
            document.getElementById('loanTenure').value = '';
            
            // Clear results
            document.getElementById('resultsContainer').style.display = 'none';
            currentResults = [];
            searchCriteria = {};
        }

        // Download packages list - PRESERVED FROM ORIGINAL
        function downloadPackagesList() {
            if (!currentResults.length) {
                showNotification('No results to download. Please search for packages first.', 'error');
                return;
            }

            generateProfessionalReport();
        }
        // ===================================
        // PACKAGE SELECTION MANAGEMENT
        // ===================================
        function togglePackageSelection(packageIndex) {
            const checkbox = document.getElementById(`pkg-select-${packageIndex}`);
            if (currentResults[packageIndex]) {
                currentResults[packageIndex].selected = checkbox.checked;
                console.log(`📋 Package ${packageIndex} selection:`, checkbox.checked);
                
                // Update selection count display
                updateSelectionCount();
            }
        }

        function updateSelectionCount() {
            const resultsSubtitle = document.querySelector('.results-title');
            if (resultsSubtitle && currentResults.length > 0) {
                const selectedCount = currentResults.filter(pkg => pkg.selected !== false).length;
                resultsSubtitle.innerHTML = `
                    <i data-lucide="trending-up"></i>
                    Recommended Packages
                    <span class="results-count">${currentResults.length}</span>
                    <small class="selection-count">
                        (${selectedCount} selected for report)
                    </small>
                `;
                
                // Re-initialize lucide icons
                setTimeout(() => {
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                }, 50);
            }
        }

        function toggleAllSelections() {
            const anySelected = currentResults.some(pkg => pkg.selected !== false);
            const newState = !anySelected;
            
            currentResults.forEach((pkg, index) => {
                pkg.selected = newState;
                const checkbox = document.getElementById(`pkg-select-${index}`);
                if (checkbox) {
                    checkbox.checked = newState;
                }
            });
            
            updateSelectionCount();
            showNotification(newState ? 'All packages selected for report' : 'All packages deselected', 'info');
        }

        // ===================================
        // PACKAGE REMARKS MANAGEMENT
        // ===================================
        function updatePackageRemarks(packageIndex, newRemarks) {
            if (currentResults[packageIndex]) {
                currentResults[packageIndex].custom_remarks = newRemarks;
                console.log(`📝 Updated remarks for package ${packageIndex}:`, newRemarks);
            }
        }

        // ===================================
        // REPORT GENERATION FUNCTIONS
        // ===================================
        function downloadPackagesList() {
            if (!currentResults.length) {
                showNotification('No results to download. Please search for packages first.', 'error');
                return;
            }

            generateProfessionalReport();
        }

        // FIXED generateProfessionalReport function - remove duplicate variable declaration

function generateProfessionalReport() {
    if (!currentResults.length) {
        showNotification('No results to generate report. Please search for packages first.', 'error');
        return;
    }

    // Debug: Check searchCriteria content
    console.log('🔍 searchCriteria in generateProfessionalReport:', searchCriteria);
    console.log('💰 Loan Amount:', searchCriteria.loanAmount);
    console.log('📅 Loan Tenure:', searchCriteria.loanTenure);
    console.log('🏠 Loan Type:', searchCriteria.loanType);
    console.log('📊 Existing Rate:', searchCriteria.existingInterestRate);

    // Safeguard: If searchCriteria is empty or missing data, rebuild it from form
    if (!searchCriteria || Object.keys(searchCriteria).length === 0 || !searchCriteria.loanAmount || !searchCriteria.loanTenure) {
        console.warn('⚠️ searchCriteria missing data, rebuilding from form...');
        searchCriteria = {
            ...searchCriteria,
            loanAmount: parseFloat(document.getElementById('loanAmount').value) || 0,
            loanTenure: parseInt(document.getElementById('loanTenure').value) || 25,
            propertyType: document.getElementById('propertyType').value,
            propertyStatus: document.getElementById('propertyStatus').value,
            loanType: currentLoanType || 'New Home Loan',
            existingInterestRate: parseFloat(document.getElementById('existingInterestRate').value) || 0
        };
        console.log('🔧 Rebuilt searchCriteria:', searchCriteria);
    }
    
    // Ensure existingInterestRate is always captured for refinancing
    if (!searchCriteria.existingInterestRate && searchCriteria.loanType === 'Refinancing Home Loan') {
        searchCriteria.existingInterestRate = parseFloat(document.getElementById('existingInterestRate').value) || 0;
        console.log('🔄 Added missing existingInterestRate:', searchCriteria.existingInterestRate);
    }

    // Get report options
    const clientName = document.getElementById('clientName').value.trim();
    const hideBankNames = document.getElementById('hideBankNames').checked;

    // Get selected packages or default to top 3
    let selectedPackages = currentResults.filter(pkg => pkg.selected !== false);
    if (selectedPackages.length === 0) {
        selectedPackages = currentResults.slice(0, 3);
    } else {
        selectedPackages = selectedPackages.slice(0, 3); // Limit to top 3
    }
    
    // Debug: Check selected packages
    console.log('📦 Selected Packages:', selectedPackages.map(pkg => ({
        bank: pkg.bank_name,
        totalSavings: pkg.totalSavings,
        lockPeriod: pkg.lock_period
    })));

    // Recalculate savings for PDF generation if refinancing
    if (searchCriteria.loanType === 'Refinancing Home Loan' && searchCriteria.existingInterestRate > 0) {
        selectedPackages = selectedPackages.map(pkg => {
            const avgFirst2Years = pkg.avgFirst2Years || calculateAverageFirst2Years(pkg);
            const monthlySavings = calculateMonthlySavings(
                searchCriteria.loanAmount, 
                searchCriteria.loanTenure, 
                searchCriteria.existingInterestRate, 
                avgFirst2Years
            );
            const totalSavings = calculateTotalSavings(monthlySavings, pkg.lock_period);
            
            console.log(`💰 Recalculated savings for ${pkg.bank_name}:`, {
                monthlySavings,
                totalSavings,
                lockPeriod: pkg.lock_period,
                avgRate: avgFirst2Years,
                existingRate: searchCriteria.existingInterestRate
            });
            
            return {
                ...pkg,
                totalSavings,
                monthlySavings
            };
        });
    }

    if (selectedPackages.length === 0) {
        showNotification('Please select at least one package for the report.', 'error');
        return;
    }

    console.log('📄 Generating professional report for', selectedPackages.length, 'packages');

    const reportDate = new Date().toLocaleDateString('en-SG', {
        day: 'numeric',
        month: 'short',
        year: 'numeric'
    });

    // FIXED: Always show all 5 years + thereafter (remove duplicate declaration)
    const yearsToShow = [1, 2, 3, 4, 5];
    const hasThereafterData = true; // Always show thereafter row

    const reportContent = `
        <div class="pdf-report-container">
            <!-- Professional Header -->
            <div class="pdf-header">
                <div class="logo-section">
                    <img src="https://ik.imagekit.io/hst9jooux/KEYQUEST%20LOGO%20(Black%20Text%20Horizontal).png?updatedAt=1753262438682" 
                         alt="KeyQuest Mortgage Logo" 
                         onerror="this.style.display='none';" />
                </div>
                <div class="title-section">
                    <h1>Mortgage Package Analysis</h1>
                    ${clientName ? `<div class="client-name">Prepared for: ${clientName}</div>` : ''}
                    <div class="report-date">${reportDate}</div>
                </div>
            </div>

            <!-- Key Information Cards -->
            <div class="pdf-key-info">
                <div class="pdf-info-grid">
                    <div class="pdf-info-item">
                        <div class="pdf-info-label">Loan Amount</div>
                        <div class="pdf-info-value">${formatCurrency(searchCriteria.loanAmount || 0)}</div>
                    </div>
                    <div class="pdf-info-item">
                        <div class="pdf-info-label">Loan Tenure</div>
                        <div class="pdf-info-value">${searchCriteria.loanTenure || 'N/A'} Years</div>
                    </div>
                    <div class="pdf-info-item">
                        <div class="pdf-info-label">Property Type</div>
                        <div class="pdf-info-value property-type">${searchCriteria.propertyType || 'Private Property'}</div>
                    </div>
                    ${searchCriteria.loanType === 'Refinancing Home Loan' && searchCriteria.existingInterestRate ? `
                    <div class="pdf-info-item">
                        <div class="pdf-info-label">Current Rate</div>
                        <div class="pdf-info-value current-rate">${searchCriteria.existingInterestRate}%</div>
                    </div>
                    <div class="pdf-info-item">
                        <div class="pdf-info-label">Best Savings</div>
                        <div class="pdf-info-value savings">${formatSavings(selectedPackages[0]?.totalSavings || 0, selectedPackages[0]?.lock_period)}<span class="sub-text">Over ${selectedPackages[0]?.lock_period || '2'} Years Lock-in</span></div>
                    </div>
                    ` : `
                    <div class="pdf-info-item">
                        <div class="pdf-info-label">Best Rate</div>
                        <div class="pdf-info-value best-rate">${selectedPackages[0]?.avgFirst2Years?.toFixed(2) || 'N/A'}%</div>
                    </div>
                    `}
                </div>
            </div>

            ${searchCriteria.loanType === 'Refinancing Home Loan' && searchCriteria.existingInterestRate ? `
            <!-- Potential Savings Section -->
            <div class="pdf-savings-section">
                <div class="pdf-savings-title">Potential Savings with Our Recommended Package</div>
                <div class="pdf-savings-grid">
                    <div class="pdf-savings-item">
                        <div class="label">Current Monthly Payment</div>
                        <div class="value current">${formatCurrency(calculateMonthlyInstallment(searchCriteria.loanAmount, searchCriteria.loanTenure, searchCriteria.existingInterestRate))}</div>
                        <div class="sub-label">at ${searchCriteria.existingInterestRate}%</div>
                    </div>
                    <div class="pdf-savings-item">
                        <div class="label">New Monthly Payment</div>
                        <div class="value new">${formatCurrency(selectedPackages[0]?.monthlyInstallment || 0)}</div>
                        <div class="sub-label">at ${selectedPackages[0]?.avgFirst2Years?.toFixed(2) || 'N/A'}%</div>
                    </div>
                    <div class="pdf-savings-item">
                        <div class="label">Total Savings</div>
                        <div class="value savings">${formatSavings(selectedPackages[0]?.totalSavings || 0, selectedPackages[0]?.lock_period)}</div>
                        <div class="sub-label">over lock-in period</div>
                    </div>
                </div>
            </div>
            ` : ''}

            <!-- Package Comparison Table -->
            <div class="pdf-comparison-section">
                <div class="pdf-comparison-title">Package Comparison</div>
                
                <table class="pdf-comparison-table">
                    <thead>
                        <tr>
                            <th>Details</th>
                            ${selectedPackages.map((pkg, index) => `
                                <th class="${index === 0 ? 'recommended' : ''}">
                                    ${hideBankNames ? `PKG(${index + 1})` : pkg.bank_name}
                                </th>
                            `).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Rate Type</td>
                            ${selectedPackages.map((pkg, index) => `
                                <td class="${index === 0 ? 'recommended' : ''}">
                                    ${pkg.rate_type_category || 'Rate Package'}
                                </td>
                            `).join('')}
                        </tr>
                        <tr>
                            <td>Min Loan Amount</td>
                            ${selectedPackages.map((pkg, index) => `
                                <td class="${index === 0 ? 'recommended amount' : 'amount'}">
                                    ${formatCurrency(pkg.minimum_loan_size || 0)}
                                </td>
                            `).join('')}
                        </tr>
                        
                        ${yearsToShow.map((year, yearIndex) => `
                            <tr>
                                <td>Year ${year}</td>
                                ${selectedPackages.map((pkg, index) => {
                                    const rateDisplay = formatRateDisplay(pkg, year);
                                    return `
                                    <td class="${index === 0 ? 'recommended rate-value' : 'rate-value'}">
                                        ${rateDisplay}
                                    </td>
                                `;
                                }).join('')}
                            </tr>
                        `).join('')}
                        
                        <tr>
                            <td>Thereafter</td>
                            ${selectedPackages.map((pkg, index) => {
                                const rateDisplay = formatRateDisplay(pkg, 'thereafter');
                                return `
                                <td class="${index === 0 ? 'recommended rate-value' : 'rate-value'}">
                                    ${rateDisplay}
                                </td>
                            `;
                            }).join('')}
                        </tr>
                        
                        <tr>
                            <td>Lock-in Period</td>
                            ${selectedPackages.map((pkg, index) => `
                                <td class="${index === 0 ? 'recommended period' : 'period'}">
                                    ${parseLockInPeriod(pkg.lock_period) || 0} Years
                                </td>
                            `).join('')}
                        </tr>
                        
                        
                        ${searchCriteria.loanType === 'Refinancing Home Loan' && searchCriteria.existingInterestRate ? `
                        <tr>
                            <td>Monthly Installment</td>
                            ${selectedPackages.map((pkg, index) => `
                                <td class="${index === 0 ? 'recommended' : ''}">
                                    ${formatCurrency(pkg.monthlyInstallment || 0)}
                                </td>
                            `).join('')}
                        </tr>
                        <tr>
                            <td>Total Savings</td>
                            ${selectedPackages.map((pkg, index) => `
                                <td class="${index === 0 ? 'recommended savings-cell' : 'savings-cell'}">
                                    ${formatSavings(pkg.totalSavings || 0, pkg.lock_period)}
                                </td>
                            `).join('')}
                        </tr>
                        ` : `
                        <tr>
                            <td>Monthly Installment</td>
                            ${selectedPackages.map((pkg, index) => `
                                <td class="${index === 0 ? 'recommended' : ''}">
                                    ${formatCurrency(pkg.monthlyInstallment || 0)}
                                </td>
                            `).join('')}
                        </tr>
                        `}
                        
                        <tr>
                            <td>Package Features</td>
                            ${selectedPackages.map((pkg, index) => `
                                <td class="${index === 0 ? 'recommended features-cell' : 'features-cell'}">
                                    ${pkg.legal_fee_subsidy === 'true' || pkg.legal_fee_subsidy === true ? 
                                        '<div style="color: #15803d; margin-bottom: 3px;">✓ Legal Fee Subsidy</div>' : ''}
                                    ${pkg.cash_rebate === 'true' || pkg.cash_rebate === true ? 
                                        '<div style="color: #15803d; margin-bottom: 3px;">✓ Cash Rebate</div>' : ''}
                                    ${pkg.free_package_conversion_12m === 'true' || pkg.free_package_conversion_12m === true ? 
                                        '<div style="color: #15803d; margin-bottom: 3px;">✓ Free Conversion (12M)</div>' : ''}
                                    ${pkg.free_package_conversion_24m === 'true' || pkg.free_package_conversion_24m === true ? 
                                        '<div style="color: #15803d; margin-bottom: 3px;">✓ Free Conversion (24M)</div>' : ''}
                                    ${pkg.valuation_subsidy === 'true' || pkg.valuation_subsidy === true ? 
                                        '<div style="color: #15803d; margin-bottom: 3px;">✓ Valuation Subsidy</div>' : ''}
                                    ${pkg.partial_repayment === 'true' || pkg.partial_repayment === true ? 
                                        '<div style="color: #15803d; margin-bottom: 3px;">✓ Partial Repayment</div>' : ''}
                                    ${pkg.waiver_due_to_sales === 'true' || pkg.waiver_due_to_sales === true ? 
                                        '<div style="color: #15803d; margin-bottom: 3px;">✓ Waiver Due to Sales</div>' : ''}
                                    ${(!pkg.legal_fee_subsidy || pkg.legal_fee_subsidy === 'false') && 
                                      (!pkg.cash_rebate || pkg.cash_rebate === 'false') && 
                                      (!pkg.free_package_conversion_12m || pkg.free_package_conversion_12m === 'false') &&
                                      (!pkg.free_package_conversion_24m || pkg.free_package_conversion_24m === 'false') &&
                                      (!pkg.valuation_subsidy || pkg.valuation_subsidy === 'false') &&
                                      (!pkg.partial_repayment || pkg.partial_repayment === 'false') &&
                                      (!pkg.waiver_due_to_sales || pkg.waiver_due_to_sales === 'false') ? 
                                        '<div style="color: #6b7280;">Standard features</div>' : ''}
                                </td>
                            `).join('')}
                        </tr>
                        
                        <tr>
                            <td>Remarks</td>
                            ${selectedPackages.map((pkg, index) => `
                                <td class="${index === 0 ? 'recommended features-cell' : 'features-cell'}">
                                    ${(pkg.custom_remarks || pkg.remarks || 'All packages are structured with fixed rates followed by floating rates based on 3M SORA.').replace(/\n/g, '<br>').substring(0, 200)}${(pkg.custom_remarks || pkg.remarks || '').length > 200 ? '...' : ''}
                                </td>
                            `).join('')}
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Professional Disclaimer -->
            <div class="pdf-disclaimer">
                <div class="pdf-disclaimer-title">Disclaimer:</div>
                <div class="pdf-disclaimer-text">
                    This report is for informational purposes only. Rates and terms are subject to bank approval and may change without notice. 
                    Please verify all details with lenders and consult qualified professionals before making financial decisions. 
                    Check for penalties or fees before switching lenders.
                </div>
            </div>
        </div>
    `;

    // Open modal with report content
    openReportModal(reportContent);
}

        function openReportModal(content) {
            // Create modal if it doesn't exist
            let modal = document.getElementById('report-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'report-modal';
                modal.className = 'modal';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';
                modal.innerHTML = `
                    <div style="background: white; border-radius: 16px; width: 100%; max-width: 1200px; max-height: 90vh; display: flex; flex-direction: column;">
                        <div style="padding: 20px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="margin: 0; color: #1f2937;">Professional Mortgage Report</h3>
                            <div style="display: flex; gap: 12px;">
                                <button onclick="printReport()" style="padding: 8px 16px; background: #1e40af; color: white; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                                    <i data-lucide="printer" style="width: 16px; height: 16px;"></i>
                                    Print/Save PDF
                                </button>
                                <button onclick="closeReportModal()" style="padding: 8px 12px; background: #6b7280; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                    <i data-lucide="x" style="width: 16px; height: 16px;"></i>
                                </button>
                            </div>
                        </div>
                        <div id="report-content" style="flex: 1; overflow-y: auto;">
                            ${content}
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } else {
                document.getElementById('report-content').innerHTML = content;
            }

            modal.style.display = 'flex';
            
            // Re-initialize Lucide icons for the modal
            setTimeout(() => {
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }, 100);
        }

        function closeReportModal() {
            const modal = document.getElementById('report-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function printReport() {
            const originalTitle = document.title;
            document.title = `Keyquest_Mortgage_Report_${new Date().toISOString().split('T')[0]}`;
            
            const reportContent = document.getElementById('report-content').innerHTML;
            const printWindow = window.open('', '_blank');
            // Get CSS from the current page
            const cssLink = document.querySelector('link[href*="recommended-packages.css"]');
            const adminCssLink = document.querySelector('link[href*="admin-styles.css"]');
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Keyquest Mortgage Report</title>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    ${cssLink ? `<link rel="stylesheet" href="${cssLink.href}">` : ''}
                    ${adminCssLink ? `<link rel="stylesheet" href="${adminCssLink.href}">` : ''}
                    <style>
                        @page {
                            margin: 0.5in;
                            size: A4;
                        }
                        
                        body {
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                            margin: 0;
                            padding: 0;
                            -webkit-print-color-adjust: exact !important;
                            color-adjust: exact !important;
                            print-color-adjust: exact !important;
                            background: white;
                            color: #1a1a1a;
                        }
                        
                        @media print {
                            * {
                                -webkit-print-color-adjust: exact !important;
                                color-adjust: exact !important;
                                print-color-adjust: exact !important;
                            }
                        }
                    </style>
                </head>
                <body>
                    ${reportContent}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
            
            document.title = originalTitle;
        }

        function exportCSV() {
            if (!currentResults.length) {
                showNotification('No results to export. Please search for packages first.', 'error');
                return;
            }

            const headers = [
                'Rank', 'Bank Name', 'Avg First 2 Years (%)', 'Monthly Installment', 'Property Type', 
                'Property Status', 'Buy Under', 'Rate Type', 'Lock Period', 'Min Loan Size', 'Custom Remarks'
            ];

            const csvContent = [
                headers.join(','),
                ...currentResults.map((pkg, index) => [
                    index + 1,
                    `"${pkg.bank_name}"`,
                    pkg.avgFirst2Years.toFixed(3),
                    pkg.monthlyInstallment.toFixed(2),
                    `"${pkg.property_type}"`,
                    `"${pkg.property_status}"`,
                    `"${pkg.buy_under}"`,
                    `"${pkg.rate_type_category}"`,
                    `"${pkg.lock_period || 'No Lock-in'}"`,
                    (pkg.minimum_loan_size || 0),
                    `"${(pkg.custom_remarks || pkg.remarks || '').replace(/"/g, '""')}"`
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const filename = `mortgage_recommendations_${new Date().toISOString().split('T')[0]}.csv`;
            
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showNotification('Data exported successfully', 'success');
        }

        // ===================================
        // SIGN OUT FUNCTIONS - PRESERVED FROM ORIGINAL  
        // ===================================
        function confirmSignOut() {
            if (confirm('Are you sure you want to sign out?')) {
                performSignOut();
            }
        }

        async function performSignOut() {
            try {
                showLoading('Signing out...');
                
                if (typeof AuthService !== 'undefined') {
                    const { success } = await AuthService.signOut();
                    if (!success) {
                        console.warn('Sign out service failed, but continuing...');
                    }
                }
                
                // Clear any stored data
                localStorage.clear();
                sessionStorage.clear();
                
                // Redirect to login
                window.location.href = 'login.html';
                
            } catch (error) {
                console.error('Sign out error:', error);
                showNotification('Sign out failed: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // ===================================
        // LOADING AND NOTIFICATION FUNCTIONS - PRESERVED FROM ORIGINAL
        // ===================================
    function showLoading(message = 'Loading...') {
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingText = loadingOverlay.querySelector('.loading-message');
    if (loadingText) loadingText.textContent = message;
    loadingOverlay.style.display = 'flex';
}

function hideLoading() {
    const loadingOverlay = document.getElementById('loadingOverlay');
    if (loadingOverlay) {
        loadingOverlay.style.display = 'none';
    }
}

        function showNotification(message, type = 'info') {
            console.log(`[${type.toUpperCase()}] ${message}`);
            // You can implement a proper notification system here
        }

        // ===================================
        // MODAL FUNCTIONS
        // ===================================
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'flex';
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // ===================================
        // SIDEBAR FUNCTIONS - PRESERVED FROM ORIGINAL
        // ===================================
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            
            sidebar?.classList.toggle('open');
            overlay?.classList.toggle('active');
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            
            sidebar?.classList.remove('open');
            overlay?.classList.remove('active');
        }
    </script>
</body>
</html>
