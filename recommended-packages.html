<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recommended Packages - Keyquest Admin</title>
    
    <!-- Standardized CSS Link -->
    <link rel="stylesheet" href="css/admin-styles.css">
    
    <!-- External Scripts in proper order -->
    <script src="js/lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config/supabase.js"></script>
    <script src="js/admin-scripts.js"></script>
</head>
<body>
    <div class="overlay" id="overlay" onclick="closeSidebar()"></div>
    
    <div class="admin-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="index.html" class="logo">
                    <div class="logo-icon">
                        <i data-lucide="building-2"></i>
                    </div>
                    <span>KEYQUEST</span>
                </a>
            </div>
            <nav class="nav-menu">
                <a href="index.html" class="nav-item">
                    <i data-lucide="layout-dashboard"></i>
                    <span>Dashboard</span>
                </a>
                <a href="rate-packages.html" class="nav-item">
                    <i data-lucide="package"></i>
                    <span>Rate Package</span>
                </a>
                <a href="recommended-packages.html" class="nav-item active">
                    <i data-lucide="star"></i>
                    <span>Recommended Packages</span>
                </a>
                <a href="rate-types.html" class="nav-item">
                    <i data-lucide="percent"></i>
                    <span>Rate Type</span>
                </a>
                <a href="banks.html" class="nav-item">
                    <i data-lucide="landmark"></i>
                    <span>Bank</span>
                </a>
                <a href="bankers.html" class="nav-item">
                    <i data-lucide="briefcase"></i>
                    <span>Bankers</span>
                </a>
                <a href="agents.html" class="nav-item">
                    <i data-lucide="users"></i>
                    <span>Agents</span>
                </a>
                <a href="enquiry.html" class="nav-item">
                    <i data-lucide="help-circle"></i>
                    <span>Enquiry</span>
                </a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <header class="header">
                <div class="header-left">
                    <button class="menu-toggle" onclick="toggleSidebar()">
                        <i data-lucide="menu"></i>
                    </button>
                    <h1 class="header-title">Recommended Packages</h1>
                </div>
                <div class="header-right">
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="generateReport()">
                            <i data-lucide="download"></i>
                            Download Report
                        </button>
                        <button class="btn btn-secondary" onclick="confirmSignOut()">
                            <i data-lucide="log-out"></i>
                            <span>Sign Out</span>
                        </button>
                    </div>
                    <div class="user-profile">
                        <div class="user-avatar" id="userAvatar">A</div>
                        <div class="user-info">
                            <div class="user-name" id="userName">Admin</div>
                            <div class="user-role">Super Admin</div>
                        </div>
                    </div>
                </div>
            </header>

            <div class="content">
                <!-- Filter Criteria Form -->
                <div class="filter-form-container">
                    <div class="filter-form">
                        <h3>Search Criteria</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Loan Type</label>
                                <select class="form-select" id="loanTypeFilter">
                                    <option value="">All Loan Types</option>
                                    <option value="New Home Loan">New Home Loan</option>
                                    <option value="Refinancing Home Loan">Refinancing Home Loan</option>
                                    <option value="Commercial/Industrial">Commercial/Industrial</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Property Type</label>
                                <select class="form-select" id="propertyTypeFilter">
                                    <option value="">All Property Types</option>
                                    <option value="HDB">HDB</option>
                                    <option value="Private Property">Private Property</option>
                                    <option value="EC">EC</option>
                                    <option value="Commercial">Commercial</option>
                                    <option value="Industrial">Industrial</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Property Status</label>
                                <select class="form-select" id="propertyStatusFilter">
                                    <option value="">All Statuses</option>
                                    <option value="Completed">Completed</option>
                                    <option value="Under Construction">Under Construction</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Loan Amount ($)</label>
                                <input type="number" class="form-input" id="loanAmountFilter" placeholder="e.g., 500000">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Lock Period (years)</label>
                                <select class="form-select" id="lockPeriodFilter">
                                    <option value="">Any Lock Period</option>
                                    <option value="1">1 Year</option>
                                    <option value="2">2 Years</option>
                                    <option value="3">3 Years</option>
                                    <option value="4">4 Years</option>
                                    <option value="5">5 Years</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Rate Type</label>
                                <select class="form-select" id="rateTypeFilter">
                                    <option value="">All Rate Types</option>
                                    <option value="Fixed">Fixed</option>
                                    <option value="Floating">Floating</option>
                                    <option value="Board">Board</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Bank</label>
                                <select class="form-select" id="bankFilter">
                                    <option value="">All Banks</option>
                                    <option value="CIMB">CIMB</option>
                                    <option value="OCBC">OCBC</option>
                                    <option value="UOB">UOB</option>
                                    <option value="DBS">DBS</option>
                                    <option value="MBB">MBB</option>
                                    <option value="SCB">SCB</option>
                                    <option value="HSBC">HSBC</option>
                                    <option value="SBI">SBI</option>
                                    <option value="BOC">BOC</option>
                                    <option value="HLF">HLF</option>
                                    <option value="SF">SF</option>
                                    <option value="RHB">RHB</option>
                                    <option value="SIF">SIF</option>
                                    <option value="Citibank">Citibank</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-primary" onclick="searchPackages()">
                                <i data-lucide="search"></i>
                                Search Packages
                            </button>
                            <button class="btn btn-secondary" onclick="resetFilters()">
                                <i data-lucide="refresh-cw"></i>
                                Reset Filters
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Results Section -->
                <div class="results-section">
                    <div class="results-header">
                        <h3>Recommended Packages</h3>
                        <div class="results-count" id="resultsCount">No packages found</div>
                    </div>

                    <!-- Data Table -->
                    <div class="data-table">
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>PACKAGE DETAILS</th>
                                        <th>BANK</th>
                                        <th>RATES</th>
                                        <th>LOAN RANGE</th>
                                        <th>FEATURES</th>
                                        <th>CALCULATION</th>
                                    </tr>
                                </thead>
                                <tbody id="packagesTableBody">
                                    <tr id="noDataRow">
                                        <td colspan="6" class="text-center">
                                            <div class="empty-state">
                                                <i data-lucide="search"></i>
                                                <p>Use the search form above to find recommended packages</p>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sign Out Confirmation Modal -->
    <div class="modal" id="signout-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Confirm Sign Out</h3>
                <button class="modal-close" onclick="closeModal('signout-modal')">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="confirm-message">
                    <i data-lucide="log-out"></i>
                    <p>Are you sure you want to sign out?<br>
                    You will be redirected to the login page.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('signout-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="performSignOut()">
                    <i data-lucide="log-out"></i>
                    Sign Out
                </button>
            </div>
        </div>
    </div>

    <script>
        // Recommended Packages specific functionality
        let packages = [];
        let rateTypes = [];
        let filteredPackages = [];
        let currentFilters = {};

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸš€ Initializing Recommended Packages page...');
            
            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            
            // Check authentication
            checkAuthentication();
            
            // Load packages and rate types data
            Promise.all([loadPackages(), loadRateTypes()]).then(() => {
                console.log('Recommended Packages page ready');
            });
        });

        // Load packages from database
        async function loadPackages() {
            try {
                showLoading('Loading packages...');
                
                const { data, error } = await supabaseClient
                    .from('rate_packages')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                packages = data || [];
                
                showNotification(`Loaded ${packages.length} packages`, 'success');
                
            } catch (error) {
                console.error('Error loading packages:', error);
                showNotification('Failed to load packages: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Load rate types from database
        async function loadRateTypes() {
            try {
                const { data, error } = await supabaseClient
                    .from('rate_types')
                    .select('*')
                    .order('rate_type_name');

                if (error) throw error;

                rateTypes = data || [];
                
            } catch (error) {
                console.error('Error loading rate types:', error);
                showNotification('Failed to load rate types: ' + error.message, 'error');
            }
        }

        // Search packages based on criteria
        function searchPackages() {
            const loanType = document.getElementById('loanTypeFilter').value;
            const propertyType = document.getElementById('propertyTypeFilter').value;
            const propertyStatus = document.getElementById('propertyStatusFilter').value;
            const loanAmount = parseFloat(document.getElementById('loanAmountFilter').value) || 0;
            const lockPeriod = document.getElementById('lockPeriodFilter').value;
            const rateType = document.getElementById('rateTypeFilter').value;
            const bank = document.getElementById('bankFilter').value;

            currentFilters = {
                loanType,
                propertyType,
                propertyStatus,
                loanAmount,
                lockPeriod,
                rateType,
                bank
            };

            filteredPackages = packages.filter(pkg => {
                // Apply filters
                if (loanType && pkg.loan_type !== loanType) return false;
                if (propertyType && pkg.property_type !== propertyType) return false;
                if (propertyStatus && pkg.property_status !== propertyStatus) return false;
                if (bank && pkg.bank_name !== bank) return false;
                if (rateType && pkg.rate_type_category !== rateType) return false;
                if (lockPeriod && pkg.lock_period != lockPeriod) return false;
                
                // Check loan amount range
                if (loanAmount > 0) {
                    const minAmount = pkg.minimum_loan_size || 0;
                    const maxAmount = pkg.maximum_loan_size || Infinity;
                    if (loanAmount < minAmount || loanAmount > maxAmount) return false;
                }

                return true;
            });

            // Sort by best rates (lowest first)
            filteredPackages.sort((a, b) => {
                const aRate = getRateValue(a);
                const bRate = getRateValue(b);
                return aRate - bRate;
            });

            displayFilteredPackages();
            updateResultsCount();
        }

        // Get rate value for sorting
        function getRateValue(pkg) {
            const rateType = rateTypes.find(rt => rt.rate_type_name === pkg.rate_type_name);
            return rateType ? (rateType.year_1_rate || 999) : 999;
        }

        // Display filtered packages
        function displayFilteredPackages() {
            const tbody = document.getElementById('packagesTableBody');
            const noDataRow = document.getElementById('noDataRow');

            if (filteredPackages.length === 0) {
                noDataRow.style.display = 'table-row';
                return;
            }

            noDataRow.style.display = 'none';
            
            const packageRows = filteredPackages.map((pkg, index) => {
                const rateType = rateTypes.find(rt => rt.rate_type_name === pkg.rate_type_name);
                const year1Rate = rateType ? rateType.year_1_rate : 0;
                const subsequentRate = rateType ? rateType.subsequent_rate : 0;
                
                // Calculate monthly payment estimate
                const loanAmount = currentFilters.loanAmount || 500000; // Default amount for calculation
                const monthlyRate = year1Rate / 100 / 12;
                const numPayments = 30 * 12; // 30 years
                const monthlyPayment = monthlyRate > 0 ? 
                    loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / 
                    (Math.pow(1 + monthlyRate, numPayments) - 1) : 0;

                const totalInterest = (monthlyPayment * numPayments) - loanAmount;

                return `
                    <tr class="package-row ${index < 3 ? 'recommended' : ''}">
                        <td>
                            <div class="package-info">
                                <strong>${escapeHtml(pkg.bank_name || '')} Package</strong>
                                <div class="package-details">
                                    <span class="detail-item">${escapeHtml(pkg.loan_type || '')}</span>
                                    <span class="detail-item">${escapeHtml(pkg.property_type || '')}</span>
                                    <span class="detail-item">${escapeHtml(pkg.property_status || '')}</span>
                                </div>
                                ${index < 3 ? '<span class="recommended-badge">Top Pick</span>' : ''}
                            </div>
                        </td>
                        <td>
                            <span class="bank-tag">${escapeHtml(pkg.bank_name || '')}</span>
                        </td>
                        <td>
                            <div class="rate-details">
                                <div class="rate-item">
                                    <span class="rate-label">Year 1:</span>
                                    <span class="rate-value">${year1Rate.toFixed(2)}%</span>
                                </div>
                                <div class="rate-item">
                                    <span class="rate-label">Subsequent:</span>
                                    <span class="rate-value">${subsequentRate.toFixed(2)}%</span>
                                </div>
                                <div class="rate-type">${escapeHtml(pkg.rate_type_category || '')}</div>
                            </div>
                        </td>
                        <td>
                            <div class="loan-range">
                                <div>Min: $${(pkg.minimum_loan_size || 0).toLocaleString()}</div>
                                <div>Max: $${(pkg.maximum_loan_size || 0).toLocaleString()}</div>
                                ${pkg.lock_period ? `<div class="lock-period">${pkg.lock_period} year lock</div>` : ''}
                            </div>
                        </td>
                        <td>
                            <div class="features-list">
                                ${pkg.legal_fee_subsidy ? '<span class="feature-tag">Legal Fee Subsidy</span>' : ''}
                                ${pkg.valuation_subsidy ? '<span class="feature-tag">Valuation Subsidy</span>' : ''}
                                ${pkg.partial_repayment ? '<span class="feature-tag">Partial Repayment</span>' : ''}
                            </div>
                        </td>
                        <td>
                            <div class="calculation-details">
                                <div class="calc-item">
                                    <span class="calc-label">Monthly Payment:</span>
                                    <span class="calc-value">$${monthlyPayment.toLocaleString('en-SG', {maximumFractionDigits: 0})}</span>
                                </div>
                                <div class="calc-item">
                                    <span class="calc-label">Total Interest:</span>
                                    <span class="calc-value">$${totalInterest.toLocaleString('en-SG', {maximumFractionDigits: 0})}</span>
                                </div>
                                <small class="calc-note">Based on $${loanAmount.toLocaleString()} loan</small>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = packageRows + (noDataRow ? noDataRow.outerHTML : '');

            // Re-initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        // Update results count
        function updateResultsCount() {
            const count = filteredPackages.length;
            const resultsCount = document.getElementById('resultsCount');
            
            if (count === 0) {
                resultsCount.textContent = 'No packages found';
                resultsCount.className = 'results-count no-results';
            } else {
                resultsCount.textContent = `${count} package${count === 1 ? '' : 's'} found`;
                resultsCount.className = 'results-count';
            }
        }

        // Generate and download report
        function generateReport() {
            if (filteredPackages.length === 0) {
                showNotification('No packages to generate report for. Please search first.', 'warning');
                return;
            }

            let reportContent = `KEYQUEST MORTGAGE PACKAGE RECOMMENDATIONS REPORT\n`;
            reportContent += `Generated on: ${new Date().toLocaleDateString()}\n`;
            reportContent += `==========================================\n\n`;

            reportContent += `SEARCH CRITERIA:\n`;
            reportContent += `Loan Type: ${currentFilters.loanType || 'Any'}\n`;
            reportContent += `Property Type: ${currentFilters.propertyType || 'Any'}\n`;
            reportContent += `Property Status: ${currentFilters.propertyStatus || 'Any'}\n`;
            reportContent += `Loan Amount: $${currentFilters.loanAmount ? currentFilters.loanAmount.toLocaleString() : 'Not specified'}\n`;
            reportContent += `Lock Period: ${currentFilters.lockPeriod || 'Any'} years\n`;
            reportContent += `Rate Type: ${currentFilters.rateType || 'Any'}\n`;
            reportContent += `Bank: ${currentFilters.bank || 'Any'}\n\n`;

            reportContent += `RECOMMENDED PACKAGES (${filteredPackages.length} found):\n`;
            reportContent += `==========================================\n\n`;

            filteredPackages.forEach((pkg, index) => {
                const rateType = rateTypes.find(rt => rt.rate_type_name === pkg.rate_type_name);
                const year1Rate = rateType ? rateType.year_1_rate : 0;
                const loanAmount = currentFilters.loanAmount || 500000;
                const monthlyRate = year1Rate / 100 / 12;
                const numPayments = 30 * 12;
                const monthlyPayment = monthlyRate > 0 ? 
                    loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / 
                    (Math.pow(1 + monthlyRate, numPayments) - 1) : 0;
                const totalInterest = (monthlyPayment * numPayments) - loanAmount;

                reportContent += `${index + 1}. ${pkg.bank_name} - ${pkg.rate_type_category} Rate\n`;
                reportContent += `   Year 1 Interest Rate: ${year1Rate.toFixed(2)}%\n`;
                reportContent += `   Monthly Payment: $${monthlyPayment.toLocaleString('en-SG', {maximumFractionDigits: 0})}\n`;
                reportContent += `   Total Interest (30 years): $${totalInterest.toLocaleString('en-SG', {maximumFractionDigits: 0})}\n`;
                reportContent += `   Lock Period: ${pkg.lock_period || 'N/A'}\n`;
                reportContent += `   Features: ${pkg.legal_fee_subsidy ? 'Legal Fee Subsidy, ' : ''}${pkg.valuation_subsidy ? 'Valuation Subsidy, ' : ''}${pkg.partial_repayment ? 'Partial Repayment' : ''}\n\n`;
            });

            reportContent += `\nNOTE:\n`;
            reportContent += `- Calculations are estimates based on available data\n`;
            reportContent += `- Interest rates may vary and are subject to bank approval\n`;
            reportContent += `- Please contact the respective banks for the latest rates and terms\n`;
            reportContent += `- This report is generated for comparison purposes only\n`;

            // Download as text file
            const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Recommended_Packages_Report_${new Date().toISOString().split('T')[0]}.txt`;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showNotification('Report downloaded successfully', 'success');
        }

        // Reset all filters
        function resetFilters() {
            document.getElementById('loanTypeFilter').value = '';
            document.getElementById('propertyTypeFilter').value = '';
            document.getElementById('propertyStatusFilter').value = '';
            document.getElementById('loanAmountFilter').value = '';
            document.getElementById('lockPeriodFilter').value = '';
            document.getElementById('rateTypeFilter').value = '';
            document.getElementById('bankFilter').value = '';

            filteredPackages = [];
            currentFilters = {};
            
            // Reset table
            const tbody = document.getElementById('packagesTableBody');
            const noDataRow = document.getElementById('noDataRow');
            Array.from(tbody.children).forEach(row => {
                if (row.id !== 'noDataRow') {
                    row.remove();
                }
            });
            noDataRow.style.display = 'table-row';
            
            updateResultsCount();
            showNotification('Filters reset', 'success');
        }

        // Utility functions
        function escapeHtml(text) {
            if (typeof text !== 'string') return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
    </script>
</body>
</html>
