<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recommended Packages - Keyquest Mortgage Admin</title>
    <link rel="stylesheet" href="css/admin-styles.css">
    <!-- Required Scripts in correct order -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/lucide.min.js"></script>
    <script src="config/supabase.js"></script>
    <script src="js/admin-scripts.js"></script>
    <style>
        /* Enhanced styles for recommended packages */
        .page-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 32px 24px;
            border-radius: 16px;
            margin-bottom: 32px;
            box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
        }

        .page-header h1 {
            margin: 0 0 8px 0;
            font-size: 28px;
            font-weight: 700;
        }

        .page-header p {
            margin: 0;
            opacity: 0.9;
            font-size: 16px;
        }

        .loan-type-tabs {
            display: flex;
            background: white;
            border-radius: 16px;
            padding: 6px;
            margin-bottom: 32px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .loan-tab {
            flex: 1;
            padding: 16px 20px;
            text-align: center;
            border-radius: 12px;
            border: none;
            background: transparent;
            color: #64748b;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 14px;
        }

        .loan-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
            transform: translateY(-2px);
        }

        .loan-tab:hover:not(.active) {
            background: #f8fafc;
            color: #475569;
            transform: translateY(-1px);
        }

        .search-section {
            background: white;
            border-radius: 20px;
            padding: 32px;
            margin-bottom: 32px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        }

        .search-section h3 {
            margin: 0 0 24px 0;
            font-size: 20px;
            font-weight: 700;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }

        .form-input, .form-select {
            padding: 14px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        .search-actions {
            display: flex;
            gap: 16px;
            justify-content: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 160px;
            justify-content: center;
            font-size: 15px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 14px 30px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 160px;
            justify-content: center;
            font-size: 15px;
        }

        .btn-secondary:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .results-container {
            background: white;
            border-radius: 20px;
            border: 1px solid #e2e8f0;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        }

        .results-header {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 24px 32px;
            border-bottom: 2px solid #e2e8f0;
        }

        .results-title {
            margin: 0 0 8px 0;
            font-size: 22px;
            font-weight: 700;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .results-subtitle {
            margin: 0;
            font-size: 14px;
            color: #6b7280;
        }

        .results-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .package-card {
            border-bottom: 2px solid #f8fafc;
            padding: 32px;
            transition: all 0.3s ease;
            position: relative;
        }

        .package-card:last-child {
            border-bottom: none;
        }

        .package-card:hover {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .package-rank {
            position: absolute;
            top: 24px;
            left: 24px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .package-rank.rank-1 {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4);
        }

        .package-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin: 0 0 24px 60px;
        }

        .bank-info {
            flex: 1;
        }

        .bank-name {
            font-size: 24px;
            font-weight: 800;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .package-type {
            font-size: 16px;
            color: #6b7280;
            font-weight: 500;
        }

        .rate-info {
            text-align: right;
        }

        .avg-rate {
            font-size: 28px;
            font-weight: 800;
            color: #059669;
            margin-bottom: 4px;
        }

        .rate-label {
            font-size: 12px;
            color: #6b7280;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .installment {
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
            margin-top: 8px;
        }

        .package-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            margin: 24px 0;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 16px;
            background: #f9fafb;
            border-radius: 10px;
            font-size: 14px;
            border: 1px solid #f1f5f9;
        }

        .detail-label {
            font-weight: 600;
            color: #6b7280;
        }

        .detail-value {
            font-weight: 700;
            color: #1f2937;
        }

        .rate-schedule {
            background: linear-gradient(135deg, #ecfdf5 0%, #f0fdf4 100%);
            border: 2px solid #bbf7d0;
            border-radius: 16px;
            padding: 24px;
            margin: 24px 0;
        }

        .rate-schedule-title {
            font-weight: 700;
            color: #065f46;
            margin-bottom: 16px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .rate-schedule-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }

        .rate-item {
            background: white;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid #d1fae5;
            transition: all 0.3s ease;
        }

        .rate-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
        }

        .rate-period {
            font-size: 12px;
            color: #6b7280;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .rate-value {
            font-size: 18px;
            font-weight: 800;
            color: #059669;
        }

        .package-remarks {
            background: #fef3c7;
            border: 2px solid #fcd34d;
            border-radius: 12px;
            padding: 16px;
            margin: 20px 0;
        }

        .remarks-title {
            font-weight: 700;
            color: #92400e;
            margin-bottom: 8px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .remarks-content {
            color: #92400e;
            font-size: 14px;
            line-height: 1.5;
        }

        .package-features {
            margin: 24px 0;
        }

        .features-title {
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 12px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .feature-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .feature-tag {
            background: #dbeafe;
            color: #1e40af;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            border: 1px solid #bfdbfe;
        }

        .feature-tag.positive {
            background: #dcfce7;
            color: #166534;
            border-color: #bbf7d0;
        }

        .package-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            justify-content: flex-end;
        }

        .btn-enquire {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-enquire:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .no-results {
            text-align: center;
            padding: 80px 32px;
            color: #6b7280;
        }

        .no-results-icon {
            font-size: 64px;
            margin-bottom: 24px;
            opacity: 0.5;
        }

        .no-results h3 {
            font-size: 24px;
            margin: 0 0 12px 0;
            color: #1f2937;
        }

        .no-results p {
            font-size: 16px;
            margin: 0;
        }

        .loading-state {
            text-align: center;
            padding: 80px 32px;
            color: #6b7280;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #f1f5f9;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 24px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .input-group {
            position: relative;
        }

        .input-prefix {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
            font-weight: 600;
            z-index: 1;
        }

        .input-group .form-input {
            padding-left: 48px;
        }

        /* Report Modal Styles */
        .report-modal .modal-content {
            max-width: 90vw;
            width: 1000px;
            max-height: 90vh;
        }

        .report-modal .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }

        .report-container {
            background: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .report-header {
            text-align: center;
            padding: 32px;
            border-bottom: 3px solid #667eea;
            margin-bottom: 32px;
        }

        .report-logo {
            font-size: 32px;
            font-weight: 800;
            color: #667eea;
            margin-bottom: 8px;
        }

        .report-title {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
            margin: 16px 0 8px 0;
        }

        .report-subtitle {
            color: #6b7280;
            font-size: 16px;
        }

        .report-summary {
            background: #f8fafc;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 32px;
            border: 1px solid #e2e8f0;
        }

        .report-summary h3 {
            margin: 0 0 16px 0;
            color: #1f2937;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .summary-item {
            text-align: center;
        }

        .summary-label {
            font-size: 12px;
            color: #6b7280;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .summary-value {
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
        }

        .report-package {
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            margin-bottom: 24px;
            overflow: hidden;
        }

        .report-package-header {
            background: #f8fafc;
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
        }

        .report-package-body {
            padding: 20px;
        }

        .report-rate-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 12px;
            margin: 16px 0;
        }

        .report-rate-item {
            text-align: center;
            padding: 12px;
            background: #f9fafb;
            border-radius: 8px;
        }

        @media print {
            .modal-header, .modal-footer {
                display: none !important;
            }
            
            .report-modal .modal-content {
                box-shadow: none;
                border: none;
                max-width: none;
                width: 100%;
                max-height: none;
            }
            
            .report-modal .modal-body {
                max-height: none;
                overflow: visible;
            }
        }

        @media (max-width: 768px) {
            .loan-type-tabs {
                flex-direction: column;
                gap: 8px;
            }

            .package-header {
                flex-direction: column;
                gap: 16px;
                margin-left: 0;
            }

            .package-rank {
                position: static;
                margin-bottom: 16px;
                align-self: flex-start;
            }

            .rate-info {
                text-align: left;
            }

            .package-actions {
                justify-content: stretch;
            }

            .btn-enquire {
                flex: 1;
                justify-content: center;
            }

            .package-details {
                grid-template-columns: 1fr;
            }

            .search-actions {
                flex-direction: column;
            }

            .btn-primary, .btn-secondary {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="overlay" id="overlay" onclick="closeSidebar()"></div>
    
    <div class="admin-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="index.html" class="logo">
                    <div class="logo-icon">
                        <i data-lucide="building-2"></i>
                    </div>
                    <span>KEYQUEST</span>
                </a>
            </div>
            <nav class="nav-menu">
                <a href="index.html" class="nav-item">
                    <i data-lucide="layout-dashboard"></i>
                    <span>Dashboard</span>
                </a>
                <a href="rate-packages.html" class="nav-item">
                    <i data-lucide="package"></i>
                    <span>Rate Package</span>
                </a>
                <a href="rate-types.html" class="nav-item">
                    <i data-lucide="percent"></i>
                    <span>Rate Type</span>
                </a>
                <a href="banks.html" class="nav-item">
                    <i data-lucide="landmark"></i>
                    <span>Bank</span>
                </a>
                <a href="bankers.html" class="nav-item">
                    <i data-lucide="briefcase"></i>
                    <span>Bankers</span>
                </a>
                <a href="agents.html" class="nav-item">
                    <i data-lucide="users"></i>
                    <span>Agents</span>
                </a>
                <a href="enquiry.html" class="nav-item">
                    <i data-lucide="help-circle"></i>
                    <span>Enquiry</span>
                </a>
                <a href="recommended-packages.html" class="nav-item active">
                    <i data-lucide="star"></i>
                    <span>Recommended Packages</span>
                </a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <header class="header">
                <div class="header-left">
                    <button class="menu-toggle" onclick="toggleSidebar()">
                        <i data-lucide="menu"></i>
                    </button>
                    <h1 class="header-title">
                        <i data-lucide="star"></i>
                        Recommended Packages
                    </h1>
                </div>
                <div class="header-right">
                    <div class="user-info" onclick="toggleUserDropdown()">
                        <div class="user-avatar" id="userAvatar">A</div>
                        <span class="user-name" id="userName">Admin</span>
                        <i data-lucide="chevron-down"></i>
                    </div>
                    <div class="user-dropdown" id="userDropdown">
                        <a href="#" onclick="confirmSignOut()">
                            <i data-lucide="log-out"></i>
                            Sign Out
                        </a>
                    </div>
                </div>
            </header>

            <div class="content">
                <!-- Page Header -->
                <div class="page-header">
                    <h1>Find Your Best Mortgage Rate</h1>
                    <p>Get personalized mortgage package recommendations ranked by average first 2 years interest rates</p>
                </div>

                <!-- Loan Type Tabs -->
                <div class="loan-type-tabs">
                    <button class="loan-tab active" onclick="selectLoanType('New Home Loan')" data-loan-type="New Home Loan">
                        <i data-lucide="home"></i>
                        New Home Loan
                    </button>
                    <button class="loan-tab" onclick="selectLoanType('Refinancing Home Loan')" data-loan-type="Refinancing Home Loan">
                        <i data-lucide="refresh-cw"></i>
                        Refinancing Home Loan
                    </button>
                    <button class="loan-tab" onclick="selectLoanType('Commercial/Industrial')" data-loan-type="Commercial/Industrial">
                        <i data-lucide="building"></i>
                        Commercial/Industrial
                    </button>
                </div>

                <!-- Search Section -->
                <div class="search-section">
                    <h3>
                        <i data-lucide="search"></i>
                        Search Criteria
                    </h3>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Property Type</label>
                            <select class="form-select" id="propertyType">
                                <option value="">Select Property Type</option>
                                <option value="HDB">HDB</option>
                                <option value="Private Property">Private Property</option>
                                <option value="EC">EC</option>
                                <option value="Commercial">Commercial</option>
                                <option value="Industrial">Industrial</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Property Status</label>
                            <select class="form-select" id="propertyStatus">
                                <option value="">Select Property Status</option>
                                <option value="Completed">Completed</option>
                                <option value="Under Construction">Under Construction</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Buy Under</label>
                            <select class="form-select" id="buyUnder">
                                <option value="">Select Buy Under</option>
                                <option value="Individual Name">Individual Name</option>
                                <option value="Company Operating">Company Operating</option>
                                <option value="Company Investment Holding">Company Investment Holding</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Loan Amount</label>
                            <div class="input-group">
                                <span class="input-prefix">S$</span>
                                <input type="number" class="form-input" id="loanAmount" placeholder="500,000" min="0" step="1000">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Loan Tenure (Years)</label>
                            <select class="form-select" id="loanTenure">
                                <option value="">Select Tenure</option>
                                <option value="5">5 years</option>
                                <option value="10">10 years</option>
                                <option value="15">15 years</option>
                                <option value="20">20 years</option>
                                <option value="25">25 years</option>
                                <option value="30">30 years</option>
                                <option value="35">35 years</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Preferred Rate Type</label>
                            <select class="form-select" id="rateType">
                                <option value="">Any Rate Type</option>
                                <option value="Fixed">Fixed</option>
                                <option value="Floating">Floating</option>
                            </select>
                        </div>
                    </div>

                    <div class="search-actions">
                        <button class="btn-primary" onclick="searchPackages()">
                            <i data-lucide="search"></i>
                            Find Best Rates
                        </button>
                        <button class="btn-secondary" onclick="clearFilters()">
                            <i data-lucide="refresh-ccw"></i>
                            Clear Filters
                        </button>
                    </div>
                </div>

                <!-- Results Container -->
                <div class="results-container" id="resultsContainer" style="display: none;">
                    <div class="results-header">
                        <h2 class="results-title">
                            <i data-lucide="trending-down"></i>
                            Recommended Packages
                        </h2>
                        <p class="results-subtitle" id="resultsSubtitle">Ranked by average first 2 years interest rates</p>
                        <div class="results-actions">
                            <button class="btn-secondary" onclick="generateReport()">
                                <i data-lucide="file-text"></i>
                                Generate Report
                            </button>
                            <button class="btn-secondary" onclick="exportResults()">
                                <i data-lucide="download"></i>
                                Export CSV
                            </button>
                        </div>
                    </div>
                    <div id="resultsContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Professional Report Modal -->
    <div class="modal report-modal" id="report-modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Professional Mortgage Report</h3>
                    <button class="modal-close" onclick="closeModal('report-modal')">
                        <i data-lucide="x"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="report-container" id="reportContent">
                        <!-- Report content will be generated here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeModal('report-modal')">Close</button>
                    <button class="btn-primary" onclick="printReport()">
                        <i data-lucide="printer"></i>
                        Print Report
                    </button>
                    <button class="btn-primary" onclick="downloadReportPDF()">
                        <i data-lucide="download"></i>
                        Download PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Sign Out Modal -->
    <div class="modal" id="signout-modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Confirm Sign Out</h3>
                    <button class="modal-close" onclick="closeModal('signout-modal')">
                        <i data-lucide="x"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to sign out?</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal('signout-modal')">Cancel</button>
                    <button class="btn btn-danger" onclick="performSignOut()">Sign Out</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p id="loading-text">Loading...</p>
        </div>
    </div>

    <script>
        // Global variables
        let currentLoanType = 'New Home Loan';
        let allPackages = [];
        let rateTypes = [];
        let currentResults = [];
        let searchCriteria = {};
        let isLoading = false;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Initializing Recommended Packages page...');
            
            // Check authentication first
            checkAuthentication();
            
            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            
            // Check if Supabase is available
            if (typeof supabaseClient === 'undefined') {
                console.error('❌ Supabase client not available');
                showNotification('System initialization failed. Please refresh the page.', 'error');
                return;
            }
            
            console.log('✅ System initialized successfully');
            
            // Load initial data
            loadRateTypes();
            loadPackages();
        });

        // Authentication check
        async function checkAuthentication() {
            try {
                const { data: { user }, error } = await supabaseClient.auth.getUser();
                
                if (error || !user) {
                    window.location.href = 'login.html';
                    return;
                }
                
                // Update user info in header
                const userName = document.getElementById('userName');
                const userAvatar = document.getElementById('userAvatar');
                
                if (userName && user.email) {
                    userName.textContent = user.email.split('@')[0];
                }
                if (userAvatar && user.email) {
                    userAvatar.textContent = user.email.charAt(0).toUpperCase();
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = 'login.html';
            }
        }

        // Load rate types for calculations
        async function loadRateTypes() {
            try {
                const { data, error } = await supabaseClient
                    .from('rate_types')
                    .select('rate_type, rate_value')
                    .order('rate_type');

                if (error) throw error;
                rateTypes = data || [];
            } catch (error) {
                console.error('Error loading rate types:', error);
            }
        }

        // Load all packages
        async function loadPackages() {
            try {
                const { data, error } = await supabaseClient
                    .from('rate_packages')
                    .select('*')
                    .order('bank_name');

                if (error) throw error;

                allPackages = data || [];
                console.log(`Loaded ${allPackages.length} packages`);
                
            } catch (error) {
                console.error('Error loading packages:', error);
                showNotification('Error loading packages', 'error');
            }
        }

        // Select loan type
        function selectLoanType(loanType) {
            currentLoanType = loanType;
            
            // Update tab states
            document.querySelectorAll('.loan-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.loanType === loanType) {
                    tab.classList.add('active');
                }
            });
            
            // Clear previous results
            document.getElementById('resultsContainer').style.display = 'none';
        }

        // Calculate interest rate for a specific year
        function calculateInterestRate(pkg, year) {
            if (!pkg || !rateTypes.length) return 0;

            let rateType, operator, value;
            
            if (year === 'thereafter') {
                rateType = pkg.thereafter_rate_type;
                operator = pkg.thereafter_operator;
                value = pkg.thereafter_value;
            } else {
                rateType = pkg[`year${year}_rate_type`];
                operator = pkg[`year${year}_operator`];
                value = pkg[`year${year}_value`];
            }

            if (!rateType || !value) return 0;

            // Find the base rate
            const rateTypeData = rateTypes.find(rt => rt.rate_type === rateType);
            const baseRate = rateTypeData ? parseFloat(rateTypeData.rate_value) : 0;
            
            const adjustment = parseFloat(value) || 0;
            const multiplier = operator === '-' ? -1 : 1;
            
            return baseRate + (adjustment * multiplier);
        }

        // Calculate average of first 2 years interest rates
        function calculateAverageFirst2Years(pkg) {
            const year1Rate = calculateInterestRate(pkg, 1);
            const year2Rate = calculateInterestRate(pkg, 2);
            
            if (year1Rate === 0 && year2Rate === 0) return 0;
            if (year1Rate === 0) return year2Rate;
            if (year2Rate === 0) return year1Rate;
            
            return (year1Rate + year2Rate) / 2;
        }

        // Calculate monthly installment
        function calculateMonthlyInstallment(principal, annualRate, years) {
            if (!principal || !annualRate || !years) return 0;
            
            const monthlyRate = annualRate / 100 / 12;
            const numPayments = years * 12;
            
            if (monthlyRate === 0) return principal / numPayments;
            
            const monthlyPayment = principal * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / 
                                  (Math.pow(1 + monthlyRate, numPayments) - 1);
            
            return monthlyPayment;
        }

        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-SG', {
                style: 'currency',
                currency: 'SGD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        // Format percentage
        function formatPercentage(rate) {
            return `${rate.toFixed(3)}%`;
        }

        // Clear all filters
        function clearFilters() {
            document.getElementById('propertyType').value = '';
            document.getElementById('propertyStatus').value = '';
            document.getElementById('buyUnder').value = '';
            document.getElementById('loanAmount').value = '';
            document.getElementById('loanTenure').value = '';
            document.getElementById('rateType').value = '';
            
            // Clear results
            document.getElementById('resultsContainer').style.display = 'none';
            currentResults = [];
            searchCriteria = {};
        }

        // Search packages
        async function searchPackages() {
            if (isLoading) return;

            // Get form values
            const propertyType = document.getElementById('propertyType').value;
            const propertyStatus = document.getElementById('propertyStatus').value;
            const buyUnder = document.getElementById('buyUnder').value;
            const loanAmount = parseFloat(document.getElementById('loanAmount').value);
            const loanTenure = parseInt(document.getElementById('loanTenure').value);
            const rateType = document.getElementById('rateType').value;

            // Store search criteria for report generation
            searchCriteria = {
                loanType: currentLoanType,
                propertyType,
                propertyStatus,
                buyUnder,
                loanAmount,
                loanTenure,
                rateType
            };

            // Validation
            if (!loanAmount || loanAmount <= 0) {
                showNotification('Please enter a valid loan amount', 'error');
                return;
            }

            if (!loanTenure) {
                showNotification('Please select loan tenure', 'error');
                return;
            }

            isLoading = true;
            showLoading('Searching for best rates...');

            try {
                // Filter packages based on criteria
                let filteredPackages = allPackages.filter(pkg => {
                    // Must match loan type
                    if (pkg.loan_type !== currentLoanType) return false;
                    
                    // Filter by property type if specified
                    if (propertyType && pkg.property_type !== propertyType) return false;
                    
                    // Filter by property status if specified
                    if (propertyStatus && pkg.property_status !== propertyStatus) return false;
                    
                    // Filter by buy under if specified
                    if (buyUnder && pkg.buy_under !== buyUnder) return false;
                    
                    // Filter by rate type if specified
                    if (rateType && pkg.rate_type_category !== rateType) return false;
                    
                    // Check minimum loan size
                    if (pkg.minimum_loan_size && loanAmount < parseFloat(pkg.minimum_loan_size)) return false;
                    
                    return true;
                });

                // Calculate rates and sort by average first 2 years
                const packagesWithRates = filteredPackages.map(pkg => {
                    const avgFirst2Years = calculateAverageFirst2Years(pkg);
                    const year1Rate = calculateInterestRate(pkg, 1);
                    const monthlyInstallment = calculateMonthlyInstallment(loanAmount, avgFirst2Years, loanTenure);
                    
                    return {
                        ...pkg,
                        avgFirst2Years,
                        year1Rate,
                        year2Rate: calculateInterestRate(pkg, 2),
                        monthlyInstallment,
                        totalSavings: calculateTotalSavings(pkg, loanAmount, loanTenure)
                    };
                }).filter(pkg => pkg.avgFirst2Years > 0) // Only include packages with valid rates
                  .sort((a, b) => a.avgFirst2Years - b.avgFirst2Years); // Sort by lowest average rate first

                currentResults = packagesWithRates;
                displayResults(packagesWithRates, loanAmount, loanTenure);
                
            } catch (error) {
                console.error('Error searching packages:', error);
                showNotification('Error searching packages', 'error');
            } finally {
                isLoading = false;
                hideLoading();
            }
        }

        // Calculate total savings over loan period
        function calculateTotalSavings(pkg, loanAmount, loanTenure) {
            let totalInterest = 0;
            const monthlyPrincipal = loanAmount / (loanTenure * 12);
            let remainingBalance = loanAmount;

            for (let year = 1; year <= loanTenure; year++) {
                const rate = calculateInterestRate(pkg, year <= 5 ? year : 'thereafter');
                const annualInterest = remainingBalance * (rate / 100);
                totalInterest += annualInterest;
                remainingBalance -= (monthlyPrincipal * 12);
                
                if (remainingBalance <= 0) break;
            }

            return loanAmount - totalInterest;
        }

        // Display search results
        function displayResults(packages, loanAmount, loanTenure) {
            const resultsContainer = document.getElementById('resultsContainer');
            const resultsContent = document.getElementById('resultsContent');
            const resultsSubtitle = document.getElementById('resultsSubtitle');

            if (packages.length === 0) {
                resultsContent.innerHTML = `
                    <div class="no-results">
                        <div class="no-results-icon">🔍</div>
                        <h3>No packages found</h3>
                        <p>No mortgage packages match your criteria. Try adjusting your search parameters.</p>
                    </div>
                `;
            } else {
                resultsSubtitle.textContent = `We found ${packages.length} package(s) for ${formatCurrency(loanAmount)} over ${loanTenure} years`;
                
                resultsContent.innerHTML = packages.map((pkg, index) => {
                    const rateSchedule = generateRateSchedule(pkg);
                    const features = generatePackageFeatures(pkg);
                    
                    return `
                        <div class="package-card">
                            <div class="package-rank ${index === 0 ? 'rank-1' : ''}">${index + 1}</div>
                            
                            <div class="package-header">
                                <div class="bank-info">
                                    <div class="bank-name">${pkg.bank_name}</div>
                                    <div class="package-type">${pkg.rate_type_category} Rate • ${pkg.lock_period || 'No Lock-in'}</div>
                                </div>
                                <div class="rate-info">
                                    <div class="avg-rate">${formatPercentage(pkg.avgFirst2Years)}</div>
                                    <div class="rate-label">Avg First 2 Years</div>
                                    <div class="installment">${formatCurrency(pkg.monthlyInstallment)}/mo</div>
                                </div>
                            </div>

                            <div class="package-details">
                                <div class="detail-item">
                                    <span class="detail-label">Property Type:</span>
                                    <span class="detail-value">${pkg.property_type}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Property Status:</span>
                                    <span class="detail-value">${pkg.property_status}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Buy Under:</span>
                                    <span class="detail-value">${pkg.buy_under}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Min. Loan Size:</span>
                                    <span class="detail-value">${formatCurrency(pkg.minimum_loan_size || 0)}</span>
                                </div>
                            </div>

                            ${rateSchedule ? `
                                <div class="rate-schedule">
                                    <div class="rate-schedule-title">
                                        <i data-lucide="trending-up"></i>
                                        Interest Rate Schedule
                                    </div>
                                    <div class="rate-schedule-grid">
                                        ${rateSchedule}
                                    </div>
                                </div>
                            ` : ''}

                            ${pkg.remarks ? `
                                <div class="package-remarks">
                                    <div class="remarks-title">
                                        <i data-lucide="info"></i>
                                        Important Notes
                                    </div>
                                    <div class="remarks-content">${pkg.remarks}</div>
                                </div>
                            ` : ''}

                            ${features ? `
                                <div class="package-features">
                                    <div class="features-title">
                                        <i data-lucide="check-circle"></i>
                                        Package Features
                                    </div>
                                    <div class="feature-tags">
                                        ${features}
                                    </div>
                                </div>
                            ` : ''}

                            <div class="package-actions">
                                <button class="btn-enquire" onclick="enquirePackage('${pkg.id}')">
                                    <i data-lucide="mail"></i>
                                    Enquire Now
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            resultsContainer.style.display = 'block';
            resultsContainer.scrollIntoView({ behavior: 'smooth' });
            
            // Re-initialize Lucide icons for new content
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        // Generate rate schedule
        function generateRateSchedule(pkg) {
            const rates = [];
            
            for (let year = 1; year <= 5; year++) {
                const rate = calculateInterestRate(pkg, year);
                if (rate > 0) {
                    rates.push(`
                        <div class="rate-item">
                            <div class="rate-period">Year ${year}</div>
                            <div class="rate-value">${formatPercentage(rate)}</div>
                        </div>
                    `);
                }
            }

            const thereafterRate = calculateInterestRate(pkg, 'thereafter');
            if (thereafterRate > 0) {
                rates.push(`
                    <div class="rate-item">
                        <div class="rate-period">Thereafter</div>
                        <div class="rate-value">${formatPercentage(thereafterRate)}</div>
                    </div>
                `);
            }

            return rates.join('');
        }

        // Generate package features
        function generatePackageFeatures(pkg) {
            const features = [];
            
            if (pkg.legal_fee_subsidy === 'true' || pkg.legal_fee_subsidy === true) {
                features.push('<span class="feature-tag positive">Legal Fee Subsidy</span>');
            }
            
            if (pkg.valuation_subsidy === 'true' || pkg.valuation_subsidy === true) {
                features.push('<span class="feature-tag positive">Valuation Subsidy</span>');
            }
            
            if (pkg.partial_repayment === 'true' || pkg.partial_repayment === true) {
                features.push('<span class="feature-tag">Partial Repayment</span>');
            }
            
            if (pkg.waiver_due_to_sales === 'thinking>
Now I need to add more functions for the report generation, export functionality, and other features. Let me continue with the rest of the JavaScript code.
</thinking>

true || pkg.waiver_due_to_sales === true) {
                features.push('<span class="feature-tag">Waiver Due to Sales</span>');
            }

            if (pkg.free_package_conversion_12m === 'true' || pkg.free_package_conversion_12m === true) {
                features.push('<span class="feature-tag">Free Package Conversion (12M)</span>');
            }

            if (pkg.free_package_conversion_24m === 'true' || pkg.free_package_conversion_24m === true) {
                features.push('<span class="feature-tag">Free Package Conversion (24M)</span>');
            }

            if (pkg.free_package_conversion_36m === 'true' || pkg.free_package_conversion_36m === true) {
                features.push('<span class="feature-tag">Free Package Conversion (36M)</span>');
            }

            return features.join('');
        }

        // Generate Professional Report
        function generateReport() {
            if (!currentResults.length) {
                showNotification('No results to generate report', 'error');
                return;
            }

            const reportContent = document.getElementById('reportContent');
            const reportDate = new Date().toLocaleDateString('en-SG', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            const bestPackage = currentResults[0];

            reportContent.innerHTML = `
                <div class="report-header">
                    <div class="report-logo">KEYQUEST MORTGAGE</div>
                    <div class="report-title">Mortgage Package Recommendation Report</div>
                    <div class="report-subtitle">Generated on ${reportDate}</div>
                </div>

                <div class="report-summary">
                    <h3>Search Summary</h3>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-label">Loan Type</div>
                            <div class="summary-value">${searchCriteria.loanType}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Loan Amount</div>
                            <div class="summary-value">${formatCurrency(searchCriteria.loanAmount)}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Loan Tenure</div>
                            <div class="summary-value">${searchCriteria.loanTenure} years</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Property Type</div>
                            <div class="summary-value">${searchCriteria.propertyType || 'Any'}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Property Status</div>
                            <div class="summary-value">${searchCriteria.propertyStatus || 'Any'}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Packages Found</div>
                            <div class="summary-value">${currentResults.length}</div>
                        </div>
                    </div>
                </div>

                <h3 style="color: #1f2937; margin: 32px 0 16px 0;">Recommended Packages (Ranked by Average First 2 Years Interest Rate)</h3>

                ${currentResults.map((pkg, index) => `
                    <div class="report-package">
                        <div class="report-package-header">
                            <h4 style="margin: 0; color: #1f2937; display: flex; align-items: center; gap: 12px;">
                                <span style="background: ${index === 0 ? '#fbbf24' : '#10b981'}; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700;">
                                    ${index + 1}
                                </span>
                                ${pkg.bank_name} - ${pkg.rate_type_category} Rate Package
                            </h4>
                            <div style="margin-top: 8px; display: flex; gap: 24px;">
                                <span><strong>Average First 2 Years Rate:</strong> ${formatPercentage(pkg.avgFirst2Years)}</span>
                                <span><strong>Monthly Installment:</strong> ${formatCurrency(pkg.monthlyInstallment)}</span>
                            </div>
                        </div>
                        <div class="report-package-body">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 16px;">
                                <div><strong>Property Type:</strong> ${pkg.property_type}</div>
                                <div><strong>Property Status:</strong> ${pkg.property_status}</div>
                                <div><strong>Buy Under:</strong> ${pkg.buy_under}</div>
                                <div><strong>Lock Period:</strong> ${pkg.lock_period || 'No Lock-in'}</div>
                                <div><strong>Min. Loan Size:</strong> ${formatCurrency(pkg.minimum_loan_size || 0)}</div>
                            </div>

                            <div>
                                <strong>Interest Rate Schedule:</strong>
                                <div class="report-rate-grid">
                                    ${[1, 2, 3, 4, 5].map(year => {
                                        const rate = calculateInterestRate(pkg, year);
                                        return rate > 0 ? `
                                            <div class="report-rate-item">
                                                <div style="font-size: 12px; color: #6b7280;">Year ${year}</div>
                                                <div style="font-weight: 700; color: #059669;">${formatPercentage(rate)}</div>
                                            </div>
                                        ` : '';
                                    }).join('')}
                                    ${calculateInterestRate(pkg, 'thereafter') > 0 ? `
                                        <div class="report-rate-item">
                                            <div style="font-size: 12px; color: #6b7280;">Thereafter</div>
                                            <div style="font-weight: 700; color: #059669;">${formatPercentage(calculateInterestRate(pkg, 'thereafter'))}</div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>

                            ${pkg.remarks ? `
                                <div style="margin-top: 16px; padding: 12px; background: #fef3c7; border-radius: 8px; border: 1px solid #fcd34d;">
                                    <strong style="color: #92400e;">Important Notes:</strong>
                                    <div style="color: #92400e; margin-top: 4px;">${pkg.remarks}</div>
                                </div>
                            ` : ''}

                            ${generatePackageFeatures(pkg) ? `
                                <div style="margin-top: 16px;">
                                    <strong>Package Features:</strong>
                                    <div style="margin-top: 8px;">
                                        ${generatePackageFeatures(pkg).replace(/feature-tag/g, 'feature-tag').replace(/<span class="feature-tag([^"]*)">/g, '<span style="display: inline-block; padding: 4px 8px; margin: 2px; background: #dbeafe; color: #1e40af; border-radius: 12px; font-size: 12px; font-weight: 500;">')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `).join('')}

                <div style="margin-top: 32px; padding: 24px; background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0;">
                    <h4 style="margin: 0 0 12px 0; color: #1f2937;">Disclaimer</h4>
                    <p style="margin: 0; font-size: 14px; color: #6b7280; line-height: 1.6;">
                        This report is generated based on current market rates and package information available at the time of generation. 
                        Interest rates and terms are subject to change based on market conditions and bank policies. 
                        Please consult with our mortgage specialists for the most up-to-date information and personalized advice.
                    </p>
                </div>

                <div style="margin-top: 24px; text-align: center; color: #6b7280; font-size: 12px;">
                    <p>Report generated by Keyquest Mortgage - ${reportDate}</p>
                </div>
            `;

            openModal('report-modal');
        }

        // Print Report
        function printReport() {
            window.print();
        }

        // Download Report as PDF (simplified version)
        function downloadReportPDF() {
            // For a full PDF solution, you would integrate with a library like jsPDF
            // For now, we'll trigger the print dialog which allows saving as PDF
            showNotification('Use your browser\'s print function and select "Save as PDF" to download', 'info');
            printReport();
        }

        // Export Results to CSV
        function exportResults() {
            if (!currentResults.length) {
                showNotification('No results to export', 'error');
                return;
            }

            const headers = [
                'Rank', 'Bank Name', 'Avg First 2 Years Rate (%)', 'Year 1 Rate (%)', 'Year 2 Rate (%)', 
                'Monthly Installment (SGD)', 'Property Type', 'Property Status', 'Buy Under', 
                'Rate Type', 'Lock Period', 'Min Loan Size (SGD)', 'Remarks'
            ];

            const csvContent = [
                headers.join(','),
                ...currentResults.map((pkg, index) => [
                    index + 1,
                    `"${pkg.bank_name}"`,
                    pkg.avgFirst2Years.toFixed(3),
                    pkg.year1Rate.toFixed(3),
                    pkg.year2Rate.toFixed(3),
                    pkg.monthlyInstallment.toFixed(2),
                    `"${pkg.property_type}"`,
                    `"${pkg.property_status}"`,
                    `"${pkg.buy_under}"`,
                    `"${pkg.rate_type_category}"`,
                    `"${pkg.lock_period || 'No Lock-in'}"`,
                    (pkg.minimum_loan_size || 0),
                    `"${(pkg.remarks || '').replace(/"/g, '""')}"`
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const filename = `mortgage_recommendations_${new Date().toISOString().split('T')[0]}.csv`;
            
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showNotification('Report exported successfully', 'success');
        }

        // Enquire about package
        function enquirePackage(packageId) {
            // Navigate to enquiry page with package pre-selected
            window.location.href = `enquiry.html?package=${packageId}`;
        }

        // Utility functions
        function showLoading(message = 'Loading...') {
            document.getElementById('loading-text').textContent = message;
            document.getElementById('loading-overlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }

        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            
            const colors = {
                success: { bg: '#dcfce7', border: '#16a34a', text: '#15803d' },
                error: { bg: '#fef2f2', border: '#dc2626', text: '#dc2626' },
                info: { bg: '#dbeafe', border: '#2563eb', text: '#1d4ed8' }
            };

            const color = colors[type] || colors.info;

            notification.innerHTML = `
                <div style="
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: ${color.bg};
                    border: 1px solid ${color.border};
                    color: ${color.text};
                    padding: 16px 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                    z-index: 10000;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    font-size: 14px;
                    font-weight: 500;
                    max-width: 400px;
                    animation: slideIn 0.3s ease-out;
                ">
                    ${message}
                </div>
                <style>
                    @keyframes slideIn {
                        from {
                            transform: translateX(100%);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(0);
                            opacity: 1;
                        }
                    }
                </style>
            `;

            document.body.appendChild(notification);

            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        // Sidebar functions
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            
            sidebar.classList.remove('open');
            overlay.classList.remove('active');
        }

        // User dropdown functions
        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('show');
        }

        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Sign out functions
        function confirmSignOut() {
            openModal('signout-modal');
        }

        async function performSignOut() {
            try {
                showLoading('Signing out...');
                
                const { error } = await supabaseClient.auth.signOut();
                if (error) throw error;
                
                // Clear any stored data
                localStorage.clear();
                sessionStorage.clear();
                
                // Redirect to login
                window.location.href = 'login.html';
                
            } catch (error) {
                console.error('Sign out error:', error);
                showNotification('Sign out failed: ' + error.message, 'error');
            } finally {
                hideLoading();
                closeModal('signout-modal');
            }
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            const userDropdown = document.getElementById('userDropdown');
            const userInfo = document.querySelector('.user-info');
            
            if (!userInfo.contains(event.target)) {
                userDropdown.classList.remove('show');
            }
        });
    </script>
</body>
</html>
