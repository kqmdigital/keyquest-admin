<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recommended Packages - Keyquest Mortgage Admin</title>
    <link rel="stylesheet" href="css/admin-styles.css">
    <!-- Required Scripts in correct order -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/lucide.min.js"></script>
    <script src="config/supabase.js"></script>
    <script src="js/admin-scripts.js"></script>
    <style>
        /* Enhanced Recommended Packages Styles */
        .page-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 32px;
            border-radius: 20px;
            margin-bottom: 32px;
            box-shadow: 0 12px 40px rgba(102, 126, 234, 0.25);
            position: relative;
            overflow: hidden;
        }

        .page-header::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 200px;
            height: 200px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transform: translate(50%, -50%);
        }

        .page-header h1 {
            margin: 0 0 12px 0;
            font-size: 32px;
            font-weight: 800;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .page-header p {
            margin: 0;
            opacity: 0.95;
            font-size: 16px;
            font-weight: 500;
        }

        /* Enhanced Loan Type Tabs */
        .loan-type-tabs {
            display: flex;
            background: white;
            border-radius: 20px;
            padding: 8px;
            margin-bottom: 32px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
            backdrop-filter: blur(10px);
        }

        .loan-tab {
            flex: 1;
            padding: 20px 24px;
            text-align: center;
            border-radius: 16px;
            border: none;
            background: transparent;
            color: #64748b;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-size: 15px;
            position: relative;
            overflow: hidden;
        }

        .loan-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
            transition: left 0.6s;
        }

        .loan-tab:hover::before {
            left: 100%;
        }

        .loan-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
        }

        .loan-tab:hover:not(.active) {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            color: #475569;
            transform: translateY(-2px);
        }

        /* Enhanced Search Section */
       .search-section {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border-radius: 20px;
    padding: 32px;
    margin-bottom: 32px;
    border: 1px solid #e2e8f0;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
    position: relative;
    overflow: visible; /* CHANGED from hidden to visible */
}

        

        .multi-select-filter.open::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.1);
    z-index: 999;
    backdrop-filter: blur(2px);
    pointer-events: none; /* Allow clicking through */
}

        .search-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2, #10b981);
        }

        .search-form {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
    align-items: end;
    max-width: none;
    overflow: visible; /* ADD THIS */
}
        /* Special styling for action buttons */
.form-group:has(.search-button) {
    grid-column: span 1;
    min-width: auto;
    
}

        .form-hint {
    font-size: 12px;
    color: #6b7280;
    margin-top: 4px;
    font-style: italic;
}

.savings-highlight {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    padding: 8px 12px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 14px;
    display: inline-block;
    margin-top: 8px;
}

.savings-negative {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
}

        .total-savings-compact {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white !important;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 12px !important;
    font-weight: 700;
    text-align: right;
    margin-top: 8px;
    box-shadow: 0 2px 6px rgba(16, 185, 129, 0.3);
    white-space: nowrap;
}

.total-savings-compact.negative {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
}

/* Button group for search and clear actions */
.button-group {
    display: flex;
    gap: 12px;
    grid-column: span 2;
    justify-content: flex-start;
    align-items: end;
}

        /* Enhanced filter section organization */
.filter-section {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 16px;
    border-left: 4px solid #667eea;
}

.filter-section h4 {
    margin: 0 0 16px 0;
    color: #374151;
    font-size: 14px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: flex;
    align-items: center;
    gap: 8px;
}

        /* Enhanced form labels with icons */
.form-label.with-icon {
    display: flex;
    align-items: center;
    gap: 6px;
}

.form-label.with-icon i {
    width: 14px;
    height: 14px;
    opacity: 0.7;
}

        /* Filter indicator badges */
.filter-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    font-size: 11px;
    font-weight: 600;
    padding: 4px 8px;
    border-radius: 12px;
    margin-left: 8px;
}

.filter-badge.active {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
}

/* Clear button enhanced styling */
.search-button.clear-button {
    background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
}

.search-button.clear-button:hover {
    background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
    transform: translateY(-2px);
}

/* Active filter indication */
.form-select.has-value {
    border-color: #667eea;
    background: linear-gradient(135deg, #ffffff 0%, #f0f4ff 100%);
}

.form-input.has-value {
    border-color: #667eea;
    background: linear-gradient(135deg, #ffffff 0%, #f0f4ff 100%);
}

/* Filter summary section */
.active-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 16px;
    padding: 12px 0;
}

.filter-chip {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: #e0f2fe;
    color: #0c4a6e;
    font-size: 12px;
    font-weight: 500;
    padding: 6px 12px;
    border-radius: 16px;
    border: 1px solid #bae6fd;
}

.filter-chip .remove-filter {
    cursor: pointer;
    color: #64748b;
    transition: color 0.2s;
}

.filter-chip .remove-filter:hover {
    color: #dc2626;
}

        /* Responsive adjustments for enhanced filters */
@media (max-width: 1200px) {
    .search-form {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
    }
}

@media (max-width: 768px) {
    .search-form {
        grid-template-columns: 1fr;
        gap: 16px;
    }
    
    .button-group {
        grid-column: span 1;
        flex-direction: column;
        gap: 12px;
    }
    
    .filter-chip {
        font-size: 11px;
        padding: 4px 8px;
    }
        .package-header {
        margin-bottom: 8px;
        min-height: auto;
    }
    
    .rate-schedule {
        margin: 8px 0;
    }
    
    .rate-schedule-title {
        margin-bottom: 8px;
    }
}

/* Loading state for individual filters */
.form-select.loading {
    background-image: url("data:image/svg+xml,%3csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M10 3.5a6.5 6.5 0 1 0 6.5 6.5h-1.5a5 5 0 1 1-5-5v1.5z' fill='%236b7280'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 16px 16px;
    animation: spin 1s linear infinite;
}

/* Enhanced search section header */
.search-section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
}

.search-section-title {
    font-size: 18px;
    font-weight: 700;
    color: #1e293b;
    display: flex;
    align-items: center;
    gap: 10px;
}

.filter-count {
    background: #667eea;
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
}
        
        .form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
    min-width: 200px;
    position: relative; /* ADD THIS */
    overflow: visible; /* ADD THIS */
}
        /* Enhanced multi-select dropdown positioning */
.multi-select-filter {
    position: relative;
    min-width: 180px;
    flex: 1;
    max-width: 250px;
    z-index: 100; /* ADD THIS */
}

.multi-select-dropdown {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); /* Enhanced shadow */
    z-index: 1000; /* Increased z-index */
    max-height: 250px;
    overflow-y: auto;
    margin-top: 4px;
    min-width: 200px; /* ADD THIS to prevent narrow dropdowns */
}

/* Ensure dropdown appears above everything */
.multi-select-filter.open .multi-select-dropdown {
    z-index: 9999; /* Even higher when open */
}

/* Fix for mobile/responsive - ensure dropdown doesn't get cut off */
@media (max-width: 768px) {
    .multi-select-dropdown {
        position: fixed; /* Use fixed positioning on mobile */
        left: 10px;
        right: 10px;
        max-width: calc(100vw - 20px);
        z-index: 9999;
    }
}

        .form-label {
            font-weight: 600;
            color: #374151;
            font-size: 14px;
            letter-spacing: 0.025em;
        }

        .form-input,
        .form-select {
            padding: 14px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 14px;
            background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: inherit;
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            background: #ffffff;
            transform: translateY(-2px);
        }

        .search-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }

        .search-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s;
        }

        .search-button:hover::before {
            left: 100%;
        }

        .search-button:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6b4190 100%);
            transform: translateY(-3px);
            box-shadow: 0 12px 32px rgba(102, 126, 234, 0.4);
        }

        /* Enhanced Results Section */
        .results-section {
            background: white;
            border-radius: 20px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .results-header {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    padding: 16px 24px; /* Reduced from 24px 32px */
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    flex-wrap: wrap;
    gap: 16px; /* Reduced from 20px */
}

.results-actions {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 12px; /* Adds spacing between the two groups */
    }

  .report-options {
        display: flex;
        align-items: center;
        gap: 16px;
        flex-wrap: wrap;
    }

.option-group {
        display: flex;
        align-items: center;
        gap: 6px;
    }

.option-label {
    font-size: 13px; /* Reduced from 14px */
    font-weight: 600;
    color: #374151;
    min-width: 75px; /* Reduced from 80px */
}

.client-name-input {
    flex: 1;
    padding: 6px 10px; /* Reduced from 8px 12px */
    border: 2px solid #e2e8f0;
    border-radius: 6px; /* Reduced from 8px */
    font-size: 13px; /* Reduced from 14px */
    background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
    transition: all 0.3s ease;
}

        .client-name-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            background: #ffffff;
        }

        .client-name-input::placeholder {
            color: #9ca3af;
            font-style: italic;
        }

        .option-checkbox {
            width: 16px;
            height: 16px;
            accent-color: #667eea;
            cursor: pointer;
        }

      .option-checkbox-label {
    font-size: 13px; /* Reduced from 14px */
    font-weight: 600;
    color: #374151;
    cursor: pointer;
    user-select: none;
}

.action-buttons {
    display: flex;
    gap: 8px; /* Reduced from 12px */
    flex-wrap: wrap;
}

.results-title {
    font-size: 18px; /* Reduced from 20px */
    font-weight: 700;
    color: #1e293b;
    display: flex;
    align-items: center;
    gap: 10px; /* Reduced from 12px */
}

.results-count {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 4px 12px; /* Reduced from 6px 16px */
    border-radius: 16px; /* Reduced from 20px */
    font-size: 13px; /* Reduced from 14px */
    font-weight: 600;
}

.download-btn {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    border: none;
    padding: 8px 16px; /* Reduced from 12px 20px */
    border-radius: 8px; /* Reduced from 10px */
    font-size: 13px; /* Reduced from 14px */
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 6px; /* Reduced from 8px */
}

        .download-btn:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3);
        }

        /* Enhanced Package Cards */
        .packages-container {
    padding: 20px; /* Reduced from 32px */
}

.package-card {
    background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
    border-radius: 16px; /* Reduced from 20px */
    border: 2px solid #e2e8f0;
    padding: 24px; /* Reduced from 32px */
    margin-bottom: 20px; /* Reduced from 24px */
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

        .package-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #10b981, #667eea, #764ba2);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .package-card:hover::before {
            opacity: 1;
        }

        .package-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.12);
            border-color: #667eea;
        }

        

/* Inline package details in header */
.package-details-inline {
    display: flex;
    flex-wrap: nowrap;
    gap: 16px;
    align-items: center;
    flex: 2;
    justify-content: flex-start;
    overflow: hidden;
    padding: 8px 0;
}

.detail-inline {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 14px;
    white-space: nowrap;
    min-width: 0;
}

.detail-label-inline {
    font-weight: 600;
    color: #6b7280;
    font-size: 13px;
    letter-spacing: 0.025em;
}

.detail-value-inline {
    font-weight: 600;
    color: #1e293b;
    font-size: 14px;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Better space distribution in package header */
.package-bank {
    flex: 0 0 auto;
    min-width: 160px;
    max-width: 220px;
}

.rate-info {
    flex: 0 0 auto;
    text-align: right;
    min-width: 140px;
}

/* Inline package features */
.package-features-inline {
    display: flex;
    align-items: center;
    gap: 12px;
    margin: 20px 0;
    flex-wrap: wrap;
}

.features-title-inline {
    font-weight: 700;
    color: #1e293b;
    font-size: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
    white-space: nowrap;
}

/* Update package header for better spacing */
.package-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px; /* Reduced from 24px */
    flex-wrap: nowrap;
    gap: 16px;
    min-height: 75px;
    padding: 12px 0;
}

        .package-rank {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 18px;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
        }

        .package-bank {
            flex: 1;
            min-width: 200px;
        }

        .bank-name {
            font-size: 24px;
            font-weight: 800;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .package-type {
            font-size: 14px;
            color: #64748b;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .rate-info {
            text-align: right;
        }

        .avg-rate {
            font-size: 32px;
            font-weight: 800;
            color: #059669;
            margin-bottom: 4px;
            text-shadow: 0 1px 2px rgba(5, 150, 105, 0.1);
        }

        .monthly-payment {
            font-size: 16px;
            color: #374151;
            font-weight: 600;
        }

        .package-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 24px 0;
            padding: 24px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 16px;
            border: 1px solid #e2e8f0;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .detail-label {
            font-size: 12px;
            color: #6b7280;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-value {
            font-size: 14px;
            color: #1e293b;
            font-weight: 600;
        }

        /* Enhanced Rate Schedule */
        .rate-schedule {
            margin: 12px 0;
        }

        .rate-schedule-title {
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 12px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .rate-schedule-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 12px;
}

        .rate-item {
    background: white;
    padding: 16px 12px;
    border-radius: 12px;
    text-align: center;
    border: 2px solid #d1fae5;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    min-height: 80px;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

        .rate-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(16, 185, 129, 0.1), transparent);
            transition: left 0.6s;
        }

        .rate-item:hover::before {
            left: 100%;
        }

        .rate-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.25);
            border-color: #10b981;
        }

        .rate-period {
            font-size: 12px;
            color: #6b7280;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .rate-value {
    font-size: 14px;
    font-weight: 600;
    color: #059669;
    line-height: 1.3;
    word-break: break-word;
}

        /* Enhanced Remarks Section */
        .package-remarks {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #fcd34d;
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
        }

        .package-remarks::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #f59e0b, #d97706);
        }

        .remarks-title {
            font-weight: 700;
            color: #92400e;
            margin-bottom: 12px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .remarks-content {
            color: #92400e;
            font-size: 14px;
            line-height: 1.6;
            font-weight: 500;
        }

        /* Enhanced Package Remarks Editor */
        .package-remarks-editor {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px solid #0ea5e9;
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
        }

        .package-remarks-editor::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #0ea5e9, #0284c7);
        }

        .remarks-editor-title {
            font-weight: 700;
            color: #0c4a6e;
            margin-bottom: 12px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .remarks-textarea {
            width: 100%;
            min-height: 80px;
            padding: 12px 16px;
            border: 2px solid #bae6fd;
            border-radius: 10px;
            background: white;
            color: #0c4a6e;
            font-size: 14px;
            line-height: 1.5;
            resize: vertical;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .remarks-textarea:focus {
            outline: none;
            border-color: #0ea5e9;
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }

        .remarks-textarea::placeholder {
            color: #64748b;
            font-style: italic;
        }

        /* Enhanced Features Section */
        .package-features {
            margin: 24px 0;
        }

        .features-title {
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 16px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .features-list {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .feature-tag {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            color: #1e40af;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid #93c5fd;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
        }

        .feature-tag:hover {
            background: linear-gradient(135deg, #bfdbfe 0%, #93c5fd 100%);
            transform: translateY(-2px);
        }

        /* Enhanced Action Buttons */
        .package-actions {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .enquire-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);
        }

        .enquire-btn:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6b4190 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
        }

        /* Enhanced No Results State */
        .no-results {
            text-align: center;
            padding: 60px 32px;
            color: #64748b;
        }

        .no-results i {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .no-results h3 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 12px;
            color: #1e293b;
        }

        .no-results p {
            font-size: 16px;
            margin-bottom: 24px;
        }

        .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
}

.loading-content {
    background: white;
    padding: 32px;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    display: flex;
    align-items: center;
    gap: 16px;
}

.loading-spinner {
    width: 24px;
    height: 24px;
    border: 3px solid #e2e8f0;
    border-top: 3px solid #4338ca;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

.loading-message {
    color: #374151;
    font-weight: 500;
    font-size: 14px;
}

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .loading-spinner span {
            font-size: 16px;
            font-weight: 500;
        }

        .search-button:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none !important;
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.2);
}

.animate-spin {
    animation: spin 1s linear infinite;
}

/* Optional: Add a subtle pulse effect for better UX */
.search-button:disabled:hover {
    transform: none !important;
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.2);
}
        
        /* Package Selection */
        .package-selection {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 10;
        }

        .selection-checkbox {
            width: 20px;
            height: 20px;
            accent-color: #667eea;
            cursor: pointer;
            border-radius: 4px;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .search-form {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                gap: 16px;
            }
            
            .package-details {
                grid-template-columns: 1fr;
            }
            
            .rate-schedule-grid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .page-header {
                padding: 24px 20px;
                text-align: center;
            }
            
            .page-header h1 {
                font-size: 24px;
            }
            
            .loan-type-tabs {
                flex-direction: column;
                gap: 8px;
            }
            
            .search-section {
                padding: 24px 20px;
            }
            
            .search-form {
                grid-template-columns: 1fr;
            }
            
            .package-details-inline {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
    
    .package-features-inline {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
    
    .package-header {
        flex-direction: column;
        align-items: center;
        text-align: center;
    }
            
            .rate-info {
                text-align: center;
            }
            
            .packages-container {
                padding: 20px;
            }
            
            .package-card {
                padding: 20px;
            }
            
            .package-actions {
                justify-content: center;
            }

             .rate-schedule-grid {
        grid-template-columns: 1fr;
    }
    
    .rate-value {
        font-size: 13px;
    }
    
    .rate-item {
        padding: 14px 10px;
        min-height: 70px;
    }
        }

        @media (max-width: 480px) {
            .rate-schedule-grid {
                grid-template-columns: 1fr;
            }
            
            .features-list {
                flex-direction: column;
            }
            
            .detail-item {
                flex-direction: column;
                gap: 8px;
                text-align: center;
            }

            .remarks-textarea {
                min-height: 60px;
                font-size: 13px;
            }

            .package-remarks-editor {
                padding: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="overlay" id="overlay" onclick="closeSidebar()"></div>
    
 <div class="admin-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="index.html" class="logo">
                    <div class="logo-icon">
                        <i data-lucide="building-2"></i>
                    </div>
                    <span>KEYQUEST</span>
                </a>
            </div>
    
    <!-- DARK NAVIGATION MENU -->
    <nav class="nav-menu">
        <a href="index.html" class="nav-item">
            <i data-lucide="layout-dashboard"></i>
            <span>Dashboard</span>
        </a>
        <a href="rate-packages.html" class="nav-item">
            <i data-lucide="package"></i>
            <span>Rate Package</span>
        </a>
        <a href="rate-types.html" class="nav-item">
            <i data-lucide="percent"></i>
            <span>Rate Type</span>
        </a>
        <a href="banks.html" class="nav-item">
            <i data-lucide="landmark"></i>
            <span>Bank</span>
        </a>
        <a href="bankers.html" class="nav-item">
            <i data-lucide="briefcase"></i>
            <span>Bankers</span>
        </a>
        <a href="agents.html" class="nav-item">
            <i data-lucide="users"></i>
            <span>Agents</span>
        </a>
        <a href="enquiry.html" class="nav-item">
            <i data-lucide="help-circle"></i>
            <span>Enquiry</span>
        </a>
        <a href="recommended-packages.html" class="nav-item active">
            <i data-lucide="star"></i>
            <span>Recommended Packages</span>
        </a>
    </nav>
</div>

        <!-- Main Content -->
        <div class="main-content">
            <header class="header">
                <div class="header-left">
                    <button class="menu-toggle" onclick="toggleSidebar()">
                        <i data-lucide="menu"></i>
                    </button>
                    <h1 class="header-title">Recommended Packages</h1>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="confirmSignOut()">
                        <i data-lucide="log-out"></i>
                        <span>Sign Out</span>
                    </button>
                    <div class="user-profile">
                        <div class="user-avatar" id="userAvatar">A</div>
                        <div class="user-info">
                            <div class="user-name" id="userName">admin</div>
                            <div class="user-role">Super Admin</div>
                        </div>
                    </div>
                </div>
            </header>
            
            <div class="content-area">
                
                <!-- Loan Type Tabs -->
                <div class="loan-type-tabs">
                    <button class="loan-tab active" onclick="selectLoanType('New Home Loan')" data-loan-type="New Home Loan">
                        <i data-lucide="home"></i>
                        New Home Loan
                    </button>
                    <button class="loan-tab" onclick="selectLoanType('Refinancing Home Loan')" data-loan-type="Refinancing Home Loan">
                        <i data-lucide="repeat"></i>
                        Refinancing Home Loan
                    </button>
                    <button class="loan-tab" onclick="selectLoanType('Commercial/Industrial')" data-loan-type="Commercial/Industrial">
                        <i data-lucide="briefcase"></i>
                        Commercial/Industrial
                    </button>
                </div>

                
<!-- Enhanced Search Section with Additional Filters -->
<div class="search-section">
    <form class="search-form" id="searchForm" onsubmit="searchPackages(event)">
        <!-- Row 1: Basic Filters -->
        <div class="form-group">
            <label class="form-label">Property Type</label>
            <select class="form-select" id="propertyType">
                <option value="">Select Property Type</option>
                <option value="Private Property">Private Property</option>
                <option value="HDB">HDB</option>
                <option value="EC">EC</option>
                <option value="Commercial">Commercial</option>
                <option value="Industrial">Industrial</option>
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label">Property Status</label>
            <select class="form-select" id="propertyStatus">
                <option value="">Select Property Status</option>
                <option value="Completed">Completed</option>
                <option value="BUC">BUC</option>
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label">Buy Under</label>
            <select class="form-select" id="buyUnder">
                <option value="">Select Buy Under</option>
                <option value="Individual Name">Individual Name</option>
                <option value="Company Operating">Company Operating</option>
                <option value="Company Investment">Company Investment</option>
            </select>
        </div>
        
        <!-- Row 2: Financial Parameters -->
        <div class="form-group">
            <label class="form-label">Loan Amount ($)</label>
            <input type="number" class="form-input" id="loanAmount" placeholder="500,000" min="0" step="1000">
        </div>
        
        <div class="form-group">
    <label class="form-label">Loan Tenure (Years)</label>
    <input type="number" class="form-input" id="loanTenure" placeholder="25" min="1" max="50" step="1">
</div>

<!-- NEW: Existing Interest Rate for Refinancing -->
<div class="form-group" id="existingRateGroup" style="display: none;">
    <label class="form-label">Current Interest Rate (%)</label>
    <input type="number" class="form-input" id="existingInterestRate" placeholder="3.50" min="0" max="20" step="0.01">
    
</div>
        <div class="form-group" id="existingBankGroup" style="display: none;">
    <label class="form-label">Current Bank</label>
    <select class="form-select" id="existingBank">
        <option value="">Select Current Bank</option>
        <option value="CIMB">CIMB</option>
        <option value="OCBC">OCBC</option>
        <option value="UOB">UOB</option>
        <option value="DBS">DBS</option>
        <option value="MBB">MBB</option>
        <option value="SCB">SCB</option>
        <option value="HSBC">HSBC</option>
        <option value="SBI">SBI</option>
        <option value="BOC">BOC</option>
        <option value="HLF">HLF</option>
        <option value="SF">SF</option>
        <option value="RHB">RHB</option>
        <option value="SIF">SIF</option>
        <option value="Citibank">Citibank</option>
    </select>
   </div>

        <!-- Row 3: New Enhanced Filters -->
       <div class="form-group">
    <label class="form-label">Bank (Multiple Selection)</label>
    <div class="multi-select-filter" id="bankMultiSelect">
        <button type="button" class="filter-select-btn" onclick="toggleMultiSelect('bankMultiSelect')">
            <span id="bankSelected">Select Banks</span>
            <i data-lucide="chevron-down"></i>
        </button>
        <div class="multi-select-dropdown">
            <label data-all="true">
                <input type="checkbox" id="bankAll" onchange="selectAllBanks()">
                Select All Banks
            </label>
            <label><input type="checkbox" value="CIMB"> CIMB</label>
            <label><input type="checkbox" value="OCBC"> OCBC</label>
            <label><input type="checkbox" value="UOB"> UOB</label>
            <label><input type="checkbox" value="DBS"> DBS</label>
            <label><input type="checkbox" value="MBB"> MBB</label>
            <label><input type="checkbox" value="SCB"> SCB</label>
            <label><input type="checkbox" value="HSBC"> HSBC</label>
            <label><input type="checkbox" value="SBI"> SBI</label>
            <label><input type="checkbox" value="BOC"> BOC</label>
            <label><input type="checkbox" value="HLF"> HLF</label>
            <label><input type="checkbox" value="SF"> SF</label>
            <label><input type="checkbox" value="RHB"> RHB</label>
            <label><input type="checkbox" value="SIF"> SIF</label>
            <label><input type="checkbox" value="Citibank"> Citibank</label>
        </div>
    </div>
</div>
        
        <div class="form-group">
            <label class="form-label">Rate Type</label>
            <select class="form-select" id="rateTypeFilter">
                <option value="">Select Rate Type</option>
                <option value="Fixed">Fixed</option>
                <option value="Floating">Floating</option>
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label">Lock-in Period</label>
            <select class="form-select" id="lockPeriodFilter">
                <option value="">Select Lock Period</option>
                <option value="0 Year">0 Year</option>
                <option value="1 Year">1 Year</option>
                <option value="2 Years">2 Years</option>
                <option value="3 Years">3 Years</option>
                <option value="4 Years">4 Years</option>
                <option value="5 Years">5 Years</option>
                <option value="6 Years">6 Years</option>
                <option value="7 Years">7 Years</option>
                <option value="8 Years">8 Years</option>
                <option value="9 Years">9 Years</option>
                <option value="10 Years">10 Years</option>
            </select>
        </div>

        <!-- Row 4: Package Features -->
        <div class="form-group">
    <label class="form-label">Package Features (Multiple Selection)</label>
    <div class="multi-select-filter" id="featuresMultiSelect">
        <button type="button" class="filter-select-btn" onclick="toggleMultiSelect('featuresMultiSelect')">
            <span id="featuresSelected">Select Features</span>
            <i data-lucide="chevron-down"></i>
        </button>
        <div class="multi-select-dropdown">
            <label data-all="true">
                <input type="checkbox" id="featuresAll" onchange="selectAllFeatures()">
                Select All Features
            </label>
            <label><input type="checkbox" value="legal_fee_subsidy"> Legal Fee Subsidy</label>
            <label><input type="checkbox" value="cash_rebate"> Cash Rebate</label>
            <label><input type="checkbox" value="free_package_conversion_12m"> Free Conversion (12M)</label>
            <label><input type="checkbox" value="free_package_conversion_24m"> Free Conversion (24M)</label>
            <label><input type="checkbox" value="valuation_subsidy"> Valuation Subsidy</label>
            <label><input type="checkbox" value="partial_repayment"> Partial Repayment</label>
            <label><input type="checkbox" value="waiver_due_to_sales"> Waiver Due to Sales</label>
        </div>
    </div>
</div>

        
        
        <div class="form-group">
            <button type="button" class="search-button" onclick="clearAllFilters()" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);">
                <i data-lucide="rotate-ccw"></i>
                Clear All Filters
            </button>
        </div>
    </form>
</div>

                <!-- Results Section -->
              <div class="results-section" id="resultsContainer" style="display: none;">
    <div class="results-header">
        <div class="results-title">
            <i data-lucide="trending-up"></i>
            Recommended Packages
            <span class="results-count" id="resultsCount">0</span>
        </div>
        <div class="results-actions">
            <!-- Move options to the left -->
            <div class="report-options">
                <div class="option-group">
                    <label for="clientName" class="option-label">Client Name:</label>
                    <input type="text" id="clientName" class="client-name-input" placeholder="Enter client name for report" />
                </div>
                <div class="option-group">
                    <input type="checkbox" id="hideBankNames" class="option-checkbox">
                    <label for="hideBankNames" class="option-checkbox-label">Hide Bank Names in Report</label>
                </div>
            </div>

            <!-- Buttons aligned to the right -->
            <div class="action-buttons">
                <button class="download-btn" onclick="generateProfessionalReport()">
                    <i data-lucide="file-text"></i>
                    Generate Report
                </button>
                <button class="download-btn" onclick="exportCSV()" style="background: linear-gradient(135deg, #059669 0%, #047857 100%);">
                    <i data-lucide="download"></i>
                    Export CSV
                </button>
                <button class="download-btn" onclick="toggleAllSelections()" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);">
                    <i data-lucide="check-square"></i>
                    Toggle All
                </button>
            </div>
        </div>
    </div>
</div>
                    
                    <div class="packages-container" id="packagesContainer">
                        <!-- Package cards will be dynamically inserted here -->
                    </div>
                    
                    <div class="no-results" id="noResults" style="display: none;">
                        <i data-lucide="search"></i>
                        <h3>No Matching Packages Found</h3>
                        <p>Try adjusting your search criteria to find more suitable options.</p>
                        <button class="btn btn-primary" onclick="clearFilters()">
                            <i data-lucide="rotate-ccw"></i>
                            Reset Search
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay" style="display: none;">
    <div class="loading-content">
        <div class="loading-spinner"></div>
        <span class="loading-message">Finding the best packages for you...</span>
    </div>
</div>

    <script>
        // ===================================
        // GLOBAL VARIABLES - PRESERVED FROM ORIGINAL
        // ===================================
        let allPackages = [];
        let rateTypes = [];
        let currentLoanType = 'New Home Loan';
        let currentResults = [];
        let searchCriteria = {};

        // ===================================
        // INITIALIZATION - PRESERVED FROM ORIGINAL
        // ===================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸš€ Recommended Packages page loading...');
            checkAuthentication();
            setupEventListeners();
            loadData();
        });

        // ===================================
        // AUTHENTICATION CHECK - PRESERVED FROM ORIGINAL
        // ===================================
        async function checkAuthentication() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) {
                    console.warn('âŒ No authenticated user found, redirecting to login');
                    window.location.href = 'login.html';
                    return;
                }

                // Update user display
                if (user.email) {
                    document.getElementById('userName').textContent = user.email.split('@')[0];
                    document.getElementById('userAvatar').textContent = user.email.charAt(0).toUpperCase();
                }
            } catch (error) {
                console.error('ðŸ’¥ Auth check failed:', error);
                window.location.href = 'login.html';
            }
        }

        function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}
        
function setupEventListeners() {
    // Initialize Lucide icons
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }

    // Existing event listeners...
    document.addEventListener('click', function(event) {
        const userDropdown = document.getElementById('userDropdown');
        const userInfo = document.querySelector('.user-info');
        
        if (userInfo && !userInfo.contains(event.target) && userDropdown) {
            userDropdown.style.display = 'none';
        }
    });

    const loanTabs = document.querySelectorAll('.loan-tab');
    loanTabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const loanType = this.getAttribute('data-loan-type');
            selectLoanType(loanType);
        });
    });

    const searchForm = document.getElementById('searchForm');
    if (searchForm) {
        searchForm.addEventListener('submit', searchPackages);
    }

    // Enhanced live filtering event listeners - INCLUDING NEW FILTERS
    const filterInputs = [
        'propertyType',
        'propertyStatus', 
        'buyUnder',
        'loanAmount',
        'loanTenure',
        'existingInterestRate',
        'rateTypeFilter',
        'lockPeriodFilter'
    ];

    filterInputs.forEach(inputId => {
        const element = document.getElementById(inputId);
        if (element) {
            element.addEventListener('input', debounce(performLiveFilter, 300));
            element.addEventListener('change', performLiveFilter);
        }
    });

    // Add event listeners for multi-select changes
    document.addEventListener('change', function(event) {
        if (event.target.matches('#bankMultiSelect input[type="checkbox"]:not(#bankAll)')) {
            updateBankDisplay();
            performLiveFilter();
        }
        if (event.target.matches('#featuresMultiSelect input[type="checkbox"]:not(#featuresAll)')) {
            updateFeaturesDisplay();
            performLiveFilter();
        }
    });
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', function(event) {
        if (!event.target.closest('.multi-select-filter')) {
            document.querySelectorAll('.multi-select-filter').forEach(filter => {
                filter.classList.remove('open');
                filter.querySelector('.multi-select-dropdown').style.display = 'none';
            });
        }
    });
    
    // Add existing bank filter listener
    const existingBankSelect = document.getElementById('existingBank');
    if (existingBankSelect) {
        existingBankSelect.addEventListener('change', performLiveFilter);
    }

    console.log('âœ… Enhanced event listeners set up successfully');
}

// New function to clear all filters
function clearAllFilters() {
    // Clear existing filters
    document.getElementById('propertyType').value = '';
    document.getElementById('propertyStatus').value = '';
    document.getElementById('buyUnder').value = '';
    document.getElementById('loanAmount').value = '';
    document.getElementById('loanTenure').value = '';
    document.getElementById('existingInterestRate').value = '';
    document.getElementById('existingBank').value = '';
    document.getElementById('rateTypeFilter').value = '';
    document.getElementById('lockPeriodFilter').value = '';
    
    // Clear multi-select banks
    document.querySelectorAll('#bankMultiSelect input[type="checkbox"]').forEach(cb => cb.checked = false);
    document.getElementById('bankSelected').textContent = 'Select Banks';
    
    // Clear multi-select features
    document.querySelectorAll('#featuresMultiSelect input[type="checkbox"]').forEach(cb => cb.checked = false);
    document.getElementById('featuresSelected').textContent = 'Select Features';
    
    // Clear results
    clearResults();
    searchCriteria = {};
    
    showNotification('All filters cleared', 'info');
}

        // ===================================
        // LOAN TYPE SELECTION - PRESERVED FROM ORIGINAL
        // ===================================
        function selectLoanType(loanType) {
    currentLoanType = loanType;
    
    // Update tab appearance
    document.querySelectorAll('.loan-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.getAttribute('data-loan-type') === loanType) {
            tab.classList.add('active');
        }
    });
    
    // Show/hide existing rate input and existing bank for refinancing
    const existingRateGroup = document.getElementById('existingRateGroup');
    const existingBankGroup = document.getElementById('existingBankGroup');
    
    if (loanType === 'Refinancing Home Loan') {
        if (existingRateGroup) existingRateGroup.style.display = 'block';
        if (existingBankGroup) existingBankGroup.style.display = 'block';
    } else {
        if (existingRateGroup) existingRateGroup.style.display = 'none';
        if (existingBankGroup) existingBankGroup.style.display = 'none';
        document.getElementById('existingInterestRate').value = '';
        document.getElementById('existingBank').value = '';
    }
    
    // Clear previous results
    clearResults();
    
    console.log(`ðŸ“‹ Selected loan type: ${loanType}`);
}

        // Multi-select functionality for banks
function toggleMultiSelect(selectId) {
    const container = document.getElementById(selectId);
    const dropdown = container.querySelector('.multi-select-dropdown');
    const isOpen = container.classList.contains('open');
    
    // Close all other dropdowns first
    document.querySelectorAll('.multi-select-filter').forEach(filter => {
        filter.classList.remove('open');
        filter.querySelector('.multi-select-dropdown').style.display = 'none';
    });
    
    if (!isOpen) {
        container.classList.add('open');
        dropdown.style.display = 'block';
        
        // Ensure dropdown is positioned correctly
        const rect = container.getBoundingClientRect();
        const viewportHeight = window.innerHeight;
        const dropdownHeight = 250; // max-height from CSS
        
        // Check if there's enough space below
        if (rect.bottom + dropdownHeight > viewportHeight) {
            // Not enough space below, show above instead
            dropdown.style.top = 'auto';
            dropdown.style.bottom = '100%';
            dropdown.style.marginTop = '0';
            dropdown.style.marginBottom = '4px';
        } else {
            // Enough space below, show normally
            dropdown.style.top = '100%';
            dropdown.style.bottom = 'auto';
            dropdown.style.marginTop = '4px';
            dropdown.style.marginBottom = '0';
        }
    }
}
        
function selectAllBanks() {
    const allCheckbox = document.getElementById('bankAll');
    const checkboxes = document.querySelectorAll('#bankMultiSelect input[type="checkbox"]:not(#bankAll)');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = allCheckbox.checked;
    });
    
    updateBankDisplay();
    performLiveFilter();
}

function selectAllFeatures() {
    const allCheckbox = document.getElementById('featuresAll');
    const checkboxes = document.querySelectorAll('#featuresMultiSelect input[type="checkbox"]:not(#featuresAll)');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = allCheckbox.checked;
    });
    
    updateFeaturesDisplay();
    performLiveFilter();
}

function updateBankDisplay() {
    const checkboxes = document.querySelectorAll('#bankMultiSelect input[type="checkbox"]:checked:not(#bankAll)');
    const selectedText = document.getElementById('bankSelected');
    
    if (checkboxes.length === 0) {
        selectedText.textContent = 'Select Banks';
    } else if (checkboxes.length === 1) {
        selectedText.textContent = checkboxes[0].value;
    } else {
        selectedText.textContent = `${checkboxes.length} banks selected`;
    }
}

function updateFeaturesDisplay() {
    const checkboxes = document.querySelectorAll('#featuresMultiSelect input[type="checkbox"]:checked:not(#featuresAll)');
    const selectedText = document.getElementById('featuresSelected');
    
    if (checkboxes.length === 0) {
        selectedText.textContent = 'Select Features';
    } else if (checkboxes.length === 1) {
        const value = checkboxes[0].value;
        selectedText.textContent = value.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    } else {
        selectedText.textContent = `${checkboxes.length} features selected`;
    }
}

function getSelectedBanks() {
    const checkboxes = document.querySelectorAll('#bankMultiSelect input[type="checkbox"]:checked:not(#bankAll)');
    return Array.from(checkboxes).map(cb => cb.value);
}

function getSelectedFeatures() {
    const checkboxes = document.querySelectorAll('#featuresMultiSelect input[type="checkbox"]:checked:not(#featuresAll)');
    return Array.from(checkboxes).map(cb => cb.value);
}

        // ===================================
        // DATA LOADING FUNCTIONS - PRESERVED FROM ORIGINAL
        // ===================================
        async function loadData() {
            try {
                showLoading('Loading packages and rate types...');
                
                // Load packages and rate types in parallel
                const [packagesResult, rateTypesResult] = await Promise.all([
                    supabaseClient.from('rate_packages').select('*'),
                    supabaseClient.from('rate_types').select('*')
                ]);

                if (packagesResult.error) throw packagesResult.error;
                if (rateTypesResult.error) throw rateTypesResult.error;

                allPackages = packagesResult.data || [];
                rateTypes = rateTypesResult.data || [];

                console.log(`ðŸ“¦ Loaded ${allPackages.length} packages and ${rateTypes.length} rate types`);
                
            } catch (error) {
                console.error('ðŸ’¥ Error loading data:', error);
                showNotification('Failed to load data: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // ===================================
        // SEARCH FUNCTIONS - PRESERVED FROM ORIGINAL  
        // ===================================
        // Updated searchPackages function
async function searchPackages(event) {
    if (event) event.preventDefault();
    
    try {
        showLoading('Searching for the best packages...');
        
        // Get form values - INCLUDING NEW MULTI-SELECT FILTERS
        const selectedBanks = getSelectedBanks();
        const selectedFeatures = getSelectedFeatures();
        const existingBank = document.getElementById('existingBank').value;
        
        const formData = {
            propertyType: document.getElementById('propertyType').value,
            propertyStatus: document.getElementById('propertyStatus').value,
            buyUnder: document.getElementById('buyUnder').value,
            loanAmount: parseFloat(document.getElementById('loanAmount').value) || 0,
            loanTenure: parseInt(document.getElementById('loanTenure').value) || 25,
            existingInterestRate: parseFloat(document.getElementById('existingInterestRate').value) || 0,
            existingBank: existingBank,
            selectedBanks: selectedBanks,
            selectedFeatures: selectedFeatures,
            rateTypeFilter: document.getElementById('rateTypeFilter').value,
            lockPeriodFilter: document.getElementById('lockPeriodFilter').value
        };

        searchCriteria = { ...formData, loanType: currentLoanType };
        
        // Enhanced filter logic
        let filteredPackages = allPackages.filter(pkg => {
            // Existing filters
            if (pkg.loan_type !== currentLoanType) return false;
            if (formData.propertyType && pkg.property_type !== formData.propertyType) return false;
            if (formData.propertyStatus && pkg.property_status !== formData.propertyStatus) return false;
            if (formData.buyUnder && pkg.buy_under !== formData.buyUnder) return false;
            if (formData.loanAmount > 0 && pkg.minimum_loan_size && formData.loanAmount < pkg.minimum_loan_size) return false;
            
            // NEW: Exclude existing bank for refinancing
            if (currentLoanType === 'Refinancing Home Loan' && formData.existingBank && pkg.bank_name === formData.existingBank) {
                return false;
            }
            
            // NEW: Multi-select Bank filter
            if (formData.selectedBanks.length > 0 && !formData.selectedBanks.includes(pkg.bank_name)) {
                return false;
            }
            
            // Rate Type filter  
            if (formData.rateTypeFilter && pkg.rate_type_category !== formData.rateTypeFilter) return false;
            
            // Lock-in Period filter
            if (formData.lockPeriodFilter) {
                const pkgLockPeriod = pkg.lock_period || '0 Year';
                if (pkgLockPeriod !== formData.lockPeriodFilter) return false;
            }
            
            // NEW: Multi-select Package Features filter
            if (formData.selectedFeatures.length > 0) {
                const hasAnyFeature = formData.selectedFeatures.some(featureField => {
                    const featureValue = pkg[featureField];
                    return featureValue === 'true' || featureValue === true;
                });
                if (!hasAnyFeature) return false;
            }
            
            return true;
        });

        // Calculate metrics for each package
filteredPackages = filteredPackages.map(pkg => {
    const avgFirst2Years = calculateAverageFirst2Years(pkg);
    const monthlyInstallment = calculateMonthlyInstallment(formData.loanAmount, formData.loanTenure, avgFirst2Years);
    
    // Calculate savings for refinancing based on LOCK-IN PERIOD
    let monthlySavings = 0;
    let totalSavings = 0;
    if (currentLoanType === 'Refinancing Home Loan' && formData.existingInterestRate) {
        monthlySavings = calculateMonthlySavings(formData.loanAmount, formData.loanTenure, formData.existingInterestRate, avgFirst2Years);
        totalSavings = calculateTotalSavings(monthlySavings, pkg.lock_period); // Use lock_period instead of tenure
    }
    
    return {
        ...pkg,
        avgFirst2Years,
        monthlyInstallment,
        monthlySavings,
        totalSavings,
        lockInYears: parseLockInPeriod(pkg.lock_period), // Add for display
        selected: true // Default to selected for report
    };
});

        // Sort by average rate (ascending - best rates first)
        filteredPackages.sort((a, b) => a.avgFirst2Years - b.avgFirst2Years);

        currentResults = filteredPackages;
        displayResults(filteredPackages, true);
        
        console.log(`ðŸ” Found ${filteredPackages.length} matching packages`);
        
    } catch (error) {
        console.error('ðŸ’¥ Search error:', error);
        showNotification('Search failed: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}

function performLiveFilter() {
    console.log('ðŸ”„ Live filter started');
    
    if (!allPackages.length || !currentLoanType) {
        console.log('âŒ Early return - no packages or loan type');
        return;
    }

    try {
        const selectedBanks = getSelectedBanks();
        const selectedFeatures = getSelectedFeatures();
        const existingBank = document.getElementById('existingBank').value;
        
        const formData = {
            propertyType: document.getElementById('propertyType').value,
            propertyStatus: document.getElementById('propertyStatus').value,
            buyUnder: document.getElementById('buyUnder').value,
            loanAmount: parseFloat(document.getElementById('loanAmount').value) || 0,
            loanTenure: parseInt(document.getElementById('loanTenure').value) || 25,
            existingInterestRate: parseFloat(document.getElementById('existingInterestRate').value) || 0,
            existingBank: existingBank,
            selectedBanks: selectedBanks,
            selectedFeatures: selectedFeatures,
            rateTypeFilter: document.getElementById('rateTypeFilter').value,
            lockPeriodFilter: document.getElementById('lockPeriodFilter').value
        };

        // Check if any filters are applied (updated to handle arrays properly)
        const hasFilters = Object.values(formData).some(value => {
            if (Array.isArray(value)) {
                return value.length > 0;
            }
            return value !== '' && value !== 0;
        });

        if (!hasFilters) {
            clearResults();
            return;
        }

        // Apply filtering logic
        let filteredPackages = allPackages.filter(pkg => {
            // Basic loan type filter
            if (pkg.loan_type !== currentLoanType) return false;
            
            // Property type filter
            if (formData.propertyType && pkg.property_type !== formData.propertyType) return false;
            
            // Property status filter
            if (formData.propertyStatus && pkg.property_status !== formData.propertyStatus) return false;
            
            // Buy under filter
            if (formData.buyUnder && pkg.buy_under !== formData.buyUnder) return false;
            
            // Minimum loan amount filter
            if (formData.loanAmount > 0 && pkg.minimum_loan_size && formData.loanAmount < pkg.minimum_loan_size) return false;
            
            // NEW: Exclude existing bank for refinancing
            if (currentLoanType === 'Refinancing Home Loan' && formData.existingBank && pkg.bank_name === formData.existingBank) {
                return false;
            }
            
            // NEW: Multi-select Bank filter
            if (formData.selectedBanks.length > 0 && !formData.selectedBanks.includes(pkg.bank_name)) {
                return false;
            }
            
            // Rate Type filter  
            if (formData.rateTypeFilter && pkg.rate_type_category !== formData.rateTypeFilter) return false;
            
            // Lock-in Period filter
            if (formData.lockPeriodFilter) {
                const pkgLockPeriod = pkg.lock_period || '0 Year';
                if (pkgLockPeriod !== formData.lockPeriodFilter) return false;
            }
            
            // NEW: Multi-select Package Features filter
            if (formData.selectedFeatures.length > 0) {
                const hasAnyFeature = formData.selectedFeatures.some(featureField => {
                    const featureValue = pkg[featureField];
                    return featureValue === 'true' || featureValue === true;
                });
                if (!hasAnyFeature) return false;
            }
            
            return true;
        });

        // Calculate metrics for each package (same as searchPackages)
        filteredPackages = filteredPackages.map(pkg => {
            const avgFirst2Years = calculateAverageFirst2Years(pkg);
            const monthlyInstallment = calculateMonthlyInstallment(formData.loanAmount, formData.loanTenure, avgFirst2Years);
            
            // Calculate savings for refinancing based on LOCK-IN PERIOD
            let monthlySavings = 0;
            let totalSavings = 0;
            if (currentLoanType === 'Refinancing Home Loan' && formData.existingInterestRate) {
                monthlySavings = calculateMonthlySavings(formData.loanAmount, formData.loanTenure, formData.existingInterestRate, avgFirst2Years);
                totalSavings = calculateTotalSavings(monthlySavings, pkg.lock_period);
            }
            
            return {
                ...pkg,
                avgFirst2Years,
                monthlyInstallment,
                monthlySavings,
                totalSavings,
                lockInYears: parseLockInPeriod(pkg.lock_period),
                selected: true // Default to selected for report
            };
        });

        // Sort by average rate (ascending - best rates first)
        filteredPackages.sort((a, b) => a.avgFirst2Years - b.avgFirst2Years);

        currentResults = filteredPackages;
        displayResults(filteredPackages, false); // false = don't scroll to results for live filtering
        
        console.log(`ðŸ” Live filter found ${filteredPackages.length} matching packages`);
        
    } catch (error) {
        console.error('Live filter error:', error);
    }
}

        function clearResults() {
    const resultsContainer = document.getElementById('resultsContainer');
    if (resultsContainer) {
        resultsContainer.style.display = 'none';
    }
    currentResults = [];
}
        // ===================================
        // CALCULATION FUNCTIONS - PRESERVED FROM ORIGINAL
        // ===================================
        function calculateAverageFirst2Years(pkg) {
            const year1Rate = calculateInterestRate(pkg, 1);
            const year2Rate = calculateInterestRate(pkg, 2);
            
            if (year1Rate === 0 && year2Rate === 0) return 0;
            if (year1Rate === 0) return year2Rate;
            if (year2Rate === 0) return year1Rate;
            
            return (year1Rate + year2Rate) / 2;
        }

        function calculateMonthlyInstallment(principal, tenureYears, annualRate) {
            if (!principal || !tenureYears || !annualRate) return 0;
            
            const monthlyRate = annualRate / 100 / 12;
            const totalMonths = tenureYears * 12;
            
            if (monthlyRate === 0) {
                return principal / totalMonths;
            }
            
            const monthlyPayment = principal * (monthlyRate * Math.pow(1 + monthlyRate, totalMonths)) / 
                                 (Math.pow(1 + monthlyRate, totalMonths) - 1);
            
            return monthlyPayment;
        }

        // Extract numeric value from lock-in period (e.g., "3 Years" -> 3)
function parseLockInPeriod(lockPeriod) {
    if (!lockPeriod) return 0;
    const match = lockPeriod.match(/(\d+)/);
    return match ? parseInt(match[1]) : 0;
}

        // Calculate potential monthly savings for refinancing
function calculateMonthlySavings(loanAmount, tenure, existingRate, newRate) {
    if (!loanAmount || !tenure || !existingRate || !newRate) return 0;
    
    const existingPayment = calculateMonthlyInstallment(loanAmount, tenure, existingRate);
    const newPayment = calculateMonthlyInstallment(loanAmount, tenure, newRate);
    
    return existingPayment - newPayment;
}

// Calculate total savings over LOCK-IN PERIOD (not full tenure)
function calculateTotalSavings(monthlySavings, lockInPeriod) {
    if (!monthlySavings || !lockInPeriod) return 0;
    const lockInYears = parseLockInPeriod(lockInPeriod);
    return monthlySavings * lockInYears * 12;
}

// Format savings display with lock-in period context
function formatSavings(savings, lockInPeriod = null) {
    if (savings === 0) return 'No savings';
    
    const lockInYears = lockInPeriod ? parseLockInPeriod(lockInPeriod) : null;
    const periodText = lockInYears ? ` Over ${lockInYears} Year${lockInYears > 1 ? 's' : ''} Lock-in` : '';
    
    if (savings > 0) {
        return `Save ${formatCurrency(Math.abs(savings))}${periodText}`;
    } else {
        return `Higher by ${formatCurrency(Math.abs(savings))}${periodText}`;
    }
}
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-SG', {
                style: 'currency',
                currency: 'SGD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function formatPercentage(rate) {
            return `${rate.toFixed(2)}%`;
        }

        // Calculate interest rate for a specific year - PRESERVED FROM ORIGINAL
        function calculateInterestRate(pkg, year) {
    let rateType, operator, value;
    
    if (year === 'thereafter') {
        rateType = pkg.thereafter_rate_type;
        operator = pkg.thereafter_operator;
        value = pkg.thereafter_value;
    } else {
        rateType = pkg[`year${year}_rate_type`];
        operator = pkg[`year${year}_operator`];
        value = pkg[`year${year}_value`];
    }

    // NEW LOGIC: If no data for this year, use thereafter rate
    if (!rateType || value === null || value === undefined) {
        if (pkg.thereafter_rate_type && pkg.thereafter_value !== null && pkg.thereafter_value !== undefined) {
            return calculateInterestRate(pkg, 'thereafter');
        }
        return 0;
    }

    // Original calculation logic
    if (rateType === 'FIXED') {
        return parseFloat(value) || 0;
    } else {
        // Find the reference rate
        const referenceRate = rateTypes.find(rt => rt.rate_type === rateType);
        if (!referenceRate) {
            console.warn(`âŒ Reference rate type not found: ${rateType}`);
            return 0;
        }

        const baseRate = parseFloat(referenceRate.rate_value) || 0;
        const adjustment = parseFloat(value) || 0;
        
        if (operator === '+') {
            return baseRate + adjustment;
        } else if (operator === '-') {
            return Math.max(0, baseRate - adjustment);
        } else {
            return baseRate;
        }
    }
}

        // Format rate display for tables - PRESERVED FROM ORIGINAL
       function formatRateDisplay(pkg, year) {
    let rateType, operator, value;
    
    if (year === 'thereafter') {
        rateType = pkg.thereafter_rate_type;
        operator = pkg.thereafter_operator;
        value = pkg.thereafter_value;
    } else {
        rateType = pkg[`year${year}_rate_type`];
        operator = pkg[`year${year}_operator`];
        value = pkg[`year${year}_value`];
    }

    // NEW LOGIC: If no data for this year, use thereafter rate
    if (!rateType || value === null || value === undefined) {
        // Check if thereafter rate exists
        if (pkg.thereafter_rate_type && pkg.thereafter_value !== null && pkg.thereafter_value !== undefined) {
            const thereafterType = pkg.thereafter_rate_type;
            const thereafterOp = pkg.thereafter_operator;
            const thereafterVal = pkg.thereafter_value;
            
            if (thereafterType === 'FIXED') {
                const rate = parseFloat(thereafterVal) || 0;
                return `${formatPercentage(rate)} Fixed`;
            } else {
                const operatorSymbol = thereafterOp === '+' ? '+' : '-';
                return `${thereafterType} ${operatorSymbol} ${thereafterVal}%`;
            }
        }
        return '-'; // Only show dash if no thereafter rate exists
    }

    // Original logic for years with actual data
    if (rateType === 'FIXED') {
        const rate = calculateInterestRate(pkg, year);
        return `${formatPercentage(rate)} Fixed`;
    } else {
        const operatorSymbol = operator === '+' ? '+' : '-';
        return `${rateType} ${operatorSymbol} ${value}%`;
    }
}

        // Enhanced rate display with reference rate values
function formatDetailedRateDisplay(pkg, year) {
    let rateType, operator, value;
    
    if (year === 'thereafter') {
        rateType = pkg.thereafter_rate_type;
        operator = pkg.thereafter_operator;
        value = pkg.thereafter_value;
    } else {
        rateType = pkg[`year${year}_rate_type`];
        operator = pkg[`year${year}_operator`];
        value = pkg[`year${year}_value`];
    }

    if (!rateType || value === null || value === undefined) return '-';

    if (rateType === 'FIXED') {
        const rate = calculateInterestRate(pkg, year);
        return `FIXED ${formatPercentage(rate)}`;
    } else {
        // Find the reference rate from rateTypes
        const referenceRate = rateTypes.find(rt => rt.rate_type === rateType);
        const referenceRateValue = referenceRate ? parseFloat(referenceRate.rate_value) || 0 : 0;
        
        const operatorSymbol = operator === '+' ? '+' : '-';
        const spreadValue = parseFloat(value) || 0;
        
        return `${rateType}(${formatPercentage(referenceRateValue)}) ${operatorSymbol} ${spreadValue.toFixed(2)}%`;
    }
}

        // ===================================
        // DISPLAY FUNCTIONS - ENHANCED UI WITH PRESERVED LOGIC
        // ===================================
// Modified displayResults function to prevent page jumping on live filter
function displayResults(packages, shouldScroll = true) {
    const resultsContainer = document.getElementById('resultsContainer');
    const packagesContainer = document.getElementById('packagesContainer');
    const resultsCount = document.getElementById('resultsCount');
    const noResults = document.getElementById('noResults');

    // Safety checks for DOM elements
    if (!resultsContainer) {
        console.error('âŒ Results container not found');
        return;
    }
    
    if (!packagesContainer) {
        console.error('âŒ Packages container not found');
        return;
    }

    // Show results container first
    resultsContainer.style.display = 'block';

    // Update results count safely
    if (resultsCount) {
        resultsCount.textContent = packages.length;
    }

    if (packages.length === 0) {
        packagesContainer.innerHTML = '';
        if (noResults) {
            noResults.style.display = 'block';
        }
    } else {
        if (noResults) {
            noResults.style.display = 'none';
        }
        
        // Add loading state with fade-in animation (only for initial search)
        if (shouldScroll) {
            packagesContainer.style.opacity = '0';
        }
        
        packagesContainer.innerHTML = packages.map((pkg, index) => createPackageCard(pkg, index)).join('');
        
        // Animate cards in with staggered effect (only for initial search)
        if (shouldScroll) {
            setTimeout(() => {
                packagesContainer.style.transition = 'opacity 0.6s ease';
                packagesContainer.style.opacity = '1';
                
                // Stagger animation for each card
                const cards = packagesContainer.querySelectorAll('.package-card');
                cards.forEach((card, index) => {
                    card.style.opacity = '0';
                    card.style.transform = 'translateY(30px)';
                    card.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
                    
                    setTimeout(() => {
                        card.style.opacity = '1';
                        card.style.transform = 'translateY(0)';
                    }, index * 150);
                });
            }, 100);
        } else {
            // For live filtering, just ensure opacity is 1
            packagesContainer.style.opacity = '1';
        }
        
        // Update the results subtitle to show selection info
        const resultsTitle = document.querySelector('.results-title');
        if (resultsTitle) {
            const selectedCount = packages.filter(pkg => pkg.selected !== false).length;
            resultsTitle.innerHTML = `
                <i data-lucide="trending-up"></i>
                Recommended Packages
                <span class="results-count">${packages.length}</span>
                <small style="font-size: 14px; font-weight: 500; color: #6b7280; margin-left: 12px; opacity: 0.8;">
                    (${selectedCount} selected for report)
                </small>
            `;
        }
    }

    // Only scroll to results on initial search, not live filtering
    if (shouldScroll) {
        resultsContainer.scrollIntoView({ behavior: 'smooth' });
    }
    
    // Re-initialize Lucide icons for dynamically added content
    setTimeout(() => {
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }, 100);
}

        function createPackageCard(pkg, index) {
            const rank = index + 1;
            const rateSchedule = generateRateSchedule(pkg);
            const features = generatePackageFeatures(pkg);
            
            return `
                <div class="package-card" data-package-index="${index}">
                    <div class="package-selection">
                        <input type="checkbox" 
                               id="pkg-select-${index}" 
                               class="selection-checkbox" 
                               onchange="togglePackageSelection(${index})"
                               ${pkg.selected !== false ? 'checked' : ''}>
                    </div>
                    
                    <div class="package-header">
    <div class="package-rank">${rank}</div>
    <div class="package-bank">
        <div class="bank-name">${pkg.bank_name}</div>
        <div class="package-type">${pkg.rate_type_category || 'Rate Package'}</div>
    </div>
    <div class="package-details-inline">
        <div class="detail-inline">
            <span class="detail-label-inline">Property:</span>
            <span class="detail-value-inline">${pkg.property_type}</span>
        </div>
        <div class="detail-inline">
            <span class="detail-label-inline">Status:</span>
            <span class="detail-value-inline">${pkg.property_status}</span>
        </div>
        <div class="detail-inline">
            <span class="detail-label-inline">Buy Under:</span>
            <span class="detail-value-inline">${pkg.buy_under}</span>
        </div>
        <div class="detail-inline">
            <span class="detail-label-inline">Lock:</span>
            <span class="detail-value-inline">${pkg.lock_period || 'No Lock-in'}</span>
        </div>
        <div class="detail-inline">
            <span class="detail-label-inline">Min Loan:</span>
            <span class="detail-value-inline">${formatCurrency(pkg.minimum_loan_size || 0)}</span>
        </div>
        ${pkg.totalSavings ? `
        <div class="total-savings-compact ${pkg.totalSavings > 0 ? '' : 'negative'}">
            ${formatSavings(pkg.totalSavings, pkg.lock_period)}
        </div>
    ` : ''}
    </div>
    <div class="rate-info">
    <div class="avg-rate">${formatPercentage(pkg.avgFirst2Years)}</div>
    <div class="monthly-payment">${formatCurrency(pkg.monthlyInstallment)}/mo</div>
    
</div>
</div>

                   
                    ${rateSchedule ? `
                        <div class="rate-schedule">
                            <div class="rate-schedule-title">
                                <i data-lucide="trending-up"></i>
                                Interest Rate Schedule
                            </div>
                            <div class="rate-schedule-grid">
                                ${rateSchedule}
                            </div>
                        </div>
                    ` : ''}

                    
                    ${features ? `
    <div class="package-features-inline">
        <span class="features-title-inline">
            <i data-lucide="award"></i>
            Package Features:
        </span>
        ${features}
    </div>
` : ''}





                    <div class="package-remarks-editor">
                        <div class="remarks-editor-title">
                            <i data-lucide="edit"></i>
                            Client Remarks (Editable)
                        </div>
                        <textarea 
                            class="remarks-textarea" 
                            id="remarks-${pkg.id || index}" 
                            placeholder="Add custom remarks for this package..."
                            onchange="updatePackageRemarks(${index}, this.value)"
                        >${pkg.custom_remarks || pkg.remarks || ''}</textarea>
                    </div>
                </div>
            `;
        }

        function generateRateSchedule(pkg) {
    const rates = [];
    
    // Always show Years 1-5 (auto-populate empty years with thereafter rate)
    for (let year = 1; year <= 5; year++) {
        let rateType, operator, value;
        
        // Check if this year has actual data
        rateType = pkg[`year${year}_rate_type`];
        operator = pkg[`year${year}_operator`];
        value = pkg[`year${year}_value`];
        
        // If no data for this year, check if we can use thereafter rate
        if (!rateType || value === null || value === undefined) {
            // Use thereafter rate if available
            if (pkg.thereafter_rate_type && pkg.thereafter_value !== null && pkg.thereafter_value !== undefined) {
                rates.push(`
                    <div class="rate-item">
                        <div class="rate-period">Year ${year}</div>
                        <div class="rate-value">${formatDetailedRateDisplay(pkg, 'thereafter')}</div>
                    </div>
                `);
            } else {
                // Only show dash if no thereafter rate exists
                rates.push(`
                    <div class="rate-item">
                        <div class="rate-period">Year ${year}</div>
                        <div class="rate-value">-</div>
                    </div>
                `);
            }
        } else {
            // Show actual data for this year
            rates.push(`
                <div class="rate-item">
                    <div class="rate-period">Year ${year}</div>
                    <div class="rate-value">${formatDetailedRateDisplay(pkg, year)}</div>
                </div>
            `);
        }
    }

    // Always show thereafter row
    const thereafterRate = calculateInterestRate(pkg, 'thereafter');
    if (thereafterRate > 0) {
        rates.push(`
            <div class="rate-item">
                <div class="rate-period">Thereafter</div>
                <div class="rate-value">${formatDetailedRateDisplay(pkg, 'thereafter')}</div>
            </div>
        `);
    }

    return rates.length > 0 ? rates.join('') : null;
}


        function generatePackageFeatures(pkg) {
            const features = [];
            
            if (pkg.legal_fee_subsidy === 'true' || pkg.legal_fee_subsidy === true) {
                features.push(`
                    <div class="feature-tag">
                        <i data-lucide="shield"></i>
                        Legal Fee Subsidy
                    </div>
                `);
            }
            
            if (pkg.cash_rebate === 'true' || pkg.cash_rebate === true) {
                features.push(`
                    <div class="feature-tag">
                        <i data-lucide="dollar-sign"></i>
                        Cash Rebate
                    </div>
                `);
            }
            
            if (pkg.free_package_conversion_12m === 'true' || pkg.free_package_conversion_12m === true) {
                features.push(`
                    <div class="feature-tag">
                        <i data-lucide="repeat"></i>
                        Free Conversion (12M)
                    </div>
                `);
            }

            if (pkg.free_package_conversion_24m === 'true' || pkg.free_package_conversion_24m === true) {
                features.push(`
                    <div class="feature-tag">
                        <i data-lucide="repeat"></i>
                        Free Conversion (24M)
                    </div>
                `);
            }

            return features.length > 0 ? features.join('') : null;
        }

        // ===================================
        // UTILITY FUNCTIONS - PRESERVED FROM ORIGINAL
        // ===================================
        function formatPercentage(value) {
            if (value == null || value === 0) return 'N/A';
            return `${value.toFixed(2)}%`;
        }

        function formatCurrency(value) {
            if (!value || value === 0) return '$0';
            return new Intl.NumberFormat('en-SG', {
                style: 'currency',
                currency: 'SGD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }

        // Clear all filters - PRESERVED FROM ORIGINAL
        function clearFilters() {
            document.getElementById('propertyType').value = '';
            document.getElementById('propertyStatus').value = '';
            document.getElementById('buyUnder').value = '';
            document.getElementById('loanAmount').value = '';
            document.getElementById('loanTenure').value = '';
            
            // Clear results
            document.getElementById('resultsContainer').style.display = 'none';
            currentResults = [];
            searchCriteria = {};
        }

        // Download packages list - PRESERVED FROM ORIGINAL
        function downloadPackagesList() {
            if (!currentResults.length) {
                showNotification('No results to download. Please search for packages first.', 'error');
                return;
            }

            generateProfessionalReport();
        }
        // ===================================
        // PACKAGE SELECTION MANAGEMENT
        // ===================================
        function togglePackageSelection(packageIndex) {
            const checkbox = document.getElementById(`pkg-select-${packageIndex}`);
            if (currentResults[packageIndex]) {
                currentResults[packageIndex].selected = checkbox.checked;
                console.log(`ðŸ“‹ Package ${packageIndex} selection:`, checkbox.checked);
                
                // Update selection count display
                updateSelectionCount();
            }
        }

        function updateSelectionCount() {
            const resultsSubtitle = document.querySelector('.results-title');
            if (resultsSubtitle && currentResults.length > 0) {
                const selectedCount = currentResults.filter(pkg => pkg.selected !== false).length;
                resultsSubtitle.innerHTML = `
                    <i data-lucide="trending-up"></i>
                    Recommended Packages
                    <span class="results-count">${currentResults.length}</span>
                    <small style="font-size: 14px; font-weight: 500; color: #6b7280; margin-left: 12px; opacity: 0.8;">
                        (${selectedCount} selected for report)
                    </small>
                `;
                
                // Re-initialize lucide icons
                setTimeout(() => {
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                }, 50);
            }
        }

        function toggleAllSelections() {
            const anySelected = currentResults.some(pkg => pkg.selected !== false);
            const newState = !anySelected;
            
            currentResults.forEach((pkg, index) => {
                pkg.selected = newState;
                const checkbox = document.getElementById(`pkg-select-${index}`);
                if (checkbox) {
                    checkbox.checked = newState;
                }
            });
            
            updateSelectionCount();
            showNotification(newState ? 'All packages selected for report' : 'All packages deselected', 'info');
        }

        // ===================================
        // PACKAGE REMARKS MANAGEMENT
        // ===================================
        function updatePackageRemarks(packageIndex, newRemarks) {
            if (currentResults[packageIndex]) {
                currentResults[packageIndex].custom_remarks = newRemarks;
                console.log(`ðŸ“ Updated remarks for package ${packageIndex}:`, newRemarks);
            }
        }

        // ===================================
        // REPORT GENERATION FUNCTIONS
        // ===================================
        function downloadPackagesList() {
            if (!currentResults.length) {
                showNotification('No results to download. Please search for packages first.', 'error');
                return;
            }

            generateProfessionalReport();
        }

        // FIXED generateProfessionalReport function - remove duplicate variable declaration

function generateProfessionalReport() {
    if (!currentResults.length) {
        showNotification('No results to generate report. Please search for packages first.', 'error');
        return;
    }

    // Get report options
    const clientName = document.getElementById('clientName').value.trim();
    const hideBankNames = document.getElementById('hideBankNames').checked;

    // Get selected packages or default to top 3
    let selectedPackages = currentResults.filter(pkg => pkg.selected !== false);
    if (selectedPackages.length === 0) {
        selectedPackages = currentResults.slice(0, 3);
    } else {
        selectedPackages = selectedPackages.slice(0, 3);
    }

    if (selectedPackages.length === 0) {
        showNotification('Please select at least one package for the report.', 'error');
        return;
    }

    console.log('ðŸ“„ Generating enhanced professional report for', selectedPackages.length, 'packages');

    const reportDate = new Date().toLocaleDateString('en-SG', {
        day: 'numeric',
        month: 'short',
        year: 'numeric'
    });

    // Enhanced calculations
    const loanAmount = searchCriteria.loanAmount || 0;
    const loanTenure = searchCriteria.loanTenure || 25;
    const existingRate = searchCriteria.existingInterestRate || 0;
    const isRefinancing = currentLoanType === 'Refinancing Home Loan' && existingRate > 0;

    const reportContent = `
        <div style="padding: 0; background: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; color: #2d3748;">
            
            <!-- Enhanced Header Section -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 40px; color: white; position: relative; overflow: hidden;">
                <div style="position: absolute; top: -50px; right: -50px; width: 200px; height: 200px; background: rgba(255,255,255,0.1); border-radius: 50%; opacity: 0.7;"></div>
                <div style="position: absolute; bottom: -30px; left: -30px; width: 150px; height: 150px; background: rgba(255,255,255,0.05); border-radius: 50%;"></div>
                
                <div style="display: flex; justify-content: space-between; align-items: flex-start; position: relative; z-index: 2;">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
                            <div style="width: 80px; height: 80px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px);">
                                <div style="font-size: 28px; font-weight: bold;">KQ</div>
                            </div>
                            <div>
                                <h1 style="margin: 0; font-size: 32px; font-weight: 800; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">Keyquest Mortgage</h1>
                                <p style="margin: 4px 0 0 0; font-size: 16px; opacity: 0.9;">Professional Mortgage Advisory</p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: right; flex-shrink: 0;">
                        <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 12px; backdrop-filter: blur(10px);">
                            <h2 style="margin: 0 0 8px 0; font-size: 24px; font-weight: 700;">${isRefinancing ? 'Refinancing' : 'Mortgage'} Analysis Report</h2>
                            ${clientName ? `<p style="margin: 0 0 8px 0; font-size: 18px; font-weight: 600;">Prepared for: ${clientName}</p>` : ''}
                            <p style="margin: 0; font-size: 14px; opacity: 0.8;">Report Date: ${reportDate}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loan Summary Section -->
            <div style="padding: 30px 40px; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border-bottom: 1px solid #e2e8f0;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 24px;">
                    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-left: 4px solid #667eea;">
                        <div style="font-size: 14px; color: #64748b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Loan Amount</div>
                        <div style="font-size: 28px; font-weight: bold; color: #1e293b;">${formatCurrency(loanAmount)}</div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-left: 4px solid #10b981;">
                        <div style="font-size: 14px; color: #64748b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Loan Tenure</div>
                        <div style="font-size: 28px; font-weight: bold; color: #1e293b;">${loanTenure} Years</div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-left: 4px solid #f59e0b;">
                        <div style="font-size: 14px; color: #64748b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Loan Type</div>
                        <div style="font-size: 20px; font-weight: bold; color: #1e293b;">${currentLoanType}</div>
                    </div>
                    ${isRefinancing ? `
                    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-left: 4px solid #ef4444;">
                        <div style="font-size: 14px; color: #64748b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Current Rate</div>
                        <div style="font-size: 28px; font-weight: bold; color: #1e293b;">${formatPercentage(existingRate)}</div>
                    </div>
                    ` : ''}
                </div>
            </div>

            <!-- Visual Refinancing Comparison -->
            ${isRefinancing ? generateRefinancingComparison(selectedPackages, loanAmount, loanTenure, existingRate) : ''}

            <!-- Enhanced Package Comparison Table -->
            <div style="padding: 40px;">
                <h2 style="margin: 0 0 24px 0; font-size: 24px; font-weight: 700; color: #1e293b; display: flex; align-items: center; gap: 12px;">
                    <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                        <span style="color: white; font-size: 16px;">ðŸ“Š</span>
                    </div>
                    Package Comparison Analysis
                </h2>
                
                <div style="overflow-x: auto; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.12);">
                    <table style="width: 100%; border-collapse: collapse; background: white; font-size: 13px;">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                <th style="padding: 16px; text-align: left; font-weight: 700; font-size: 14px; letter-spacing: 0.5px;">DETAILS</th>
                                ${selectedPackages.map((pkg, index) => `
                                    <th style="padding: 16px; text-align: center; font-weight: 700; font-size: 14px; border-left: 1px solid rgba(255,255,255,0.2); ${index === 0 ? 'background: linear-gradient(135deg, #10b981 0%, #059669 100%);' : ''}">
                                        <div style="margin-bottom: 4px;">
                                            ${hideBankNames ? `PACKAGE ${String.fromCharCode(65 + index)}` : pkg.bank_name}
                                        </div>
                                        <div style="font-size: 11px; opacity: 0.9; font-weight: 500;">
                                            ${pkg.rate_type_category} Rate
                                        </div>
                                        ${index === 0 ? '<div style="font-size: 10px; margin-top: 4px; background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 12px;">RECOMMENDED</div>' : ''}
                                    </th>
                                `).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${generateEnhancedComparisonRows(selectedPackages, loanAmount, loanTenure, existingRate, hideBankNames, isRefinancing)}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Year-by-Year Analysis for Refinancing -->
            ${isRefinancing ? generateYearlyAnalysisSection(selectedPackages, hideBankNames, existingRate) : ''}

            <!-- Package Features Comparison -->
            <div style="padding: 0 40px 40px 40px;">
                <h2 style="margin: 0 0 24px 0; font-size: 24px; font-weight: 700; color: #1e293b; display: flex; align-items: center; gap: 12px;">
                    <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                        <span style="color: white; font-size: 16px;">â­</span>
                    </div>
                    Package Features & Benefits
                </h2>
                
                ${generateFeaturesComparison(selectedPackages, hideBankNames)}
            </div>

            <!-- Enhanced Disclaimer -->
            <div style="margin: 0 40px 40px 40px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 24px; border-radius: 12px; border-left: 4px solid #f59e0b;">
                <h3 style="margin: 0 0 16px 0; color: #92400e; font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 8px;">
                    <span>âš ï¸</span> Important Disclaimer
                </h3>
                <div style="font-size: 13px; line-height: 1.6; color: #7c2d12;">
                    <p style="margin: 0 0 12px 0;"><strong>Interest Rate Disclaimer:</strong> All interest rates shown are indicative and subject to the bank's final approval. Actual rates may vary based on individual credit assessment, loan-to-value ratio, and prevailing market conditions.</p>
                    <p style="margin: 0 0 12px 0;"><strong>Refinancing Considerations:</strong> For refinancing customers, please verify with your current bank regarding early redemption penalties, clawback provisions, or other fees before proceeding with refinancing.</p>
                    <p style="margin: 0 0 12px 0;"><strong>Professional Advice:</strong> This report is for informational purposes only and does not constitute financial advice. Please consult with qualified financial advisors before making any loan decisions.</p>
                    <p style="margin: 0;"><strong>Accuracy:</strong> While every effort has been made to ensure accuracy, Keyquest Mortgage Advisory accepts no liability for decisions made based on this report. All calculations are estimates and may differ from actual bank computations.</p>
                </div>
            </div>

            <!-- Professional Footer -->
            <div style="background: #1e293b; color: white; padding: 24px 40px; text-align: center;">
                <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">Keyquest Mortgage Advisory</div>
                <div style="font-size: 13px; opacity: 0.8;">Professional Mortgage Advisory Services | Generated on ${reportDate}</div>
                <div style="font-size: 12px; opacity: 0.6; margin-top: 8px;">This report is confidential and intended solely for the named recipient.</div>
            </div>
        </div>
    `;

    openReportModal(reportContent);
}

        function openReportModal(content) {
            // Create modal if it doesn't exist
            let modal = document.getElementById('report-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'report-modal';
                modal.className = 'modal';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';
                modal.innerHTML = `
                    <div style="background: white; border-radius: 16px; width: 100%; max-width: 1200px; max-height: 90vh; display: flex; flex-direction: column;">
                        <div style="padding: 20px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="margin: 0; color: #1f2937;">Professional Mortgage Report</h3>
                            <div style="display: flex; gap: 12px;">
                                <button onclick="printReport()" style="padding: 8px 16px; background: #1e40af; color: white; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                                    <i data-lucide="printer" style="width: 16px; height: 16px;"></i>
                                    Print/Save PDF
                                </button>
                                <button onclick="closeReportModal()" style="padding: 8px 12px; background: #6b7280; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                    <i data-lucide="x" style="width: 16px; height: 16px;"></i>
                                </button>
                            </div>
                        </div>
                        <div id="report-content" style="flex: 1; overflow-y: auto;">
                            ${content}
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } else {
                document.getElementById('report-content').innerHTML = content;
            }

            modal.style.display = 'flex';
            
            // Re-initialize Lucide icons for the modal
            setTimeout(() => {
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }, 100);
        }

        function closeReportModal() {
            const modal = document.getElementById('report-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function printReport() {
            const originalTitle = document.title;
            document.title = `Keyquest_Mortgage_Report_${new Date().toISOString().split('T')[0]}`;
            
            const reportContent = document.getElementById('report-content').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${document.title}</title>
                    <style>
                        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
                        @media print {
                            body { margin: 0; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    ${reportContent}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
            
            document.title = originalTitle;
        }

        function exportCSV() {
            if (!currentResults.length) {
                showNotification('No results to export. Please search for packages first.', 'error');
                return;
            }

            const headers = [
                'Rank', 'Bank Name', 'Avg First 2 Years (%)', 'Monthly Installment', 'Property Type', 
                'Property Status', 'Buy Under', 'Rate Type', 'Lock Period', 'Min Loan Size', 'Custom Remarks'
            ];

            const csvContent = [
                headers.join(','),
                ...currentResults.map((pkg, index) => [
                    index + 1,
                    `"${pkg.bank_name}"`,
                    pkg.avgFirst2Years.toFixed(3),
                    pkg.monthlyInstallment.toFixed(2),
                    `"${pkg.property_type}"`,
                    `"${pkg.property_status}"`,
                    `"${pkg.buy_under}"`,
                    `"${pkg.rate_type_category}"`,
                    `"${pkg.lock_period || 'No Lock-in'}"`,
                    (pkg.minimum_loan_size || 0),
                    `"${(pkg.custom_remarks || pkg.remarks || '').replace(/"/g, '""')}"`
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const filename = `mortgage_recommendations_${new Date().toISOString().split('T')[0]}.csv`;
            
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showNotification('Data exported successfully', 'success');
        }

        // ===================================
        // SIGN OUT FUNCTIONS - PRESERVED FROM ORIGINAL  
        // ===================================
        function confirmSignOut() {
            if (confirm('Are you sure you want to sign out?')) {
                performSignOut();
            }
        }

        async function performSignOut() {
            try {
                showLoading('Signing out...');
                
                const { error } = await supabaseClient.auth.signOut();
                if (error) throw error;
                
                // Clear any stored data
                localStorage.clear();
                sessionStorage.clear();
                
                // Redirect to login
                window.location.href = 'login.html';
                
            } catch (error) {
                console.error('Sign out error:', error);
                showNotification('Sign out failed: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // ===================================
        // LOADING AND NOTIFICATION FUNCTIONS - PRESERVED FROM ORIGINAL
        // ===================================
    function showLoading(message = 'Loading...') {
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingText = loadingOverlay.querySelector('.loading-message');
    if (loadingText) loadingText.textContent = message;
    loadingOverlay.style.display = 'flex';
}

function hideLoading() {
    const loadingOverlay = document.getElementById('loadingOverlay');
    if (loadingOverlay) {
        loadingOverlay.style.display = 'none';
    }
}

        function showNotification(message, type = 'info') {
            console.log(`[${type.toUpperCase()}] ${message}`);
            // You can implement a proper notification system here
        }

        // ===================================
        // MODAL FUNCTIONS
        // ===================================
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'flex';
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // ===================================
        // SIDEBAR FUNCTIONS - PRESERVED FROM ORIGINAL
        // ===================================
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            
            sidebar?.classList.toggle('open');
            overlay?.classList.toggle('active');
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            
            sidebar?.classList.remove('open');
            overlay?.classList.remove('active');
        }
        // Helper function for enhanced comparison rows
function generateEnhancedComparisonRows(packages, loanAmount, loanTenure, existingRate, hideBankNames, isRefinancing) {
    const rows = [
        // Basic Information
        {
            label: 'Min Loan Amount',
            getValue: (pkg) => formatCurrency(pkg.minimum_loan_size || 0),
            isHighlight: false
        },
        {
            label: 'Lock-in Period',
            getValue: (pkg) => pkg.lock_period || 'No Lock-in',
            isHighlight: false
        },
        {
            label: 'Property Type',
            getValue: (pkg) => pkg.property_type || 'N/A',
            isHighlight: false
        },
        
        // Interest Rates
        {
            label: 'Year 1 Rate',
            getValue: (pkg) => formatRateDisplay(pkg, 1),
            isHighlight: true
        },
        {
            label: 'Year 2 Rate',
            getValue: (pkg) => formatRateDisplay(pkg, 2),
            isHighlight: true
        },
        {
            label: 'Thereafter Rate',
            getValue: (pkg) => formatRateDisplay(pkg, 'thereafter'),
            isHighlight: true
        },
        
        // Financial Calculations
        {
            label: 'Monthly Installment (Avg)',
            getValue: (pkg) => formatCurrency(pkg.monthlyInstallment || 0),
            isHighlight: true
        }
    ];
    
    // Add refinancing-specific rows
    if (isRefinancing) {
        rows.push({
            label: 'Monthly Savings',
            getValue: (pkg) => {
                const savings = pkg.monthlySavings || 0;
                return savings > 0 ? `+${formatCurrency(savings)}` : formatCurrency(savings);
            },
            isHighlight: true,
            isGreen: true
        });
        
        rows.push({
            label: 'Total Savings (Lock-in Period)',
            getValue: (pkg) => {
                const savings = pkg.totalSavings || 0;
                return savings > 0 ? `+${formatCurrency(savings)}` : formatCurrency(savings);
            },
            isHighlight: true,
            isGreen: true
        });
    }

    return rows.map((row) => `
        <tr style="border-bottom: 1px solid #f1f5f9; ${row.isHighlight ? 'background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);' : ''}">
            <td style="padding: 16px; font-weight: 700; color: #374151; border-right: 1px solid #f1f5f9;">
                ${row.label}
            </td>
            ${packages.map((pkg, index) => {
                const value = row.getValue(pkg);
                const isRecommended = index === 0;
                const cellColor = row.isGreen ? '#065f46' : '#1e293b';
                const bgColor = isRecommended ? (row.isHighlight ? '#f0fdf4' : '#f8fafc') : 'white';
                
                return `
                    <td style="padding: 16px; text-align: center; border-right: 1px solid #f1f5f9; background: ${bgColor}; color: ${cellColor}; font-weight: 600; font-size: ${row.isHighlight ? '14px' : '13px'};">
                        ${value}
                    </td>
                `;
            }).join('')}
        </tr>
    `).join('');
}

// Helper function for refinancing comparison
function generateRefinancingComparison(packages, loanAmount, loanTenure, existingRate) {
    if (!existingRate || existingRate <= 0) return '';
    
    const bestPackage = packages[0];
    const currentMonthly = calculateMonthlyInstallment(loanAmount, loanTenure, existingRate);
    const newMonthly = bestPackage.monthlyInstallment || 0;
    const monthlySavings = currentMonthly - newMonthly;
    
    return `
        <div style="padding: 40px; background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);">
            <h2 style="margin: 0 0 24px 0; font-size: 24px; font-weight: 700; color: #065f46; text-align: center;">
                ðŸ’° Refinancing Benefits Analysis
            </h2>
            
            <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 32px; align-items: center; max-width: 800px; margin: 0 auto;">
                <!-- Current Package -->
                <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); text-align: center;">
                    <div style="font-size: 16px; color: #64748b; font-weight: 600; margin-bottom: 8px;">CURRENT PACKAGE</div>
                    <div style="font-size: 28px; font-weight: bold; color: #ef4444; margin-bottom: 8px;">${formatPercentage(existingRate)}</div>
                    <div style="font-size: 14px; color: #64748b;">Monthly: ${formatCurrency(currentMonthly)}</div>
                </div>
                
                <!-- Arrow -->
                <div style="text-align: center;">
                    <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: bold;">
                        â†’
                    </div>
                    <div style="font-size: 12px; color: #10b981; font-weight: 600; margin-top: 8px;">SAVE</div>
                </div>
                
                <!-- Recommended Package -->
                <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); text-align: center; border: 2px solid #10b981;">
                    <div style="font-size: 16px; color: #64748b; font-weight: 600; margin-bottom: 8px;">RECOMMENDED</div>
                    <div style="font-size: 28px; font-weight: bold; color: #10b981; margin-bottom: 8px;">${formatPercentage(bestPackage.avgFirst2Years)}</div>
                    <div style="font-size: 14px; color: #64748b;">Monthly: ${formatCurrency(newMonthly)}</div>
                </div>
            </div>
            
            <!-- Savings Summary -->
            <div style="text-align: center; margin-top: 32px;">
                <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); display: inline-block; border: 2px solid #10b981;">
                    <div style="font-size: 18px; color: #065f46; font-weight: 700; margin-bottom: 8px;">POTENTIAL MONTHLY SAVINGS</div>
                    <div style="font-size: 36px; font-weight: bold; color: #10b981;">${formatCurrency(monthlySavings)}</div>
                    <div style="font-size: 14px; color: #064e3b; margin-top: 8px;">
                        Total savings over lock-in period: ${formatCurrency(bestPackage.totalSavings || 0)}
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Helper function for yearly analysis section
function generateYearlyAnalysisSection(packages, hideBankNames, existingRate) {
    return `
        <div style="padding: 40px;">
            <h2 style="margin: 0 0 24px 0; font-size: 24px; font-weight: 700; color: #1e293b; display: flex; align-items: center; gap: 12px;">
                <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                    <span style="color: white; font-size: 16px;">ðŸ“ˆ</span>
                </div>
                5-Year Interest Rate Analysis
            </h2>
            
            <div style="overflow-x: auto; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.12);">
                <table style="width: 100%; border-collapse: collapse; background: white; font-size: 13px;">
                    <thead>
                        <tr style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">
                            <th style="padding: 16px; text-align: left; font-weight: 700;">YEAR</th>
                            <th style="padding: 16px; text-align: center; font-weight: 700;">CURRENT RATE</th>
                            ${packages.map((pkg, index) => `
                                <th style="padding: 16px; text-align: center; font-weight: 700; border-left: 1px solid rgba(255,255,255,0.2);">
                                    ${hideBankNames ? `PKG ${String.fromCharCode(65 + index)}` : pkg.bank_name}
                                </th>
                            `).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${[1,2,3,4,5].map(year => `
                            <tr style="border-bottom: 1px solid #f1f5f9;">
                                <td style="padding: 16px; font-weight: 700; color: #374151;">Year ${year}</td>
                                <td style="padding: 16px; text-align: center; background: #fef2f2; color: #dc2626; font-weight: 600;">
                                    ${formatPercentage(existingRate)}
                                </td>
                                ${packages.map((pkg, index) => `
                                    <td style="padding: 16px; text-align: center; background: ${index === 0 ? '#f0fdf4' : 'white'}; color: ${index === 0 ? '#065f46' : '#1e293b'}; font-weight: 600;">
                                        ${formatRateDisplay(pkg, year)}
                                    </td>
                                `).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

// Helper function for features comparison
function generateFeaturesComparison(packages, hideBankNames) {
    const features = [
        { key: 'legal_fee_subsidy', label: 'Legal Fee Subsidy', icon: 'âš–ï¸' },
        { key: 'cash_rebate', label: 'Cash Rebate', icon: 'ðŸ’°' },
        { key: 'free_package_conversion_12m', label: 'Free Conversion (12M)', icon: 'ðŸ”„' },
        { key: 'free_package_conversion_24m', label: 'Free Conversion (24M)', icon: 'ðŸ”„' },
        { key: 'valuation_subsidy', label: 'Valuation Subsidy', icon: 'ðŸ ' },
        { key: 'partial_repayment', label: 'Partial Repayment', icon: 'ðŸ’³' },
        { key: 'waiver_due_to_sales', label: 'Waiver Due to Sales', icon: 'ðŸ·ï¸' }
    ];

    return `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px;">
            ${packages.map((pkg, index) => `
                <div style="background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); overflow: hidden; ${index === 0 ? 'border: 2px solid #10b981;' : 'border: 1px solid #e2e8f0;'}">
                    <div style="background: ${index === 0 ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)' : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'}; color: white; padding: 20px; text-align: center;">
                        <h3 style="margin: 0 0 8px 0; font-size: 18px; font-weight: 700;">
                            ${hideBankNames ? `Package ${String.fromCharCode(65 + index)}` : pkg.bank_name}
                        </h3>
                        <div style="font-size: 14px; opacity: 0.9;">${pkg.rate_type_category} Rate Package</div>
                        ${index === 0 ? '<div style="margin-top: 8px; background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 16px; font-size: 12px; font-weight: 600;">RECOMMENDED</div>' : ''}
                    </div>
                    
                    <div style="padding: 24px;">
                        <div style="space-y: 12px;">
                            ${features.map(feature => {
                                const hasFeature = pkg[feature.key] === 'true' || pkg[feature.key] === true;
                                return `
                                    <div style="display: flex; align-items: center; gap: 12px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
                                        <span style="font-size: 16px; opacity: ${hasFeature ? '1' : '0.3'};">${feature.icon}</span>
                                        <span style="flex: 1; color: ${hasFeature ? '#10b981' : '#9ca3af'}; font-weight: ${hasFeature ? '600' : '400'}; font-size: 14px;">
                                            ${feature.label}
                                        </span>
                                        <span style="font-size: 18px; color: ${hasFeature ? '#10b981' : '#ef4444'};">
                                            ${hasFeature ? 'âœ“' : 'âœ—'}
                                        </span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        ${pkg.custom_remarks || pkg.remarks ? `
                            <div style="margin-top: 20px; padding: 16px; background: #f8fafc; border-radius: 8px; border-left: 4px solid #667eea;">
                                <div style="font-size: 12px; color: #64748b; font-weight: 600; text-transform: uppercase; margin-bottom: 8px;">Remarks</div>
                                <div style="font-size: 13px; color: #374151; line-height: 1.5;">
                                    ${(pkg.custom_remarks || pkg.remarks || '').replace(/\n/g, '<br>')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}
    </script>
</body>
</html>
