<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recommended Packages - Keyquest Mortgage Admin</title>
    <link rel="stylesheet" href="css/admin-styles.css">
    <!-- Required Scripts in correct order -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/lucide.min.js"></script>
    <script src="config/supabase.js"></script>
    <script src="js/admin-scripts.js"></script>
    <style>
        /* Enhanced Recommended Packages Styles */
        .page-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 32px;
            border-radius: 20px;
            margin-bottom: 32px;
            box-shadow: 0 12px 40px rgba(102, 126, 234, 0.25);
            position: relative;
            overflow: hidden;
        }

        .page-header::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 200px;
            height: 200px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transform: translate(50%, -50%);
        }

        .page-header h1 {
            margin: 0 0 12px 0;
            font-size: 32px;
            font-weight: 800;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .page-header p {
            margin: 0;
            opacity: 0.95;
            font-size: 16px;
            font-weight: 500;
        }

        /* Enhanced Loan Type Tabs */
        .loan-type-tabs {
            display: flex;
            background: white;
            border-radius: 20px;
            padding: 8px;
            margin-bottom: 32px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
            backdrop-filter: blur(10px);
        }

        .loan-tab {
            flex: 1;
            padding: 20px 24px;
            text-align: center;
            border-radius: 16px;
            border: none;
            background: transparent;
            color: #64748b;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-size: 15px;
            position: relative;
            overflow: hidden;
        }

        .loan-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.6s;
        }

        .loan-tab:hover::before {
            left: 100%;
        }

        .loan-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
            transform: translateY(-3px);
        }

        .loan-tab:hover:not(.active) {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            color: #475569;
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        /* Enhanced Search Section */
        .search-section {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 24px;
            padding: 40px;
            margin-bottom: 32px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.08);
            position: relative;
            overflow: hidden;
        }

        .search-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2, #667eea);
            background-size: 200% 100%;
            animation: gradientShift 3s ease-in-out infinite;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .search-title {
            font-size: 24px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .search-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .form-group {
            position: relative;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 15px;
            background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            background: #ffffff;
            transform: translateY(-2px);
        }

        .search-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }

        .search-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s;
        }

        .search-button:hover::before {
            left: 100%;
        }

        .search-button:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6b4190 100%);
            transform: translateY(-3px);
            box-shadow: 0 12px 32px rgba(102, 126, 234, 0.4);
        }

        /* Enhanced Results Section */
        .results-section {
            background: white;
            border-radius: 20px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .results-header {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 24px 32px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .results-title {
            font-size: 20px;
            font-weight: 700;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .results-count {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .download-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .download-btn:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3);
        }

        /* Enhanced Package Cards */
        .packages-container {
            padding: 32px;
        }

        .package-card {
            background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
            border-radius: 20px;
            border: 2px solid #e2e8f0;
            padding: 32px;
            margin-bottom: 24px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .package-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .package-card:hover::before {
            opacity: 1;
        }

        .package-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.12);
            border-color: rgba(102, 126, 234, 0.3);
        }

        .package-rank {
            position: absolute;
            top: -2px;
            right: 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 18px;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .package-rank.rank-1 {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
            transform: scale(1.1);
        }

        .package-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 24px;
            gap: 24px;
        }

        .bank-info h3 {
            font-size: 24px;
            font-weight: 800;
            color: #1e293b;
            margin: 0 0 8px 0;
        }

        .package-type {
            color: #64748b;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .rate-info {
            text-align: right;
        }

        .avg-rate {
            font-size: 32px;
            font-weight: 900;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1;
        }

        .rate-label {
            font-size: 12px;
            color: #64748b;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .installment {
            font-size: 20px;
            font-weight: 700;
            color: #059669;
        }

        /* Enhanced Package Details Grid */
        .package-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
            margin: 24px 0;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .detail-item:hover {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            transform: translateY(-2px);
        }

        .detail-label {
            font-weight: 600;
            color: #6b7280;
            font-size: 14px;
        }

        .detail-value {
            font-weight: 700;
            color: #1f2937;
            font-size: 14px;
        }

        /* Enhanced Rate Schedule */
        .rate-schedule {
            background: linear-gradient(135deg, #ecfdf5 0%, #f0fdf4 100%);
            border: 2px solid #bbf7d0;
            border-radius: 16px;
            padding: 24px;
            margin: 24px 0;
            position: relative;
            overflow: hidden;
        }

        .rate-schedule::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #10b981, #059669);
        }

        .rate-schedule-title {
            font-weight: 700;
            color: #065f46;
            margin-bottom: 20px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .rate-schedule-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 16px;
        }

        .rate-item {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid #d1fae5;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .rate-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(16, 185, 129, 0.1), transparent);
            transition: left 0.6s;
        }

        .rate-item:hover::before {
            left: 100%;
        }

        .rate-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.25);
            border-color: #10b981;
        }

        .rate-period {
            font-size: 12px;
            color: #6b7280;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .rate-value {
            font-size: 20px;
            font-weight: 800;
            color: #059669;
        }

        /* Enhanced Remarks Section */
        .package-remarks {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #fcd34d;
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
        }

        .package-remarks::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #f59e0b, #d97706);
        }

        .remarks-title {
            font-weight: 700;
            color: #92400e;
            margin-bottom: 12px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .remarks-content {
            color: #92400e;
            font-size: 14px;
            line-height: 1.6;
            font-weight: 500;
        }

        /* Enhanced Package Remarks Editor */
        .package-remarks-editor {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px solid #0ea5e9;
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
        }

        .package-remarks-editor::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #0ea5e9, #0284c7);
        }

        .remarks-editor-title {
            font-weight: 700;
            color: #0c4a6e;
            margin-bottom: 12px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .remarks-textarea {
            width: 100%;
            min-height: 80px;
            padding: 12px 16px;
            border: 2px solid #bae6fd;
            border-radius: 10px;
            background: white;
            color: #0c4a6e;
            font-size: 14px;
            line-height: 1.5;
            resize: vertical;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .remarks-textarea:focus {
            outline: none;
            border-color: #0ea5e9;
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }

        .remarks-textarea::placeholder {
            color: #64748b;
            font-style: italic;
        }

        /* Enhanced Features Section */
        .package-features {
            margin: 24px 0;
        }

        .features-title {
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 16px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .features-list {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .feature-tag {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            color: #1e40af;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid #93c5fd;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
        }

        .feature-tag:hover {
            background: linear-gradient(135deg, #bfdbfe 0%, #93c5fd 100%);
            transform: translateY(-2px);
        }

        /* Enhanced Action Buttons */
        .package-actions {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .enquire-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);
        }

        .enquire-btn:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6b4190 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
        }

        /* Enhanced No Results State */
        .no-results {
            text-align: center;
            padding: 60px 32px;
            color: #64748b;
        }

        .no-results i {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .no-results h3 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 12px;
            color: #1e293b;
        }

        .no-results p {
            font-size: 16px;
            margin-bottom: 24px;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .search-form {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                gap: 16px;
            }
            
            .package-details {
                grid-template-columns: 1fr;
            }
            
            .rate-schedule-grid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .page-header {
                padding: 24px 20px;
                text-align: center;
            }
            
            .page-header h1 {
                font-size: 24px;
            }
            
            .loan-type-tabs {
                flex-direction: column;
                gap: 8px;
            }
            
            .search-section {
                padding: 24px 20px;
            }
            
            .search-form {
                grid-template-columns: 1fr;
            }
            
            .package-header {
                flex-direction: column;
                text-align: center;
                gap: 16px;
            }
            
            .rate-info {
                text-align: center;
            }
            
            .packages-container {
                padding: 20px;
            }
            
            .package-card {
                padding: 20px;
            }
            
            .package-actions {
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .rate-schedule-grid {
                grid-template-columns: 1fr;
            }
            
            .features-list {
                flex-direction: column;
            }
            
            .detail-item {
                flex-direction: column;
                gap: 8px;
                text-align: center;
            }

            .remarks-textarea {
                min-height: 60px;
                font-size: 13px;
            }

            .package-remarks-editor {
                padding: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="overlay" id="overlay" onclick="closeSidebar()"></div>
    
    <div class="admin-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="index.html" class="logo">
                    <div class="logo-icon">
                        <i data-lucide="building-2"></i>
                    </div>
                    <span>KEYQUEST</span>
                </a>
            </div>
            <nav class="nav-menu">
                <a href="index.html" class="nav-item">
                    <i data-lucide="layout-dashboard"></i>
                    <span>Dashboard</span>
                </a>
                <a href="rate-packages.html" class="nav-item">
                    <i data-lucide="package"></i>
                    <span>Rate Package</span>
                </a>
                <a href="rate-types.html" class="nav-item">
                    <i data-lucide="percent"></i>
                    <span>Rate Type</span>
                </a>
                <a href="banks.html" class="nav-item">
                    <i data-lucide="landmark"></i>
                    <span>Bank</span>
                </a>
                <a href="bankers.html" class="nav-item">
                    <i data-lucide="briefcase"></i>
                    <span>Bankers</span>
                </a>
                <a href="agents.html" class="nav-item">
                    <i data-lucide="users"></i>
                    <span>Agents</span>
                </a>
                <a href="enquiry.html" class="nav-item">
                    <i data-lucide="help-circle"></i>
                    <span>Enquiry</span>
                </a>
                <a href="recommended-packages.html" class="nav-item active">
                    <i data-lucide="award"></i>
                    <span>Recommended Packages</span>
                </a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content" id="mainContent">
            <header class="header">
                <div class="header-left">
                    <button class="menu-toggle" onclick="toggleSidebar()">
                        <i data-lucide="menu"></i>
                    </button>
                    <h1 class="header-title">Recommended Packages</h1>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="confirmSignOut()">
                        <i data-lucide="log-out"></i>
                        <span>Sign Out</span>
                    </button>
                    <div class="user-profile">
                        <div class="user-avatar" id="userAvatar">A</div>
                        <div class="user-info">
                            <div class="user-name" id="userName">admin</div>
                            <div class="user-role">Super Admin</div>
                        </div>
                    </div>
                </div>
            </header>
            
            <div class="content-area">
                <!-- Page Header -->
                <div class="page-header">
                    <h1><i data-lucide="award"></i> Find Your Perfect Home Loan</h1>
                    <p>Discover the best mortgage packages tailored to your needs with our smart recommendation engine</p>
                </div>

                <!-- Loan Type Tabs -->
                <div class="loan-type-tabs">
                    <button class="loan-tab active" onclick="selectLoanType('New Home Loan')" data-loan-type="New Home Loan">
                        <i data-lucide="home"></i>
                        New Home Loan
                    </button>
                    <button class="loan-tab" onclick="selectLoanType('Refinancing Home Loan')" data-loan-type="Refinancing Home Loan">
                        <i data-lucide="repeat"></i>
                        Refinancing Home Loan
                    </button>
                    <button class="loan-tab" onclick="selectLoanType('Commercial/Industrial')" data-loan-type="Commercial/Industrial">
                        <i data-lucide="briefcase"></i>
                        Commercial/Industrial
                    </button>
                </div>

                <!-- Search Section -->
                <div class="search-section">
                    <h2 class="search-title">
                        <i data-lucide="search"></i>
                        Enter Your Requirements
                    </h2>
                    <form class="search-form" id="searchForm" onsubmit="searchPackages(event)">
                        <div class="form-group">
                            <label class="form-label">Property Type</label>
                            <select class="form-select" id="propertyType">
                                <option value="">Select Property Type</option>
                                <option value="Private Property">Private Property</option>
                                <option value="HDB">HDB</option>
                                <option value="EC">EC</option>
                                <option value="Commercial">Commercial</option>
                                <option value="Industrial">Industrial</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Property Status</label>
                            <select class="form-select" id="propertyStatus">
                                <option value="">Select Property Status</option>
                                <option value="Completed">Completed</option>
                                <option value="Under Construction">Under Construction</option>
                                <option value="BUC">Build Under Construction</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Buy Under</label>
                            <select class="form-select" id="buyUnder">
                                <option value="">Select Buy Under</option>
                                <option value="Individual Name">Individual Name</option>
                                <option value="Company Operating">Company Operating</option>
                                <option value="Company Investment">Company Investment</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Loan Amount ($)</label>
                            <input type="number" class="form-input" id="loanAmount" placeholder="500,000" min="0" step="1000">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Loan Tenure</label>
                            <select class="form-select" id="loanTenure">
                                <option value="">Select Tenure</option>
                                <option value="20">20 years</option>
                                <option value="25">25 years</option>
                                <option value="30">30 years</option>
                                <option value="35">35 years</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <button type="submit" class="search-button">
                                <i data-lucide="search"></i>
                                Find Best Packages
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Results Section -->
                <div class="results-section" id="resultsContainer" style="display: none;">
                    <div class="results-header">
                        <div class="results-title">
                            <i data-lucide="trending-up"></i>
                            Recommended Packages
                            <span class="results-count" id="resultsCount">0</span>
                        </div>
                        <button class="download-btn" onclick="generateProfessionalReport()">
                            <i data-lucide="file-text"></i>
                            Generate Report
                        </button>
                        <button class="download-btn" onclick="exportCSV()" style="background: linear-gradient(135deg, #059669 0%, #047857 100%); margin-left: 12px;">
                            <i data-lucide="download"></i>
                            Export CSV
                        </button>
                    </div>
                    
                    <div class="packages-container" id="packagesContainer">
                        <!-- Package cards will be dynamically inserted here -->
                    </div>
                    
                    <div class="no-results" id="noResults" style="display: none;">
                        <i data-lucide="search"></i>
                        <h3>No Matching Packages Found</h3>
                        <p>Try adjusting your search criteria to find more suitable options.</p>
                        <button class="btn btn-primary" onclick="clearFilters()">
                            <i data-lucide="rotate-ccw"></i>
                            Reset Search
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loading-spinner">
            <i data-lucide="loader" class="animate-spin"></i>
            <span>Finding the best packages for you...</span>
        </div>
    </div>

    <script>
        // ===================================
        // GLOBAL VARIABLES - PRESERVED FROM ORIGINAL
        // ===================================
        let allPackages = [];
        let rateTypes = [];
        let currentLoanType = 'New Home Loan';
        let currentResults = [];
        let searchCriteria = {};

        // ===================================
        // INITIALIZATION - PRESERVED FROM ORIGINAL
        // ===================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Recommended Packages page loading...');
            checkAuthentication();
            setupEventListeners();
            loadData();
        });

        // ===================================
        // AUTHENTICATION CHECK - PRESERVED FROM ORIGINAL
        // ===================================
        async function checkAuthentication() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) {
                    console.warn('❌ No authenticated user found, redirecting to login');
                    window.location.href = 'login.html';
                    return;
                }

                // Update user display
                if (user.email) {
                    document.getElementById('userName').textContent = user.email.split('@')[0];
                    document.getElementById('userAvatar').textContent = user.email.charAt(0).toUpperCase();
                }
            } catch (error) {
                console.error('💥 Auth check failed:', error);
                window.location.href = 'login.html';
            }
        }

        // ===================================
        // EVENT LISTENERS SETUP - PRESERVED FROM ORIGINAL
        // ===================================
        function setupEventListeners() {
            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

            // Close dropdowns when clicking outside
            document.addEventListener('click', function(event) {
                const userDropdown = document.getElementById('userDropdown');
                const userInfo = document.querySelector('.user-info');
                
                if (userInfo && !userInfo.contains(event.target)) {
                    userDropdown?.classList.remove('show');
                }
            });
        }

        // ===================================
        // DATA LOADING - PRESERVED FROM ORIGINAL
        // ===================================
        async function loadData() {
            console.log('🔄 Starting data load...');
            
            try {
                showLoading('Loading rate types...');
                
                // Load rate types first
                console.log('📊 Loading rate types...');
                await loadRateTypes();
                console.log(`✅ Loaded ${rateTypes.length} rate types`);
                
                showLoading('Loading packages...');
                
                // Load packages
                console.log('📦 Loading packages...');
                await loadPackages();
                console.log(`✅ Loaded ${allPackages.length} packages`);
                
                // Force hide any loading overlays
                hideLoading();
                
                showNotification(`Data loaded successfully: ${rateTypes.length} rate types, ${allPackages.length} packages`, 'success');
                
            } catch (error) {
                console.error('❌ Error loading data:', error);
                showNotification('Error loading data: ' + error.message, 'error');
            } finally {
                // Force hide loading to ensure it's properly cleared
                hideLoading();
                console.log('🏁 Data loading completed');
            }
        }

        // Load rate types for calculations - PRESERVED FROM ORIGINAL
        async function loadRateTypes() {
            try {
                console.log('🔍 Querying rate_types table...');
                const { data, error } = await supabaseClient
                    .from('rate_types')
                    .select('rate_type, rate_value')
                    .order('rate_type');

                if (error) {
                    console.error('❌ Supabase error loading rate types:', error);
                    throw error;
                }
                
                rateTypes = data || [];
                console.log(`✅ Successfully loaded ${rateTypes.length} rate types:`, rateTypes.slice(0, 3));
                
                if (rateTypes.length === 0) {
                    console.warn('⚠️ No rate types found in database');
                }
                
            } catch (error) {
                console.error('❌ Error in loadRateTypes:', error);
                throw new Error(`Failed to load rate types: ${error.message}`);
            }
        }

        // Load all packages - PRESERVED FROM ORIGINAL
        async function loadPackages() {
            try {
                console.log('🔍 Querying rate_packages table...');
                const { data, error } = await supabaseClient
                    .from('rate_packages')
                    .select('*')
                    .order('bank_name');

                if (error) {
                    console.error('❌ Supabase error loading packages:', error);
                    throw error;
                }

                allPackages = data || [];
                console.log(`✅ Successfully loaded ${allPackages.length} packages`);
                
                if (allPackages.length === 0) {
                    console.warn('⚠️ No packages found in database');
                } else {
                    console.log('📦 Sample package:', allPackages[0]);
                }
                
            } catch (error) {
                console.error('❌ Error in loadPackages:', error);
                throw new Error(`Failed to load packages: ${error.message}`);
            }
        }

        // ===================================
        // LOAN TYPE SELECTION - PRESERVED FROM ORIGINAL
        // ===================================
        function selectLoanType(loanType) {
            currentLoanType = loanType;
            
            // Update tab active state
            document.querySelectorAll('.loan-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelector(`[data-loan-type="${loanType}"]`).classList.add('active');
            
            // Clear previous results
            document.getElementById('resultsContainer').style.display = 'none';
            currentResults = [];
            
            console.log('🔄 Loan type selected:', loanType);
        }

        // ===================================
        // SEARCH FUNCTIONALITY - PRESERVED FROM ORIGINAL
        // ===================================
        async function searchPackages(event) {
            if (event) event.preventDefault();
            
            try {
                // Get form values
                const propertyType = document.getElementById('propertyType').value;
                const propertyStatus = document.getElementById('propertyStatus').value;
                const buyUnder = document.getElementById('buyUnder').value;
                const loanAmount = parseFloat(document.getElementById('loanAmount').value);
                const loanTenure = parseInt(document.getElementById('loanTenure').value);

                // Store search criteria
                searchCriteria = {
                    loanType: currentLoanType,
                    propertyType,
                    propertyStatus,
                    buyUnder,
                    loanAmount,
                    loanTenure
                };

                console.log('🔍 Search parameters:', searchCriteria);

                // Validation
                if (!loanAmount || loanAmount <= 0) {
                    showNotification('Please enter a valid loan amount', 'error');
                    return;
                }

                if (!loanTenure) {
                    showNotification('Please select a loan tenure', 'error');
                    return;
                }

                showLoading('Searching for packages...');

                // Debug: Show first few packages for reference
                console.log('📦 Sample packages for debugging:', allPackages.slice(0, 3).map(pkg => ({
                    bank_name: pkg.bank_name,
                    loan_type: pkg.loan_type,
                    property_type: pkg.property_type,
                    property_status: pkg.property_status,
                    buy_under: pkg.buy_under,
                    minimum_loan_size: pkg.minimum_loan_size
                })));

                // Filter packages based on criteria
                let filteredPackages = allPackages.filter(pkg => {
                    // Debug logging for first package
                    if (pkg === allPackages[0]) {
                        console.log('🔍 Debug filtering first package:', {
                            'pkg.loan_type': pkg.loan_type,
                            'currentLoanType': currentLoanType,
                            'loan_type_match': pkg.loan_type === currentLoanType,
                            'pkg.property_type': pkg.property_type,
                            'propertyType': propertyType,
                            'property_type_match': !propertyType || pkg.property_type === propertyType,
                            'pkg.buy_under': pkg.buy_under,
                            'buyUnder': buyUnder,
                            'buy_under_match': !buyUnder || pkg.buy_under === buyUnder,
                            'pkg.minimum_loan_size': pkg.minimum_loan_size,
                            'loanAmount': loanAmount,
                            'loan_size_match': !pkg.minimum_loan_size || loanAmount >= pkg.minimum_loan_size
                        });
                    }

                    // Filter by loan type
                    if (currentLoanType === 'New Home Loan' && pkg.loan_type !== 'New Home Loan') return false;
                    if (currentLoanType === 'Refinancing Home Loan' && pkg.loan_type !== 'Refinancing Home Loan') return false;
                    if (currentLoanType === 'Commercial/Industrial' && 
                        !['Commercial', 'Industrial'].includes(pkg.loan_type)) return false;

                    // Filter by property type
                    if (propertyType && pkg.property_type !== propertyType) return false;

                    // Filter by property status
                    if (propertyStatus && pkg.property_status !== propertyStatus) return false;

                    // Filter by buy under
                    if (buyUnder && pkg.buy_under !== buyUnder) return false;

                    // Filter by minimum loan amount
                    if (loanAmount > 0 && pkg.minimum_loan_size && loanAmount < pkg.minimum_loan_size) return false;

                    return true;
                });

                console.log(`🔍 Found ${filteredPackages.length} matching packages`);

                // Calculate recommendations
                const processedPackages = filteredPackages.map(pkg => {
                    const avgFirst2Years = calculateAverageFirst2Years(pkg);
                    const monthlyInstallment = calculateMonthlyInstallment(pkg, loanAmount, loanTenure);
                    
                    // Calculate recommendation score
                    let score = 0;
                    
                    // Lower rates get higher scores
                    if (avgFirst2Years) {
                        score += (10 - avgFirst2Years) * 10;
                    }
                    
                    // Lower monthly installments get higher scores
                    if (monthlyInstallment) {
                        score += Math.max(0, 100 - (monthlyInstallment / 100));
                    }
                    
                    // Special features add to score
                    if (pkg.legal_fee_subsidy) score += 20;
                    if (pkg.cash_rebate) score += 15;
                    if (pkg.free_package_conversion_12m || pkg.free_package_conversion_24m || pkg.free_package_conversion_36m) score += 10;

                    return {
                        ...pkg,
                        avgFirst2Years,
                        monthlyInstallment,
                        recommendationScore: score
                    };
                })
                .sort((a, b) => b.recommendationScore - a.recommendationScore)
                .slice(0, 10); // Top 10 recommendations

                currentResults = processedPackages;
                displayResults(processedPackages);
                hideLoading();
                
            } catch (error) {
                console.error('❌ Search failed:', error);
                showNotification('Search failed: ' + error.message, 'error');
                hideLoading();
            }
        }

        // ===================================
        // CALCULATION FUNCTIONS - PRESERVED FROM ORIGINAL
        // ===================================
        function calculateAverageFirst2Years(pkg) {
            const year1Rate = calculateInterestRate(pkg, 1);
            const year2Rate = calculateInterestRate(pkg, 2);
            
            if (year1Rate > 0 && year2Rate > 0) {
                return (year1Rate + year2Rate) / 2;
            } else if (year1Rate > 0) {
                return year1Rate;
            } else if (year2Rate > 0) {
                return year2Rate;
            }
            
            return 0;
        }

        function calculateMonthlyInstallment(pkg, loanAmount, tenure) {
            if (!loanAmount || !tenure) return 0;

            const avgRate = calculateAverageFirst2Years(pkg);
            if (avgRate <= 0) return 0;

            const monthlyRate = avgRate / 100 / 12;
            const numPayments = tenure * 12;

            if (monthlyRate === 0) return loanAmount / numPayments;

            const monthlyPayment = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / 
                                 (Math.pow(1 + monthlyRate, numPayments) - 1);
            
            return monthlyPayment;
        }

        // Calculate interest rate for a specific year - PRESERVED FROM ORIGINAL
        function calculateInterestRate(pkg, year) {
            let rateType, operator, value;
            
            if (year === 'thereafter') {
                rateType = pkg.thereafter_rate_type;
                operator = pkg.thereafter_operator;
                value = pkg.thereafter_value;
            } else {
                rateType = pkg[`year${year}_rate_type`];
                operator = pkg[`year${year}_operator`];
                value = pkg[`year${year}_value`];
            }

            if (!rateType || value === null || value === undefined) {
                return 0;
            }

            if (rateType === 'FIXED') {
                return parseFloat(value) || 0;
            } else {
                // Find the reference rate
                const referenceRate = rateTypes.find(rt => rt.rate_type === rateType);
                if (!referenceRate) {
                    console.warn(`❌ Reference rate type not found: ${rateType}`);
                    return 0;
                }

                const baseRate = parseFloat(referenceRate.rate_value) || 0;
                const adjustment = parseFloat(value) || 0;
                
                if (operator === '+') {
                    return baseRate + adjustment;
                } else if (operator === '-') {
                    return Math.max(0, baseRate - adjustment);
                } else {
                    return baseRate;
                }
            }
        }

        // Format rate display for tables - PRESERVED FROM ORIGINAL
        function formatRateDisplay(pkg, year) {
            let rateType, operator, value;
            
            if (year === 'thereafter') {
                rateType = pkg.thereafter_rate_type;
                operator = pkg.thereafter_operator;
                value = pkg.thereafter_value;
            } else {
                rateType = pkg[`year${year}_rate_type`];
                operator = pkg[`year${year}_operator`];
                value = pkg[`year${year}_value`];
            }

            if (!rateType || value === null || value === undefined) return '-';

            if (rateType === 'FIXED') {
                const rate = calculateInterestRate(pkg, year);
                return `${formatPercentage(rate)} Fixed`;
            } else {
                const operatorSymbol = operator === '+' ? '+' : '-';
                return `${rateType} ${operatorSymbol} ${value}%`;
            }
        }

        // ===================================
        // DISPLAY FUNCTIONS - ENHANCED UI WITH PRESERVED LOGIC
        // ===================================
        function displayResults(packages) {
            const resultsContainer = document.getElementById('resultsContainer');
            const packagesContainer = document.getElementById('packagesContainer');
            const resultsCount = document.getElementById('resultsCount');
            const noResults = document.getElementById('noResults');

            resultsCount.textContent = packages.length;

            if (packages.length === 0) {
                packagesContainer.innerHTML = '';
                noResults.style.display = 'block';
            } else {
                noResults.style.display = 'none';
                packagesContainer.innerHTML = packages.map((pkg, index) => createPackageCard(pkg, index)).join('');
            }

            resultsContainer.style.display = 'block';
            resultsContainer.scrollIntoView({ behavior: 'smooth' });
            
            // Re-initialize Lucide icons for dynamically added content
            setTimeout(() => {
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }, 100);
        }

        function createPackageCard(pkg, index) {
            const rateSchedule = generateRateSchedule(pkg);
            const features = generatePackageFeatures(pkg);
            
            return `
                <div class="package-card">
                    <div class="package-rank ${index === 0 ? 'rank-1' : ''}">${index + 1}</div>
                    
                    <div class="package-header">
                        <div class="bank-info">
                            <h3>${pkg.bank_name || 'Unknown Bank'}</h3>
                            <div class="package-type">
                                <i data-lucide="percent"></i>
                                ${pkg.rate_type_category || 'Unknown'} Rate • ${pkg.lock_period || 'No Lock-in'}
                            </div>
                        </div>
                        <div class="rate-info">
                            <div class="rate-label">Avg First 2 Years</div>
                            <div class="avg-rate">${formatPercentage(pkg.avgFirst2Years)}</div>
                            <div class="installment">${formatCurrency(pkg.monthlyInstallment)}/mo</div>
                        </div>
                    </div>

                    <div class="package-details">
                        <div class="detail-item">
                            <span class="detail-label">Property Type:</span>
                            <span class="detail-value">${pkg.property_type || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Property Status:</span>
                            <span class="detail-value">${pkg.property_status || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Buy Under:</span>
                            <span class="detail-value">${pkg.buy_under || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Min. Loan Size:</span>
                            <span class="detail-value">${formatCurrency(pkg.minimum_loan_size || 0)}</span>
                        </div>
                    </div>

                    ${rateSchedule ? `
                        <div class="rate-schedule">
                            <div class="rate-schedule-title">
                                <i data-lucide="trending-up"></i>
                                Interest Rate Schedule
                            </div>
                            <div class="rate-schedule-grid">
                                ${rateSchedule}
                            </div>
                        </div>
                    ` : ''}

                    ${pkg.remarks ? `
                        <div class="package-remarks">
                            <div class="remarks-title">
                                <i data-lucide="info"></i>
                                Important Notes
                            </div>
                            <div class="remarks-content">${pkg.remarks}</div>
                        </div>
                    ` : ''}

                    ${features ? `
                        <div class="package-features">
                            <div class="features-title">
                                <i data-lucide="award"></i>
                                Package Features
                            </div>
                            <div class="features-list">
                                ${features}
                            </div>
                        </div>
                    ` : ''}

                    <div class="package-remarks-editor">
                        <div class="remarks-editor-title">
                            <i data-lucide="edit"></i>
                            Client Remarks (Editable)
                        </div>
                        <textarea 
                            class="remarks-textarea" 
                            id="remarks-${pkg.id || index}" 
                            placeholder="Add custom remarks for this package..."
                            onchange="updatePackageRemarks(${index}, this.value)"
                        >${pkg.custom_remarks || pkg.remarks || ''}</textarea>
                    </div>
                </div>
            `;
        }

        function generateRateSchedule(pkg) {
            const rates = [];
            
            for (let year = 1; year <= 5; year++) {
                const rate = calculateInterestRate(pkg, year);
                if (rate > 0) {
                    rates.push(`
                        <div class="rate-item">
                            <div class="rate-period">Year ${year}</div>
                            <div class="rate-value">${formatPercentage(rate)}</div>
                        </div>
                    `);
                }
            }

            const thereafterRate = calculateInterestRate(pkg, 'thereafter');
            if (thereafterRate > 0) {
                rates.push(`
                    <div class="rate-item">
                        <div class="rate-period">Thereafter</div>
                        <div class="rate-value">${formatPercentage(thereafterRate)}</div>
                    </div>
                `);
            }

            return rates.length > 0 ? rates.join('') : null;
        }

        function generatePackageFeatures(pkg) {
            const features = [];
            
            if (pkg.legal_fee_subsidy === 'true' || pkg.legal_fee_subsidy === true) {
                features.push(`
                    <div class="feature-tag">
                        <i data-lucide="shield"></i>
                        Legal Fee Subsidy
                    </div>
                `);
            }
            
            if (pkg.cash_rebate === 'true' || pkg.cash_rebate === true) {
                features.push(`
                    <div class="feature-tag">
                        <i data-lucide="dollar-sign"></i>
                        Cash Rebate
                    </div>
                `);
            }
            
            if (pkg.free_package_conversion_12m === 'true' || pkg.free_package_conversion_12m === true) {
                features.push(`
                    <div class="feature-tag">
                        <i data-lucide="repeat"></i>
                        Free Conversion (12M)
                    </div>
                `);
            }

            if (pkg.free_package_conversion_24m === 'true' || pkg.free_package_conversion_24m === true) {
                features.push(`
                    <div class="feature-tag">
                        <i data-lucide="repeat"></i>
                        Free Conversion (24M)
                    </div>
                `);
            }

            return features.length > 0 ? features.join('') : null;
        }

        // ===================================
        // UTILITY FUNCTIONS - PRESERVED FROM ORIGINAL
        // ===================================
        function formatPercentage(value) {
            if (value == null || value === 0) return 'N/A';
            return `${value.toFixed(2)}%`;
        }

        function formatCurrency(value) {
            if (!value || value === 0) return '$0';
            return new Intl.NumberFormat('en-SG', {
                style: 'currency',
                currency: 'SGD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }

        // Clear all filters - PRESERVED FROM ORIGINAL
        function clearFilters() {
            document.getElementById('propertyType').value = '';
            document.getElementById('propertyStatus').value = '';
            document.getElementById('buyUnder').value = '';
            document.getElementById('loanAmount').value = '';
            document.getElementById('loanTenure').value = '';
            
            // Clear results
            document.getElementById('resultsContainer').style.display = 'none';
            currentResults = [];
            searchCriteria = {};
        }

        // Download packages list - PRESERVED FROM ORIGINAL
        // ===================================
        // PACKAGE REMARKS MANAGEMENT
        // ===================================
        function updatePackageRemarks(packageIndex, newRemarks) {
            if (currentResults[packageIndex]) {
                currentResults[packageIndex].custom_remarks = newRemarks;
                console.log(`📝 Updated remarks for package ${packageIndex}:`, newRemarks);
            }
        }

        // ===================================
        // REPORT GENERATION FUNCTIONS
        // ===================================
        function downloadPackagesList() {
            if (!currentResults.length) {
                showNotification('No results to download. Please search for packages first.', 'error');
                return;
            }

            generateProfessionalReport();
        }

        function generateProfessionalReport() {
            if (!currentResults.length) {
                showNotification('No results to generate report. Please search for packages first.', 'error');
                return;
            }

            const reportDate = new Date().toLocaleDateString('en-SG', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
            });

            // Take top 5 packages for the report
            const topPackages = currentResults.slice(0, 5);
            
            // Determine report title based on loan type
            let reportTitle = "TOP MORTGAGE PACKAGES";
            if (searchCriteria.loanType) {
                reportTitle = `TOP ${searchCriteria.loanType.toUpperCase()} PACKAGES`;
            }

            const reportContent = `
                <div style="padding: 40px; background: white; font-family: Arial, sans-serif;">
                    <!-- Header Section -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; border-bottom: 3px solid #1e40af; padding-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 20px;">
                            <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #dc2626, #1e40af); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                <div style="color: white; font-weight: bold; font-size: 24px; text-align: center; line-height: 1.2;">
                                    K<br>M
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 18px; font-weight: bold; color: #1f2937; margin-bottom: 4px;">KEYQUEST</div>
                                <div style="font-size: 14px; color: #6b7280;">M O R T G A G E</div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 32px; font-weight: bold; color: #1e40af; margin-bottom: 8px;">${reportTitle}</div>
                            <div style="font-size: 16px; color: #6b7280;">Professional Mortgage Report</div>
                            <div style="font-size: 14px; color: #9ca3af; margin-top: 4px;">Generated on ${reportDate}</div>
                        </div>
                    </div>

                    <!-- Search Criteria Summary -->
                    <div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 30px; border-left: 4px solid #1e40af;">
                        <h3 style="margin: 0 0 16px 0; color: #1f2937; font-size: 18px;">Search Criteria</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; font-size: 14px;">
                            <div><strong>Loan Type:</strong> ${searchCriteria.loanType || 'All'}</div>
                            <div><strong>Property Type:</strong> ${searchCriteria.propertyType || 'All'}</div>
                            <div><strong>Property Status:</strong> ${searchCriteria.propertyStatus || 'All'}</div>
                            <div><strong>Buy Under:</strong> ${searchCriteria.buyUnder || 'All'}</div>
                            <div><strong>Loan Amount:</strong> ${formatCurrency(searchCriteria.loanAmount || 0)}</div>
                            <div><strong>Loan Tenure:</strong> ${searchCriteria.loanTenure || 'N/A'} years</div>
                        </div>
                    </div>

                    <!-- Packages Comparison Table -->
                    <div style="margin-bottom: 40px;">
                        <h3 style="color: #1f2937; margin-bottom: 20px; font-size: 20px;">Interest Rate Comparison</h3>
                        <table style="width: 100%; border-collapse: collapse; border: 1px solid #e5e7eb; font-size: 12px;">
                            <thead>
                                <tr style="background: #f9fafb;">
                                    <th style="padding: 12px; text-align: left; border: 1px solid #e5e7eb; font-weight: bold;">Year</th>
                                    ${topPackages.map((pkg, index) => `
                                        <th style="padding: 12px; text-align: center; border: 1px solid #e5e7eb; font-weight: bold; background: ${index === 0 ? '#fef3c7' : '#f9fafb'};">
                                            ${pkg.bank_name}<br>
                                            <span style="font-size: 10px; color: #6b7280;">${pkg.rate_type_category} Rate</span>
                                        </th>
                                    `).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Year 1 Row -->
                                <tr style="background: #f8fafc;">
                                    <td style="padding: 12px; font-weight: bold; border: 1px solid #e5e7eb;">Year 1</td>
                                    ${topPackages.map((pkg, index) => `
                                        <td style="padding: 12px; text-align: center; border: 1px solid #e5e7eb; font-weight: bold; color: #059669; background: ${index === 0 ? '#fef3c7' : 'white'};">
                                            ${formatRateDisplay(pkg, 1)}
                                        </td>
                                    `).join('')}
                                </tr>

                                <!-- Year 2 Row -->
                                <tr style="background: white;">
                                    <td style="padding: 12px; font-weight: bold; border: 1px solid #e5e7eb;">Year 2</td>
                                    ${topPackages.map((pkg, index) => `
                                        <td style="padding: 12px; text-align: center; border: 1px solid #e5e7eb; font-weight: bold; color: #059669; background: ${index === 0 ? '#fef3c7' : 'white'};">
                                            ${formatRateDisplay(pkg, 2)}
                                        </td>
                                    `).join('')}
                                </tr>

                                <!-- Year 3 Row -->
                                <tr style="background: #f8fafc;">
                                    <td style="padding: 12px; font-weight: bold; border: 1px solid #e5e7eb;">Year 3</td>
                                    ${topPackages.map((pkg, index) => `
                                        <td style="padding: 12px; text-align: center; border: 1px solid #e5e7eb; background: ${index === 0 ? '#fef3c7' : '#f8fafc'};">
                                            ${formatRateDisplay(pkg, 3)}
                                        </td>
                                    `).join('')}
                                </tr>

                                <!-- Year 4 Row -->
                                <tr style="background: white;">
                                    <td style="padding: 12px; font-weight: bold; border: 1px solid #e5e7eb;">Year 4</td>
                                    ${topPackages.map((pkg, index) => `
                                        <td style="padding: 12px; text-align: center; border: 1px solid #e5e7eb; background: ${index === 0 ? '#fef3c7' : 'white'};">
                                            ${formatRateDisplay(pkg, 4)}
                                        </td>
                                    `).join('')}
                                </tr>

                                <!-- Year 5 Row -->
                                <tr style="background: #f8fafc;">
                                    <td style="padding: 12px; font-weight: bold; border: 1px solid #e5e7eb;">Year 5</td>
                                    ${topPackages.map((pkg, index) => `
                                        <td style="padding: 12px; text-align: center; border: 1px solid #e5e7eb; background: ${index === 0 ? '#fef3c7' : '#f8fafc'};">
                                            ${formatRateDisplay(pkg, 5)}
                                        </td>
                                    `).join('')}
                                </tr>

                                <!-- Thereafter Row -->
                                <tr style="background: white;">
                                    <td style="padding: 12px; font-weight: bold; border: 1px solid #e5e7eb;">Thereafter</td>
                                    ${topPackages.map((pkg, index) => `
                                        <td style="padding: 12px; text-align: center; border: 1px solid #e5e7eb; background: ${index === 0 ? '#fef3c7' : 'white'};">
                                            ${formatRateDisplay(pkg, 'thereafter')}
                                        </td>
                                    `).join('')}
                                </tr>

                                <!-- Average Rate Row -->
                                <tr style="background: #dcfce7; border: 2px solid #16a34a;">
                                    <td style="padding: 12px; font-weight: bold; border: 1px solid #16a34a; background: #16a34a; color: white;">Avg First 2 Years</td>
                                    ${topPackages.map((pkg, index) => `
                                        <td style="padding: 12px; text-align: center; border: 1px solid #16a34a; font-weight: bold; color: #16a34a; background: ${index === 0 ? '#bbf7d0' : '#dcfce7'};">
                                            ${formatPercentage(pkg.avgFirst2Years)}
                                        </td>
                                    `).join('')}
                                </tr>

                                <!-- Monthly Installment Row -->
                                <tr style="background: #ddd6fe;">
                                    <td style="padding: 12px; font-weight: bold; border: 1px solid #8b5cf6; background: #8b5cf6; color: white;">Monthly Installment</td>
                                    ${topPackages.map((pkg, index) => `
                                        <td style="padding: 12px; text-align: center; border: 1px solid #8b5cf6; font-weight: bold; color: #7c3aed; background: ${index === 0 ? '#c4b5fd' : '#ddd6fe'};">
                                            ${formatCurrency(pkg.monthlyInstallment)}
                                        </td>
                                    `).join('')}
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Package Details -->
                    <div style="margin-bottom: 40px;">
                        <h3 style="color: #1f2937; margin-bottom: 20px; font-size: 20px;">Package Details & Remarks</h3>
                        ${topPackages.map((pkg, index) => `
                            <div style="margin-bottom: 30px; padding: 20px; border: 1px solid #e5e7eb; border-radius: 12px; background: ${index === 0 ? '#fef3c7' : '#f9fafb'};">
                                <h4 style="margin: 0 0 16px 0; color: #1f2937; display: flex; align-items: center; gap: 12px;">
                                    <span style="background: #1e40af; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">${index + 1}</span>
                                    ${pkg.bank_name} - ${pkg.rate_type_category} Rate
                                </h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; font-size: 14px; margin-bottom: 16px;">
                                    <div><strong>Property Type:</strong> ${pkg.property_type}</div>
                                    <div><strong>Property Status:</strong> ${pkg.property_status}</div>
                                    <div><strong>Buy Under:</strong> ${pkg.buy_under}</div>
                                    <div><strong>Lock Period:</strong> ${pkg.lock_period || 'No Lock-in'}</div>
                                    <div><strong>Min. Loan Size:</strong> ${formatCurrency(pkg.minimum_loan_size || 0)}</div>
                                    <div><strong>Avg First 2 Years:</strong> <span style="color: #059669; font-weight: bold;">${formatPercentage(pkg.avgFirst2Years)}</span></div>
                                </div>
                                ${generatePackageFeatures(pkg) ? `
                                    <div style="margin-bottom: 16px;">
                                        <strong style="color: #1f2937;">Package Features:</strong><br>
                                        <div style="margin-top: 8px;">
                                            ${generatePackageFeaturesForReport(pkg)}
                                        </div>
                                    </div>
                                ` : ''}
                                ${(pkg.custom_remarks || pkg.remarks) ? `
                                    <div style="background: white; padding: 12px; border-radius: 8px; border-left: 4px solid #0ea5e9;">
                                        <strong style="color: #1f2937;">Remarks:</strong><br>
                                        <div style="margin-top: 8px; color: #4b5563; line-height: 1.5;">
                                            ${(pkg.custom_remarks || pkg.remarks).replace(/\n/g, '<br>')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>

                    <!-- Disclaimer -->
                    <div style="background: #fef2f2; padding: 20px; border-radius: 12px; border-left: 4px solid #ef4444; margin-bottom: 30px;">
                        <h4 style="margin: 0 0 12px 0; color: #dc2626; font-size: 16px;">Important Disclaimer</h4>
                        <p style="margin: 0; font-size: 12px; line-height: 1.6; color: #7f1d1d;">
                            All interest rates are subject to bank's final approval and may vary based on individual credit assessment. Terms and conditions apply. This report is for informational purposes only and does not constitute a binding offer. Please consult with our mortgage specialists for personalized advice.
                        </p>
                    </div>

                    <!-- Report Generation Info -->
                    <div style="text-align: center; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                        <p style="margin: 0; font-size: 12px; color: #6b7280;">
                            Report generated by Keyquest Mortgage on ${new Date().toLocaleString('en-SG')}
                        </p>
                    </div>
                </div>
            `;

            // Open modal with report content
            openReportModal(reportContent);
        }

        function openReportModal(content) {
            // Create modal if it doesn't exist
            let modal = document.getElementById('report-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'report-modal';
                modal.className = 'modal';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';
                modal.innerHTML = `
                    <div style="background: white; border-radius: 16px; width: 100%; max-width: 1200px; max-height: 90vh; display: flex; flex-direction: column;">
                        <div style="padding: 20px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="margin: 0; color: #1f2937;">Professional Mortgage Report</h3>
                            <div style="display: flex; gap: 12px;">
                                <button onclick="printReport()" style="padding: 8px 16px; background: #1e40af; color: white; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                                    <i data-lucide="printer" style="width: 16px; height: 16px;"></i>
                                    Print/Save PDF
                                </button>
                                <button onclick="closeReportModal()" style="padding: 8px 12px; background: #6b7280; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                    <i data-lucide="x" style="width: 16px; height: 16px;"></i>
                                </button>
                            </div>
                        </div>
                        <div id="report-content" style="flex: 1; overflow-y: auto;">
                            ${content}
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } else {
                document.getElementById('report-content').innerHTML = content;
            }

            modal.style.display = 'flex';
            
            // Re-initialize Lucide icons for the modal
            setTimeout(() => {
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }, 100);
        }

        function closeReportModal() {
            const modal = document.getElementById('report-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function printReport() {
            const originalTitle = document.title;
            document.title = `Keyquest_Mortgage_Report_${new Date().toISOString().split('T')[0]}`;
            
            const reportContent = document.getElementById('report-content').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${document.title}</title>
                    <style>
                        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
                        @media print {
                            body { margin: 0; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    ${reportContent}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
            
            document.title = originalTitle;
        }

        // Helper function to format rate display for the report
        function formatRateDisplay(pkg, year) {
            let rateType, operator, value;
            
            if (year === 'thereafter') {
                rateType = pkg.thereafter_rate_type;
                operator = pkg.thereafter_operator;
                value = pkg.thereafter_value;
            } else {
                rateType = pkg[`year${year}_rate_type`];
                operator = pkg[`year${year}_operator`];
                value = pkg[`year${year}_value`];
            }

            if (!rateType || value === null || value === undefined) return '-';

            if (rateType === 'FIXED') {
                const rate = calculateInterestRate(pkg, year);
                return `${formatPercentage(rate)} Fixed`;
            } else {
                const operatorSymbol = operator === '+' ? '+' : '-';
                return `${rateType} ${operatorSymbol} ${value}%`;
            }
        }

        function generatePackageFeaturesForReport(pkg) {
            const features = [];
            
            if (pkg.legal_fee_subsidy === 'true' || pkg.legal_fee_subsidy === true) {
                features.push('• Legal Fee Subsidy');
            }
            
            if (pkg.valuation_subsidy === 'true' || pkg.valuation_subsidy === true) {
                features.push('• Valuation Subsidy');
            }
            
            if (pkg.partial_repayment === 'true' || pkg.partial_repayment === true) {
                features.push('• Partial Repayment Allowed');
            }
            
            if (pkg.waiver_due_to_sales === 'true' || pkg.waiver_due_to_sales === true) {
                features.push('• Waiver Due to Sales');
            }

            if (pkg.free_package_conversion_12m === 'true' || pkg.free_package_conversion_12m === true) {
                features.push('• Free Package Conversion (12 Months)');
            }

            if (pkg.free_package_conversion_24m === 'true' || pkg.free_package_conversion_24m === true) {
                features.push('• Free Package Conversion (24 Months)');
            }

            if (pkg.free_package_conversion_36m === 'true' || pkg.free_package_conversion_36m === true) {
                features.push('• Free Package Conversion (36 Months)');
            }

            return features.length > 0 ? features.join('<br>') : 'No special features';
        }

        function exportCSV() {
            if (!currentResults.length) {
                showNotification('No results to export. Please search for packages first.', 'error');
                return;
            }

            const headers = [
                'Rank', 'Bank Name', 'Avg First 2 Years (%)', 'Monthly Installment', 'Property Type', 
                'Property Status', 'Buy Under', 'Rate Type', 'Lock Period', 'Min Loan Size', 'Custom Remarks'
            ];

            const csvContent = [
                headers.join(','),
                ...currentResults.map((pkg, index) => [
                    index + 1,
                    `"${pkg.bank_name}"`,
                    pkg.avgFirst2Years.toFixed(3),
                    pkg.monthlyInstallment.toFixed(2),
                    `"${pkg.property_type}"`,
                    `"${pkg.property_status}"`,
                    `"${pkg.buy_under}"`,
                    `"${pkg.rate_type_category}"`,
                    `"${pkg.lock_period || 'No Lock-in'}"`,
                    (pkg.minimum_loan_size || 0),
                    `"${(pkg.custom_remarks || pkg.remarks || '').replace(/"/g, '""')}"`
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const filename = `mortgage_recommendations_${new Date().toISOString().split('T')[0]}.csv`;
            
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showNotification('Data exported successfully', 'success');
        }

        // ===================================
        // SIGN OUT FUNCTIONS - PRESERVED FROM ORIGINAL  
        // ===================================
        function confirmSignOut() {
            if (confirm('Are you sure you want to sign out?')) {
                performSignOut();
            }
        }

        async function performSignOut() {
            try {
                showLoading('Signing out...');
                
                const { error } = await supabaseClient.auth.signOut();
                if (error) throw error;
                
                // Clear any stored data
                localStorage.clear();
                sessionStorage.clear();
                
                // Redirect to login
                window.location.href = 'login.html';
                
            } catch (error) {
                console.error('Sign out error:', error);
                showNotification('Sign out failed: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // ===================================
        // LOADING AND NOTIFICATION FUNCTIONS - PRESERVED FROM ORIGINAL
        // ===================================
        function showLoading(message = 'Loading...') {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingText = loadingOverlay.querySelector('span');
            if (loadingText) loadingText.textContent = message;
            loadingOverlay.style.display = 'flex';
        }

        function hideLoading() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }
        }

        function showNotification(message, type = 'info') {
            console.log(`[${type.toUpperCase()}] ${message}`);
            // You can implement a proper notification system here
        }

        // ===================================
        // MODAL FUNCTIONS
        // ===================================
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'flex';
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // ===================================
        // SIDEBAR FUNCTIONS - PRESERVED FROM ORIGINAL
        // ===================================
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            
            sidebar?.classList.toggle('open');
            overlay?.classList.toggle('active');
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            
            sidebar?.classList.remove('open');
            overlay?.classList.remove('active');
        }
    </script>
</body>
</html>
