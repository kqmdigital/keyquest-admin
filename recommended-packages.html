<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recommended Packages - Keyquest Mortgage Admin</title>
    <link rel="stylesheet" href="css/admin-styles.css">
    <!-- Required Scripts in correct order -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/lucide.min.js"></script>
    <script src="config/supabase.js"></script>
    <script src="js/admin-scripts.js"></script>
    <style>
        /* Enhanced styles for recommended packages */
        .page-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 32px 24px;
            border-radius: 16px;
            margin-bottom: 32px;
            box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
        }

        .page-header h1 {
            margin: 0 0 8px 0;
            font-size: 28px;
            font-weight: 700;
        }

        .page-header p {
            margin: 0;
            opacity: 0.9;
            font-size: 16px;
        }

        .loan-type-tabs {
            display: flex;
            background: white;
            border-radius: 16px;
            padding: 6px;
            margin-bottom: 32px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .loan-tab {
            flex: 1;
            padding: 16px 20px;
            text-align: center;
            border-radius: 12px;
            border: none;
            background: transparent;
            color: #64748b;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 14px;
        }

        .loan-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
            transform: translateY(-2px);
        }

        .loan-tab:hover:not(.active) {
            background: #f8fafc;
            color: #475569;
            transform: translateY(-1px);
        }

        .search-section {
            background: white;
            border-radius: 20px;
            padding: 32px;
            margin-bottom: 32px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        }

        .search-section h3 {
            margin: 0 0 24px 0;
            font-size: 20px;
            font-weight: 700;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .search-actions {
            display: flex;
            gap: 16px;
            justify-content: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 160px;
            justify-content: center;
            font-size: 15px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 14px 30px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 160px;
            justify-content: center;
            font-size: 15px;
        }

        .btn-secondary:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .results-container {
            background: white;
            border-radius: 20px;
            border: 1px solid #e2e8f0;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        }

        .results-header {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 24px 32px;
            border-bottom: 2px solid #e2e8f0;
        }

        .results-title {
            margin: 0 0 8px 0;
            font-size: 22px;
            font-weight: 700;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .results-subtitle {
            margin: 0;
            font-size: 14px;
            color: #6b7280;
        }

        .results-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .package-card {
            border-bottom: 2px solid #f8fafc;
            padding: 32px;
            transition: all 0.3s ease;
            position: relative;
        }

        .package-card:last-child {
            border-bottom: none;
        }

        .package-card:hover {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .package-rank {
            position: absolute;
            top: 24px;
            left: 24px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .package-rank.rank-1 {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4);
        }

        .package-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin: 0 0 24px 60px;
        }

        .bank-info {
            flex: 1;
        }

        .bank-name {
            font-size: 24px;
            font-weight: 800;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .package-type {
            font-size: 16px;
            color: #6b7280;
            font-weight: 500;
        }

        .rate-info {
            text-align: right;
        }

        .avg-rate {
            font-size: 28px;
            font-weight: 800;
            color: #059669;
            margin-bottom: 4px;
        }

        .rate-label {
            font-size: 12px;
            color: #6b7280;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .installment {
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
            margin-top: 8px;
        }

        .package-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            margin: 24px 0;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 16px;
            background: #f9fafb;
            border-radius: 10px;
            font-size: 14px;
            border: 1px solid #f1f5f9;
        }

        .detail-label {
            font-weight: 600;
            color: #6b7280;
        }

        .detail-value {
            font-weight: 700;
            color: #1f2937;
        }

        .rate-schedule {
            background: linear-gradient(135deg, #ecfdf5 0%, #f0fdf4 100%);
            border: 2px solid #bbf7d0;
            border-radius: 16px;
            padding: 24px;
            margin: 24px 0;
        }

        .rate-schedule-title {
            font-weight: 700;
            color: #065f46;
            margin-bottom: 16px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .rate-schedule-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }

        .rate-item {
            background: white;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid #d1fae5;
            transition: all 0.3s ease;
        }

        .rate-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
        }

        .rate-period {
            font-size: 12px;
            color: #6b7280;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .rate-value {
            font-size: 18px;
            font-weight: 800;
            color: #059669;
        }

        .package-remarks {
            background: #fef3c7;
            border: 2px solid #fcd34d;
            border-radius: 12px;
            padding: 16px;
            margin: 20px 0;
        }

        .remarks-title {
            font-weight: 700;
            color: #92400e;
            margin-bottom: 8px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .remarks-content {
            color: #92400e;
            font-size: 14px;
            line-height: 1.5;
        }

        .package-features {
            margin: 24px 0;
        }

        .features-title {
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 12px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .feature-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .feature-tag {
            background: #dbeafe;
            color: #1e40af;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            border: 1px solid #bfdbfe;
        }

        .feature-tag.positive {
            background: #dcfce7;
            color: #166534;
            border-color: #bbf7d0;
        }

        .package-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            justify-content: flex-end;
        }

        .btn-enquire {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-enquire:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .no-results {
            text-align: center;
            padding: 80px 32px;
            color: #6b7280;
        }

        .no-results-icon {
            font-size: 64px;
            margin-bottom: 24px;
            opacity: 0.5;
        }

        .no-results h3 {
            font-size: 24px;
            margin: 0 0 12px 0;
            color: #1f2937;
        }

        .no-results p {
            font-size: 16px;
            margin: 0;
        }

        .input-group {
            position: relative;
        }

        .input-prefix {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
            font-weight: 600;
            z-index: 1;
        }

        .input-group .form-input {
            padding-left: 48px;
        }

        @media print {
            .modal-header, .modal-footer {
                display: none !important;
            }
            
            #professional-report-modal .modal-content {
                box-shadow: none !important;
                border: none !important;
                max-width: none !important;
                width: 100% !important;
                max-height: none !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            #professional-report-modal .modal-body {
                max-height: none !important;
                overflow: visible !important;
                padding: 0 !important;
            }
            
            #professionalReportContent {
                page-break-inside: avoid;
            }
            
            #professionalReportContent table {
                page-break-inside: avoid;
                break-inside: avoid;
            }
        }
            .loan-type-tabs {
                flex-direction: column;
                gap: 8px;
            }

            .package-header {
                flex-direction: column;
                gap: 16px;
                margin-left: 0;
            }

            .package-rank {
                position: static;
                margin-bottom: 16px;
                align-self: flex-start;
            }

            .rate-info {
                text-align: left;
            }

            .package-actions {
                justify-content: stretch;
            }

            .btn-enquire {
                flex: 1;
                justify-content: center;
            }

            .package-details {
                grid-template-columns: 1fr;
            }

            .search-actions {
                flex-direction: column;
            }

            .btn-primary, .btn-secondary {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="overlay" id="overlay" onclick="closeSidebar()"></div>
    
    <div class="admin-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="index.html" class="logo">
                    <div class="logo-icon">
                        <i data-lucide="building-2"></i>
                    </div>
                    <span>KEYQUEST</span>
                </a>
            </div>
            <nav class="nav-menu">
                <a href="index.html" class="nav-item">
                    <i data-lucide="layout-dashboard"></i>
                    <span>Dashboard</span>
                </a>
                <a href="rate-packages.html" class="nav-item">
                    <i data-lucide="package"></i>
                    <span>Rate Package</span>
                </a>
                <a href="rate-types.html" class="nav-item">
                    <i data-lucide="percent"></i>
                    <span>Rate Type</span>
                </a>
                <a href="banks.html" class="nav-item">
                    <i data-lucide="landmark"></i>
                    <span>Bank</span>
                </a>
                <a href="bankers.html" class="nav-item">
                    <i data-lucide="briefcase"></i>
                    <span>Bankers</span>
                </a>
                <a href="agents.html" class="nav-item">
                    <i data-lucide="users"></i>
                    <span>Agents</span>
                </a>
                <a href="enquiry.html" class="nav-item">
                    <i data-lucide="help-circle"></i>
                    <span>Enquiry</span>
                </a>
                <a href="recommended-packages.html" class="nav-item active">
                    <i data-lucide="award"></i>
                    <span>Recommended Packages</span>
                </a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <header class="header">
                <div class="header-left">
                    <button class="menu-toggle" onclick="toggleSidebar()">
                        <i data-lucide="menu"></i>
                    </button>
                    <h1 class="header-title">
                        <i data-lucide="award"></i>
                        Recommended Packages
                    </h1>
                </div>
                <div class="header-right">
                    <div class="user-info" onclick="toggleUserDropdown()">
                        <div class="user-avatar" id="userAvatar">A</div>
                        <span class="user-name" id="userName">Admin</span>
                        <i data-lucide="chevron-down"></i>
                    </div>
                    <div class="user-dropdown" id="userDropdown">
                        <a href="#" onclick="confirmSignOut()">
                            <i data-lucide="log-out"></i>
                            Sign Out
                        </a>
                    </div>
                </div>
            </header>

            <div class="content">
                <!-- Page Header -->
                <div class="page-header">
                    <h1>Find Your Best Mortgage Rate</h1>
                    <p>Get personalized mortgage package recommendations ranked by average first 2 years interest rates</p>
                    <div style="margin-top: 16px; font-size: 14px; opacity: 0.8;">
                        💡 If the page seems stuck loading, click the "Clear Loading" or "Refresh Data" buttons below
                    </div>
                </div>

                <!-- Loan Type Tabs -->
                <div class="loan-type-tabs">
                    <button class="loan-tab active" onclick="selectLoanType('New Home Loan')" data-loan-type="New Home Loan">
                        <i data-lucide="home"></i>
                        New Home Loan
                    </button>
                    <button class="loan-tab" onclick="selectLoanType('Refinancing Home Loan')" data-loan-type="Refinancing Home Loan">
                        <i data-lucide="repeat"></i>
                        Refinancing Home Loan
                    </button>
                    <button class="loan-tab" onclick="selectLoanType('Commercial/Industrial')" data-loan-type="Commercial/Industrial">
                        <i data-lucide="briefcase"></i>
                        Commercial/Industrial
                    </button>
                </div>

                <!-- Search Section -->
                <div class="search-section">
                    <h3>
                        <i data-lucide="search"></i>
                        Search Criteria
                    </h3>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Property Type</label>
                            <select class="form-select" id="propertyType">
                                <option value="">Select Property Type</option>
                                <option value="HDB">HDB</option>
                                <option value="Private Property">Private Property</option>
                                <option value="EC">EC</option>
                                <option value="Commercial">Commercial</option>
                                <option value="Industrial">Industrial</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Property Status</label>
                            <select class="form-select" id="propertyStatus">
                                <option value="">Select Property Status</option>
                                <option value="Completed">Completed</option>
                                <option value="Under Construction">Under Construction</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Buy Under</label>
                            <select class="form-select" id="buyUnder">
                                <option value="">Select Buy Under</option>
                                <option value="Individual Name">Individual Name</option>
                                <option value="Company Operating">Company Operating</option>
                                <option value="Company Investment Holding">Company Investment Holding</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Loan Amount</label>
                            <div class="input-group">
                                <span class="input-prefix">S$</span>
                                <input type="number" class="form-input" id="loanAmount" placeholder="500,000" min="0" step="1000">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Loan Tenure (Years)</label>
                            <select class="form-select" id="loanTenure">
                                <option value="">Select Tenure</option>
                                <option value="5">5 years</option>
                                <option value="10">10 years</option>
                                <option value="15">15 years</option>
                                <option value="20">20 years</option>
                                <option value="25">25 years</option>
                                <option value="30">30 years</option>
                                <option value="35">35 years</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Preferred Rate Type</label>
                            <select class="form-select" id="rateType">
                                <option value="">Any Rate Type</option>
                                <option value="Fixed">Fixed</option>
                                <option value="Floating">Floating</option>
                            </select>
                        </div>
                    </div>

                    <div class="search-actions">
                        <button class="btn-primary" onclick="searchPackages()">
                            <i data-lucide="search"></i>
                            Find Best Rates
                        </button>
                        <button class="btn-secondary" onclick="clearFilters()">
                            <i data-lucide="rotate-ccw"></i>
                            Clear Filters
                        </button>
                        <button class="btn-secondary" onclick="refreshData()" title="Refresh data if loading is stuck">
                            <i data-lucide="refresh-cw"></i>
                            Refresh Data
                        </button>
                    </div>
                </div>

                <!-- Results Container -->
                <div class="results-container" id="resultsContainer" style="display: none;">
                    <div class="results-header">
                        <h2 class="results-title">
                            <i data-lucide="arrow-down"></i>
                            Recommended Packages
                        </h2>
                        <p class="results-subtitle" id="resultsSubtitle">Ranked by average first 2 years interest rates</p>
                        <div class="results-actions">
                            <button class="btn-primary" onclick="generateProfessionalReport()">
                                <i data-lucide="file-text"></i>
                                Generate PDF Report
                            </button>
                            <button class="btn-secondary" onclick="exportResults()">
                                <i data-lucide="download"></i>
                                Export CSV
                            </button>
                            <button class="btn-secondary" onclick="forceHideLoading()" title="Click if page seems stuck loading">
                                <i data-lucide="x-circle"></i>
                                Clear Loading
                            </button>
                        </div>
                    </div>
                    <div id="resultsContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Professional PDF Report Modal -->
    <div class="modal" id="professional-report-modal" style="z-index: 10000;">
        <div class="modal-dialog" style="max-width: 95vw; width: 1200px; max-height: 95vh;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Professional Mortgage Report</h3>
                    <button class="modal-close" onclick="closeModal('professional-report-modal')">
                        <i data-lucide="x"></i>
                    </button>
                </div>
                <div class="modal-body" style="max-height: 75vh; overflow-y: auto; padding: 0;">
                    <div id="professionalReportContent" style="background: white; font-family: Arial, sans-serif;">
                        <!-- Professional report content will be generated here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeModal('professional-report-modal')">Close</button>
                    <button class="btn-primary" onclick="printProfessionalReport()">
                        <i data-lucide="printer"></i>
                        Print / Save PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Sign Out Modal -->
    <div class="modal" id="signout-modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Confirm Sign Out</h3>
                    <button class="modal-close" onclick="closeModal('signout-modal')">
                        <i data-lucide="x"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to sign out?</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal('signout-modal')">Cancel</button>
                    <button class="btn btn-danger" onclick="performSignOut()">Sign Out</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay - Removed since admin-scripts.js provides this -->

    <script>
        // Global variables
        let currentLoanType = 'New Home Loan';
        let allPackages = [];
        let rateTypes = [];
        let currentResults = [];
        let searchCriteria = {};

        // Initialize page using the same pattern as other admin pages
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Initializing Recommended Packages page...');
            console.log('📍 Current URL:', window.location.href);
            console.log('🔧 Available scripts:', {
                supabase: typeof supabaseClient !== 'undefined',
                lucide: typeof lucide !== 'undefined',
                adminScripts: typeof showLoading !== 'undefined'
            });
            
            // Helpful message for debugging
            console.log('💡 If the page seems stuck loading, check the browser console for errors or click "Refresh Data" button');
            
            // Check if Supabase is available
            if (typeof supabaseClient === 'undefined') {
                console.error('❌ Supabase client not available. Check script loading order.');
                showNotification('Supabase connection failed. Please refresh the page.', 'error');
                return;
            }
            
            console.log('✅ Supabase client loaded successfully');
            console.log('🌐 Supabase URL:', supabaseClient.supabaseUrl);
            
            // Initialize using the same pattern as other pages
            checkAuthentication();
            
            // Add a timeout for data loading to prevent infinite loading
            const loadingTimeout = setTimeout(() => {
                console.warn('⏰ Data loading timeout - taking too long');
                forceHideLoading();
                showNotification('Loading is taking longer than expected. Try clicking "Refresh Data" or "Clear Loading" if page seems stuck.', 'warning');
            }, 15000); // 15 second timeout (reduced from 30)
            
            loadData().finally(() => {
                clearTimeout(loadingTimeout);
                // Force hide loading to ensure it's cleared
                setTimeout(forceHideLoading, 500);
                setupEventListeners();
            });
            
            // Ultimate fallback: force hide loading after 10 seconds regardless
            setTimeout(() => {
                const loadingElements = document.querySelectorAll('.loading-overlay, #loading-overlay, #global-loader');
                if (loadingElements.length > 0) {
                    console.log('🕐 10-second fallback - force hiding any remaining loading');
                    forceHideLoading();
                }
            }, 10000);
        });

        // ===================================
        // AUTHENTICATION - SAME AS OTHER PAGES
        // ===================================
        async function checkAuthentication() {
            try {
                console.log('🔐 Checking authentication...');
                const { data: { user }, error } = await supabaseClient.auth.getUser();
                
                if (error) {
                    console.error('❌ Auth error:', error);
                    window.location.href = 'login.html';
                    return;
                }
                
                if (!user) {
                    console.log('👤 No user found, redirecting to login');
                    window.location.href = 'login.html';
                    return;
                }
                
                console.log('✅ User authenticated:', user.email);
                
                // Update user info in header
                const userName = document.getElementById('userName');
                const userAvatar = document.getElementById('userAvatar');
                
                if (userName && user.email) {
                    userName.textContent = user.email.split('@')[0];
                }
                if (userAvatar && user.email) {
                    userAvatar.textContent = user.email.charAt(0).toUpperCase();
                }
            } catch (error) {
                console.error('💥 Auth check failed:', error);
                window.location.href = 'login.html';
            }
        }

        // ===================================
        // SIGN OUT FUNCTIONS - SAME AS OTHER PAGES
        // ===================================
        function confirmSignOut() {
            document.getElementById('signout-modal').style.display = 'flex';
        }

        async function performSignOut() {
            try {
                showLoading('Signing out...');
                
                const { error } = await supabaseClient.auth.signOut();
                if (error) throw error;
                
                // Clear any stored data
                localStorage.clear();
                sessionStorage.clear();
                
                // Redirect to login
                window.location.href = 'login.html';
                
            } catch (error) {
                console.error('Sign out error:', error);
                showNotification('Sign out failed: ' + error.message, 'error');
            } finally {
                hideLoading();
                closeModal('signout-modal');
            }
        }

        // ===================================
        // DATA LOADING - FOLLOWS SAME PATTERN
        // ===================================
        async function loadData() {
            console.log('🔄 Starting data load...');
            
            try {
                showLoading('Loading rate types...');
                
                // Load rate types first
                console.log('📊 Loading rate types...');
                await loadRateTypes();
                console.log(`✅ Loaded ${rateTypes.length} rate types`);
                
                showLoading('Loading packages...');
                
                // Load packages
                console.log('📦 Loading packages...');
                await loadPackages();
                console.log(`✅ Loaded ${allPackages.length} packages`);
                
                // Force hide any loading overlays
                hideLoading();
                
                // Also remove any loading overlays that might be stuck
                const loadingOverlays = document.querySelectorAll('.loading-overlay, #loading-overlay, #global-loader');
                loadingOverlays.forEach(overlay => {
                    if (overlay && overlay.parentNode) {
                        overlay.remove();
                    }
                });
                
                showNotification(`Data loaded successfully: ${rateTypes.length} rate types, ${allPackages.length} packages`, 'success');
                
            } catch (error) {
                console.error('❌ Error loading data:', error);
                showNotification('Error loading data: ' + error.message, 'error');
            } finally {
                // Force hide loading to ensure it's properly cleared
                hideLoading();
                forceHideLoading();
                console.log('🏁 Data loading completed');
            }
        }

        // Load rate types for calculations
        async function loadRateTypes() {
            try {
                console.log('🔍 Querying rate_types table...');
                const { data, error } = await supabaseClient
                    .from('rate_types')
                    .select('rate_type, rate_value')
                    .order('rate_type');

                if (error) {
                    console.error('❌ Supabase error loading rate types:', error);
                    throw error;
                }
                
                rateTypes = data || [];
                console.log(`✅ Successfully loaded ${rateTypes.length} rate types:`, rateTypes.slice(0, 3));
                
                if (rateTypes.length === 0) {
                    console.warn('⚠️ No rate types found in database');
                }
                
            } catch (error) {
                console.error('❌ Error in loadRateTypes:', error);
                throw new Error(`Failed to load rate types: ${error.message}`);
            }
        }

        // Load all packages
        async function loadPackages() {
            try {
                console.log('🔍 Querying rate_packages table...');
                const { data, error } = await supabaseClient
                    .from('rate_packages')
                    .select('*')
                    .order('bank_name');

                if (error) {
                    console.error('❌ Supabase error loading packages:', error);
                    throw error;
                }

                allPackages = data || [];
                console.log(`✅ Successfully loaded ${allPackages.length} packages`);
                
                if (allPackages.length === 0) {
                    console.warn('⚠️ No packages found in database');
                } else {
                    console.log('📦 Sample package:', allPackages[0]);
                }
                
            } catch (error) {
                console.error('❌ Error in loadPackages:', error);
                throw new Error(`Failed to load packages: ${error.message}`);
            }
        }

        // ===================================
        // EVENT LISTENERS SETUP
        // ===================================
        function setupEventListeners() {
            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

            // Close dropdowns when clicking outside
            document.addEventListener('click', function(event) {
                const userDropdown = document.getElementById('userDropdown');
                const userInfo = document.querySelector('.user-info');
                
                if (userInfo && !userInfo.contains(event.target)) {
                    userDropdown?.classList.remove('show');
                }
            });
            
            // Global fallback: if user clicks 3 times anywhere, force hide loading
            let clickCount = 0;
            document.addEventListener('click', function() {
                clickCount++;
                if (clickCount === 3) {
                    const loadingElements = document.querySelectorAll('.loading-overlay, #loading-overlay, #global-loader');
                    if (loadingElements.length > 0) {
                        console.log('🔧 Triple-click detected - force hiding loading');
                        forceHideLoading();
                        showNotification('Loading state cleared by triple-click', 'info');
                    }
                    clickCount = 0;
                }
                // Reset counter after 2 seconds
                setTimeout(() => { clickCount = 0; }, 2000);
            });
        }

        // ===================================
        // LOAN TYPE SELECTION
        // ===================================
        function selectLoanType(loanType) {
            currentLoanType = loanType;
            
            // Update tab states
            document.querySelectorAll('.loan-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.loanType === loanType) {
                    tab.classList.add('active');
                }
            });
            
            // Clear previous results
            document.getElementById('resultsContainer').style.display = 'none';
        }

        // ===================================
        // CALCULATION FUNCTIONS
        // ===================================
        
        // Calculate interest rate for a specific year
        function calculateInterestRate(pkg, year) {
            if (!pkg || !rateTypes.length) return 0;

            let rateType, operator, value;
            
            if (year === 'thereafter') {
                rateType = pkg.thereafter_rate_type;
                operator = pkg.thereafter_operator;
                value = pkg.thereafter_value;
            } else {
                rateType = pkg[`year${year}_rate_type`];
                operator = pkg[`year${year}_operator`];
                value = pkg[`year${year}_value`];
            }

            if (!rateType || !value) return 0;

            // Find the base rate
            const rateTypeData = rateTypes.find(rt => rt.rate_type === rateType);
            const baseRate = rateTypeData ? parseFloat(rateTypeData.rate_value) : 0;
            
            const adjustment = parseFloat(value) || 0;
            const multiplier = operator === '-' ? -1 : 1;
            
            return baseRate + (adjustment * multiplier);
        }

        // Calculate average of first 2 years interest rates
        function calculateAverageFirst2Years(pkg) {
            const year1Rate = calculateInterestRate(pkg, 1);
            const year2Rate = calculateInterestRate(pkg, 2);
            
            if (year1Rate === 0 && year2Rate === 0) return 0;
            if (year1Rate === 0) return year2Rate;
            if (year2Rate === 0) return year1Rate;
            
            return (year1Rate + year2Rate) / 2;
        }

        // Calculate monthly installment
        function calculateMonthlyInstallment(principal, annualRate, years) {
            if (!principal || !annualRate || !years) return 0;
            
            const monthlyRate = annualRate / 100 / 12;
            const numPayments = years * 12;
            
            if (monthlyRate === 0) return principal / numPayments;
            
            const monthlyPayment = principal * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / 
                                  (Math.pow(1 + monthlyRate, numPayments) - 1);
            
            return monthlyPayment;
        }

        // ===================================
        // UTILITY FUNCTIONS
        // ===================================
        
        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-SG', {
                style: 'currency',
                currency: 'SGD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        // Format percentage
        function formatPercentage(rate) {
            return `${rate.toFixed(3)}%`;
        }

        // Clear all filters
        function clearFilters() {
            document.getElementById('propertyType').value = '';
            document.getElementById('propertyStatus').value = '';
            document.getElementById('buyUnder').value = '';
            document.getElementById('loanAmount').value = '';
            document.getElementById('loanTenure').value = '';
            document.getElementById('rateType').value = '';
            
            // Clear results
            document.getElementById('resultsContainer').style.display = 'none';
            currentResults = [];
            searchCriteria = {};
        }

        // ===================================
        // SEARCH FUNCTIONALITY
        // ===================================
        
        async function searchPackages() {
            try {
                // Get form values
                const propertyType = document.getElementById('propertyType').value;
                const propertyStatus = document.getElementById('propertyStatus').value;
                const buyUnder = document.getElementById('buyUnder').value;
                const loanAmount = parseFloat(document.getElementById('loanAmount').value);
                const loanTenure = parseInt(document.getElementById('loanTenure').value);
                const rateType = document.getElementById('rateType').value;

                // Store search criteria
                searchCriteria = {
                    loanType: currentLoanType,
                    propertyType,
                    propertyStatus,
                    buyUnder,
                    loanAmount,
                    loanTenure,
                    rateType
                };

                // Validation
                if (!loanAmount || loanAmount <= 0) {
                    showNotification('Please enter a valid loan amount', 'error');
                    return;
                }

                if (!loanTenure) {
                    showNotification('Please select loan tenure', 'error');
                    return;
                }

                showLoading('Searching for best rates...');

                // Filter packages based on criteria
                let filteredPackages = allPackages.filter(pkg => {
                    // Must match loan type
                    if (pkg.loan_type !== currentLoanType) return false;
                    
                    // Filter by property type if specified
                    if (propertyType && pkg.property_type !== propertyType) return false;
                    
                    // Filter by property status if specified
                    if (propertyStatus && pkg.property_status !== propertyStatus) return false;
                    
                    // Filter by buy under if specified
                    if (buyUnder && pkg.buy_under !== buyUnder) return false;
                    
                    // Filter by rate type if specified
                    if (rateType && pkg.rate_type_category !== rateType) return false;
                    
                    // Check minimum loan size
                    if (pkg.minimum_loan_size && loanAmount < parseFloat(pkg.minimum_loan_size)) return false;
                    
                    return true;
                });

                // Calculate rates and sort by average first 2 years
                const packagesWithRates = filteredPackages.map(pkg => {
                    const avgFirst2Years = calculateAverageFirst2Years(pkg);
                    const year1Rate = calculateInterestRate(pkg, 1);
                    const monthlyInstallment = calculateMonthlyInstallment(loanAmount, avgFirst2Years, loanTenure);
                    
                    return {
                        ...pkg,
                        avgFirst2Years,
                        year1Rate,
                        year2Rate: calculateInterestRate(pkg, 2),
                        monthlyInstallment
                    };
                }).filter(pkg => pkg.avgFirst2Years > 0) // Only include packages with valid rates
                  .sort((a, b) => a.avgFirst2Years - b.avgFirst2Years); // Sort by lowest average rate first

                currentResults = packagesWithRates;
                displayResults(packagesWithRates, loanAmount, loanTenure);
                
            } catch (error) {
                console.error('Error searching packages:', error);
                showNotification('Error searching packages: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // ===================================
        // DISPLAY RESULTS
        // ===================================
        
        function displayResults(packages, loanAmount, loanTenure) {
            const resultsContainer = document.getElementById('resultsContainer');
            const resultsContent = document.getElementById('resultsContent');
            const resultsSubtitle = document.getElementById('resultsSubtitle');

            if (packages.length === 0) {
                resultsContent.innerHTML = `
                    <div class="no-results">
                        <div class="no-results-icon">🔍</div>
                        <h3>No packages found</h3>
                        <p>No mortgage packages match your criteria. Try adjusting your search parameters.</p>
                    </div>
                `;
            } else {
                resultsSubtitle.textContent = `We found ${packages.length} package(s) for ${formatCurrency(loanAmount)} over ${loanTenure} years`;
                
                resultsContent.innerHTML = packages.map((pkg, index) => {
                    const rateSchedule = generateRateSchedule(pkg);
                    const features = generatePackageFeatures(pkg);
                    
                    return `
                        <div class="package-card">
                            <div class="package-rank ${index === 0 ? 'rank-1' : ''}">${index + 1}</div>
                            
                            <div class="package-header">
                                <div class="bank-info">
                                    <div class="bank-name">${pkg.bank_name}</div>
                                    <div class="package-type">${pkg.rate_type_category} Rate • ${pkg.lock_period || 'No Lock-in'}</div>
                                </div>
                                <div class="rate-info">
                                    <div class="avg-rate">${formatPercentage(pkg.avgFirst2Years)}</div>
                                    <div class="rate-label">Avg First 2 Years</div>
                                    <div class="installment">${formatCurrency(pkg.monthlyInstallment)}/mo</div>
                                </div>
                            </div>

                            <div class="package-details">
                                <div class="detail-item">
                                    <span class="detail-label">Property Type:</span>
                                    <span class="detail-value">${pkg.property_type}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Property Status:</span>
                                    <span class="detail-value">${pkg.property_status}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Buy Under:</span>
                                    <span class="detail-value">${pkg.buy_under}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Min. Loan Size:</span>
                                    <span class="detail-value">${formatCurrency(pkg.minimum_loan_size || 0)}</span>
                                </div>
                            </div>

                            ${rateSchedule ? `
                                <div class="rate-schedule">
                                    <div class="rate-schedule-title">
                                        <i data-lucide="trending-up"></i>
                                        Interest Rate Schedule
                                    </div>
                                    <div class="rate-schedule-grid">
                                        ${rateSchedule}
                                    </div>
                                </div>
                            ` : ''}

                            ${pkg.remarks ? `
                                <div class="package-remarks">
                                    <div class="remarks-title">
                                        <i data-lucide="info"></i>
                                        Important Notes
                                    </div>
                                    <div class="remarks-content">${pkg.remarks}</div>
                                </div>
                            ` : ''}

                            ${features ? `
                                <div class="package-features">
                                    <div class="features-title">
                                        <i data-lucide="check-circle"></i>
                                        Package Features
                                    </div>
                                    <div class="feature-tags">
                                        ${features}
                                    </div>
                                </div>
                            ` : ''}

                            <div class="package-actions">
                                <button class="btn-enquire" onclick="enquirePackage('${pkg.id}')">
                                    <i data-lucide="mail"></i>
                                    Enquire Now
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            resultsContainer.style.display = 'block';
            resultsContainer.scrollIntoView({ behavior: 'smooth' });
            
            // Re-initialize Lucide icons for new content
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        // Generate rate schedule
        function generateRateSchedule(pkg) {
            const rates = [];
            
            for (let year = 1; year <= 5; year++) {
                const rate = calculateInterestRate(pkg, year);
                if (rate > 0) {
                    rates.push(`
                        <div class="rate-item">
                            <div class="rate-period">Year ${year}</div>
                            <div class="rate-value">${formatPercentage(rate)}</div>
                        </div>
                    `);
                }
            }

            const thereafterRate = calculateInterestRate(pkg, 'thereafter');
            if (thereafterRate > 0) {
                rates.push(`
                    <div class="rate-item">
                        <div class="rate-period">Thereafter</div>
                        <div class="rate-value">${formatPercentage(thereafterRate)}</div>
                    </div>
                `);
            }

            return rates.join('');
        }

        // Generate package features
        function generatePackageFeatures(pkg) {
            const features = [];
            
            if (pkg.legal_fee_subsidy === 'true' || pkg.legal_fee_subsidy === true) {
                features.push('<span class="feature-tag positive">Legal Fee Subsidy</span>');
            }
            
            if (pkg.valuation_subsidy === 'true' || pkg.valuation_subsidy === true) {
                features.push('<span class="feature-tag positive">Valuation Subsidy</span>');
            }
            
            if (pkg.partial_repayment === 'true' || pkg.partial_repayment === true) {
                features.push('<span class="feature-tag">Partial Repayment</span>');
            }
            
            if (pkg.waiver_due_to_sales === 'true' || pkg.waiver_due_to_sales === true) {
                features.push('<span class="feature-tag">Waiver Due to Sales</span>');
            }

            if (pkg.free_package_conversion_12m === 'true' || pkg.free_package_conversion_12m === true) {
                features.push('<span class="feature-tag">Free Package Conversion (12M)</span>');
            }

            if (pkg.free_package_conversion_24m === 'true' || pkg.free_package_conversion_24m === true) {
                features.push('<span class="feature-tag">Free Package Conversion (24M)</span>');
            }

            if (pkg.free_package_conversion_36m === 'true' || pkg.free_package_conversion_36m === true) {
                features.push('<span class="feature-tag">Free Package Conversion (36M)</span>');
            }

            return features.join('');
        }

        // ===================================
        // PROFESSIONAL PDF REPORT GENERATION
        // ===================================
        
        function generateProfessionalReport() {
            if (!currentResults.length) {
                showNotification('No results to generate report. Please search for packages first.', 'error');
                return;
            }

            const reportContent = document.getElementById('professionalReportContent');
            const reportDate = new Date().toLocaleDateString('en-SG', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
            });

            // Take top 3 packages for the report
            const topPackages = currentResults.slice(0, 3);
            
            // Determine report title based on loan type and rate type
            let reportTitle = "TOP";
            if (searchCriteria.rateType === 'Fixed') {
                reportTitle += " Fixed";
            } else if (searchCriteria.rateType === 'Floating') {
                reportTitle += " Floating";
            }
            reportTitle += " PACKAGES";

            reportContent.innerHTML = `
                <div style="padding: 40px; background: white;">
                    <!-- Header Section -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; border-bottom: 3px solid #1e40af; padding-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 20px;">
                            <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #dc2626, #1e40af); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                <div style="color: white; font-weight: bold; font-size: 24px; text-align: center; line-height: 1.2;">
                                    K<br>M
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 18px; font-weight: bold; color: #1f2937; margin-bottom: 4px;">KEYQUEST</div>
                                <div style="font-size: 14px; color: #6b7280;">M O R T G A G E</div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 32px; font-weight: bold; color: #1e40af; margin-bottom: 8px;">${reportTitle}</div>
                            <div style="font-size: 14px; color: #6b7280;">(Rates as of ${reportDate} till further notice)</div>
                        </div>
                    </div>

                    <!-- Search Criteria Summary -->
                    <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 30px; border-left: 4px solid #1e40af;">
                        <h3 style="margin: 0 0 12px 0; color: #1f2937; font-size: 16px;">Search Criteria</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; font-size: 14px;">
                            <div><strong>Loan Type:</strong> ${searchCriteria.loanType}</div>
                            <div><strong>Loan Amount:</strong> ${formatCurrency(searchCriteria.loanAmount)}</div>
                            <div><strong>Loan Tenure:</strong> ${searchCriteria.loanTenure} years</div>
                            ${searchCriteria.propertyType ? `<div><strong>Property Type:</strong> ${searchCriteria.propertyType}</div>` : ''}
                            ${searchCriteria.propertyStatus ? `<div><strong>Property Status:</strong> ${searchCriteria.propertyStatus}</div>` : ''}
                            ${searchCriteria.buyUnder ? `<div><strong>Buy Under:</strong> ${searchCriteria.buyUnder}</div>` : ''}
                        </div>
                    </div>

                    <!-- Professional Packages Table -->
                    <table style="width: 100%; border-collapse: collapse; font-size: 14px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                        <!-- Header Row -->
                        <thead>
                            <tr style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: white;">
                                <th style="padding: 16px 12px; text-align: left; font-weight: bold; border: 1px solid #1e40af; width: 200px;">Bank</th>
                                ${topPackages.map((pkg, index) => `
                                    <th style="padding: 16px 12px; text-align: center; font-weight: bold; border: 1px solid #1e40af;">
                                        Package ${index + 1}
                                        ${index === 0 ? '<br><span style="font-size: 12px; background: #fbbf24; color: #92400e; padding: 2px 8px; border-radius: 12px; font-weight: normal;">BEST RATE</span>' : ''}
                                    </th>
                                `).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Bank Names Row -->
                            <tr style="background: #f8fafc;">
                                <td style="padding: 12px; font-weight: bold; border: 1px solid #e5e7eb; background: #1e40af; color: white;">Bank Name</td>
                                ${topPackages.map(pkg => `
                                    <td style="padding: 12px; text-align: center; font-weight: bold; border: 1px solid #e5e7eb; color: #1e40af; font-size: 16px;">
                                        ${pkg.bank_name}
                                    </td>
                                `).join('')}
                            </tr>
                            
                            <!-- Min. Loan Row -->
                            <tr style="background: white;">
                                <td style="padding: 12px; font-weight: bold; border: 1px solid #e5e7eb; background: #f8fafc;">Min. Loan</td>
                                ${topPackages.map(pkg => `
                                    <td style="padding: 12px; text-align: center; border: 1px solid #e5e7eb;">
                                        ${formatCurrency(pkg.minimum_loan_size || 0)}
                                    </td>
                                `).join('')}
                            </tr>

                            <!-- Reference Rate Row -->
                            <tr style="background: #f8fafc;">
                                <td style="padding: 12px; font-weight: bold; border: 1px solid #e5e7eb; background: #f8fafc;">Reference Rate</td>
                                ${topPackages.map(pkg => `
                                    <td style="padding: 12px; text-align: center; border: 1px solid #e5e7eb;">
                                        ${pkg.rate_type_category} Rate<br>
                                        <span style="font-size: 12px; color: #6b7280;">(Subject to approval)</span>
                                    </td>
                                `).join('')}
                            </tr>

                            <!-- Lock in Row -->
                            <tr style="background: white;">
                                <td style="padding: 12px; font-weight: bold; border: 1px solid #e5e7eb; background: #f8fafc;">Lock in</td>
                                ${topPackages.map(pkg => `
                                    <td style="padding: 12px; text-align: center; border: 1px solid #e5e7eb; color: #dc2626; font-weight: bold;">
                                        ${pkg.lock_period || 'No Lock-in'}
                                    </td>
                                `).join('')}
                            </tr>

                            <!-- Year 1 Row -->
                            <tr style="background: #f8fafc;">
                                <td style="padding: 12px; font-weight: bold; border: 1px solid #e5e7eb; background: #f8fafc;">Year 1</td>
                                ${topPackages.map(pkg => `
                                    <td style="padding: 12px; text-align: center; border: 1px solid #e5e7eb; font-weight: bold; color: #059669;">
                                        ${formatRateDisplay(pkg, 1)}
                                    </td>
                                `).join('')}
                            </tr>

                            <!-- Year 2 Row -->
                            <tr style="background: white;">
                                <td style="padding: 12px; font-weight: bold; border: 1px solid #e5e7eb; background: #f8fafc;">Year 2</td>
                                ${topPackages.map(pkg => `
                                    <td style="padding: 12px; text-align: center; border: 1px solid #e5e7eb; font-weight: bold; color: #059669;">
                                        ${formatRateDisplay(pkg, 2)}
                                    </td>
                                `).join('')}
                            </tr>

                            <!-- Year 3 Row -->
                            <tr style="background: #f8fafc;">
                                <td style="padding: 12px; font-weight: bold; border: 1px solid #e5e7eb; background: #f8fafc;">Year 3</td>
                                ${topPackages.map(pkg => `
                                    <td style="padding: 12px; text-align: center; border: 1px solid #e5e7eb;">
                                        ${formatRateDisplay(pkg, 3)}
                                    </td>
                                `).join('')}
                            </tr>

                            <!-- Year 4 Row -->
                            <tr style="background: white;">
                                <td style="padding: 12px; font-weight: bold; border: 1px solid #e5e7eb; background: #f8fafc;">Year 4</td>
                                ${topPackages.map(pkg => `
                                    <td style="padding: 12px; text-align: center; border: 1px solid #e5e7eb;">
                                        ${formatRateDisplay(pkg, 4)}
                                    </td>
                                `).join('')}
                            </tr>

                            <!-- Year 5 Row -->
                            <tr style="background: #f8fafc;">
                                <td style="padding: 12px; font-weight: bold; border: 1px solid #e5e7eb; background: #f8fafc;">Year 5</td>
                                ${topPackages.map(pkg => `
                                    <td style="padding: 12px; text-align: center; border: 1px solid #e5e7eb;">
                                        ${formatRateDisplay(pkg, 5)}
                                    </td>
                                `).join('')}
                            </tr>

                            <!-- Thereafter Row -->
                            <tr style="background: white;">
                                <td style="padding: 12px; font-weight: bold; border: 1px solid #e5e7eb; background: #f8fafc;">Thereafter</td>
                                ${topPackages.map(pkg => `
                                    <td style="padding: 12px; text-align: center; border: 1px solid #e5e7eb;">
                                        ${formatRateDisplay(pkg, 'thereafter')}
                                    </td>
                                `).join('')}
                            </tr>

                            <!-- Free Conversion Row -->
                            <tr style="background: #f8fafc;">
                                <td style="padding: 12px; font-weight: bold; border: 1px solid #e5e7eb; background: #f8fafc;">One Time Free Conversion</td>
                                ${topPackages.map(pkg => `
                                    <td style="padding: 12px; text-align: center; border: 1px solid #e5e7eb;">
                                        ${formatConversionOptions(pkg)}
                                    </td>
                                `).join('')}
                            </tr>

                            <!-- Average Rate Row -->
                            <tr style="background: #dcfce7; border: 2px solid #16a34a;">
                                <td style="padding: 12px; font-weight: bold; border: 1px solid #16a34a; background: #16a34a; color: white;">Avg First 2 Years</td>
                                ${topPackages.map(pkg => `
                                    <td style="padding: 12px; text-align: center; border: 1px solid #16a34a; font-weight: bold; color: #16a34a; font-size: 16px;">
                                        ${formatPercentage(pkg.avgFirst2Years)}
                                    </td>
                                `).join('')}
                            </tr>

                            <!-- Monthly Installment Row -->
                            <tr style="background: #fef3c7; border: 2px solid #d97706;">
                                <td style="padding: 12px; font-weight: bold; border: 1px solid #d97706; background: #d97706; color: white;">Monthly Installment</td>
                                ${topPackages.map(pkg => `
                                    <td style="padding: 12px; text-align: center; border: 1px solid #d97706; font-weight: bold; color: #d97706; font-size: 16px;">
                                        ${formatCurrency(pkg.monthlyInstallment)}
                                    </td>
                                `).join('')}
                            </tr>

                            <!-- Remarks Row -->
                            <tr style="background: white;">
                                <td style="padding: 16px 12px; font-weight: bold; border: 1px solid #e5e7eb; background: #f8fafc; vertical-align: top;">Remarks</td>
                                ${topPackages.map(pkg => `
                                    <td style="padding: 16px 12px; border: 1px solid #e5e7eb; vertical-align: top; font-size: 12px; line-height: 1.4;">
                                        ${formatRemarksForReport(pkg)}
                                    </td>
                                `).join('')}
                            </tr>
                        </tbody>
                    </table>

                    <!-- Footer Disclaimer -->
                    <div style="margin-top: 40px; padding: 20px; background: #fef2f2; border-left: 4px solid #dc2626; border-radius: 8px;">
                        <p style="margin: 0; font-size: 12px; color: #dc2626; font-style: italic; line-height: 1.5;">
                            ***Above proposed rates are as updated as of today and subject to availability. All interest rates are subject to bank's final approval and may vary based on individual credit assessment. Terms and conditions apply. This report is for informational purposes only and does not constitute a binding offer.
                        </p>
                    </div>

                    <!-- Report Generation Info -->
                    <div style="margin-top: 30px; text-align: center; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                        <p style="margin: 0; font-size: 12px; color: #6b7280;">
                            Report generated by Keyquest Mortgage on ${new Date().toLocaleString('en-SG')}
                        </p>
                    </div>
                </div>
            `;

            openModal('professional-report-modal');
        }

        // Helper function to format rate display for the report
        function formatRateDisplay(pkg, year) {
            let rateType, operator, value;
            
            if (year === 'thereafter') {
                rateType = pkg.thereafter_rate_type;
                operator = pkg.thereafter_operator;
                value = pkg.thereafter_value;
            } else {
                rateType = pkg[`year${year}_rate_type`];
                operator = pkg[`year${year}_operator`];
                value = pkg[`year${year}_value`];
            }

            if (!rateType || !value) return '-';

            if (rateType === 'FIXED') {
                const rate = calculateInterestRate(pkg, year);
                return `${formatPercentage(rate)} Fixed`;
            } else {
                const operatorSymbol = operator === '+' ? '+' : '-';
                return `${rateType} ${operatorSymbol} ${value} %`;
            }
        }

        // Helper function to format conversion options
        function formatConversionOptions(pkg) {
            const options = [];
            
            if (pkg.free_package_conversion_12m === 'true' || pkg.free_package_conversion_12m === true) {
                options.push('after 12 Months');
            }
            if (pkg.free_package_conversion_24m === 'true' || pkg.free_package_conversion_24m === true) {
                options.push('after 24 Months');
            }
            if (pkg.free_package_conversion_36m === 'true' || pkg.free_package_conversion_36m === true) {
                options.push('after 36 Months');
            }
            
            return options.length > 0 ? options.join('<br>') : '-';
        }

        // Helper function to format remarks for the report
        function formatRemarksForReport(pkg) {
            const remarks = [];
            
            // Add package remarks if available
            if (pkg.remarks) {
                remarks.push(pkg.remarks);
            }
            
            // Add special features
            if (pkg.legal_fee_subsidy === 'true' || pkg.legal_fee_subsidy === true) {
                remarks.push('• Legal subsidy 0.40% of Loan amount');
            }
            
            if (pkg.valuation_subsidy === 'true' || pkg.valuation_subsidy === true) {
                remarks.push('• Valuation subsidy');
            }
            
            if (pkg.waiver_due_to_sales === 'true' || pkg.waiver_due_to_sales === true) {
                remarks.push('• Waiver due to sales');
            }
            
            if (pkg.partial_repayment === 'true' || pkg.partial_repayment === true) {
                remarks.push('• Partial repayment allowed');
            }
            
            return remarks.length > 0 ? remarks.join('<br>') : '-';
        }

        // Print the professional report
        function printProfessionalReport() {
            const originalTitle = document.title;
            document.title = `Keyquest_Mortgage_Report_${new Date().toISOString().split('T')[0]}`;
            
            // Hide modal elements during print
            const modal = document.getElementById('professional-report-modal');
            const originalStyle = modal.style.cssText;
            modal.style.cssText = 'position: static !important; width: 100% !important; height: 100% !important; max-width: none !important; max-height: none !important; margin: 0 !important; padding: 0 !important; border: none !important; box-shadow: none !important; background: white !important;';
            
            // Hide everything except the report content
            document.body.style.visibility = 'hidden';
            modal.style.visibility = 'visible';
            
            // Trigger print
            window.print();
            
            // Restore original state
            document.body.style.visibility = 'visible';
            modal.style.cssText = originalStyle;
            document.title = originalTitle;
        }
        
        function exportResults() {
            if (!currentResults.length) {
                showNotification('No results to export', 'error');
                return;
            }

            const headers = [
                'Rank', 'Bank Name', 'Avg First 2 Years Rate (%)', 'Year 1 Rate (%)', 'Year 2 Rate (%)', 
                'Monthly Installment (SGD)', 'Property Type', 'Property Status', 'Buy Under', 
                'Rate Type', 'Lock Period', 'Min Loan Size (SGD)', 'Remarks'
            ];

            const csvContent = [
                headers.join(','),
                ...currentResults.map((pkg, index) => [
                    index + 1,
                    `"${pkg.bank_name}"`,
                    pkg.avgFirst2Years.toFixed(3),
                    pkg.year1Rate.toFixed(3),
                    pkg.year2Rate.toFixed(3),
                    pkg.monthlyInstallment.toFixed(2),
                    `"${pkg.property_type}"`,
                    `"${pkg.property_status}"`,
                    `"${pkg.buy_under}"`,
                    `"${pkg.rate_type_category}"`,
                    `"${pkg.lock_period || 'No Lock-in'}"`,
                    (pkg.minimum_loan_size || 0),
                    `"${(pkg.remarks || '').replace(/"/g, '""')}"`
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const filename = `mortgage_recommendations_${new Date().toISOString().split('T')[0]}.csv`;
            
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showNotification('Report exported successfully', 'success');
        }

        // ===================================
        // REFRESH AND DEBUG FUNCTIONS
        // ===================================
        
        // Force hide all loading states
        function forceHideLoading() {
            console.log('🔧 Force hiding all loading states...');
            
            // Hide using admin-scripts.js function
            if (typeof hideLoading === 'function') {
                hideLoading();
            }
            
            // Remove any loading overlays manually
            const loadingSelectors = [
                '.loading-overlay',
                '#loading-overlay', 
                '#global-loader',
                '[id*="loading"]',
                '[class*="loading"]'
            ];
            
            loadingSelectors.forEach(selector => {
                const elements = document.querySelectorAll(selector);
                elements.forEach(element => {
                    if (element && element.style) {
                        element.style.display = 'none';
                        element.remove();
                    }
                });
            });
            
            // Reset body overflow
            document.body.style.overflow = '';
            
            console.log('✅ All loading states cleared');
        }
        
        async function refreshData() {
            console.log('🔄 Manual data refresh triggered');
            
            // Force hide any stuck loading first
            forceHideLoading();
            
            // Reset global variables
            allPackages = [];
            rateTypes = [];
            currentResults = [];
            
            try {
                await loadData();
                showNotification('Data refreshed successfully!', 'success');
            } catch (error) {
                console.error('❌ Manual refresh failed:', error);
                showNotification('Failed to refresh data: ' + error.message, 'error');
            }
        }

        // Debug function to check system status
        function debugSystemStatus() {
            console.log('🔧 System Debug Status:');
            console.log('- Supabase Client:', typeof supabaseClient !== 'undefined');
            console.log('- Admin Scripts:', typeof showLoading !== 'undefined');
            console.log('- Lucide Icons:', typeof lucide !== 'undefined');
            console.log('- Rate Types Count:', rateTypes.length);
            console.log('- Packages Count:', allPackages.length);
            console.log('- Current User:', document.getElementById('userName')?.textContent);
            
            // Test Supabase connection
            if (typeof supabaseClient !== 'undefined') {
                supabaseClient.from('rate_types').select('rate_type').limit(1).then(({ data, error }) => {
                    if (error) {
                        console.error('❌ Supabase test query failed:', error);
                    } else {
                        console.log('✅ Supabase connection test passed:', data);
                    }
                });
            }
        }

        // Call debug on page load for troubleshooting
        setTimeout(debugSystemStatus, 5000);
        
        function enquirePackage(packageId) {
            window.location.href = `enquiry.html?package=${packageId}`;
        }

        // User dropdown functions - SAME AS OTHER PAGES
        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            dropdown?.classList.toggle('show');
        }

        // Modal functions - SAME AS OTHER PAGES
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Sidebar functions - SAME AS OTHER PAGES
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            
            sidebar?.classList.toggle('open');
            overlay?.classList.toggle('active');
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            
            sidebar?.classList.remove('open');
            overlay?.classList.remove('active');
        }
    </script>
</body>
</html>
